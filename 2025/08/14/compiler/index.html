<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><meta rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css"><title>RooKie_Z Compilerç¼–è¯‘å™¨è®¾è®¡æ–‡æ¡£ - RooKie_Zçš„å°çª</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="RooKie_Zçš„å°çª"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="RooKie_Zçš„å°çª"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="&amp;#x2F;* å¸¸ç”¨é¢œè‰²ç±» *&amp;#x2F; .text-cadetblue { color: CadetBlue !important; } .text-blue { color: #007bff !important; } .text-green { color: #28a745 !important; } .text-red { color: #DC143C !important; } .text-orange"><meta property="og:type" content="blog"><meta property="og:title" content="RooKie_Z Compilerç¼–è¯‘å™¨è®¾è®¡æ–‡æ¡£"><meta property="og:url" content="https://rookie-zgy1513.github.io/2025/08/14/compiler/"><meta property="og:site_name" content="RooKie_Zçš„å°çª"><meta property="og:description" content="&amp;#x2F;* å¸¸ç”¨é¢œè‰²ç±» *&amp;#x2F; .text-cadetblue { color: CadetBlue !important; } .text-blue { color: #007bff !important; } .text-green { color: #28a745 !important; } .text-red { color: #DC143C !important; } .text-orange"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://rookie-zgy1513.github.io/images/compiler.png"><meta property="article:published_time" content="2025-08-14T13:06:06.000Z"><meta property="article:modified_time" content="2025-08-14T16:51:15.261Z"><meta property="article:author" content="RooKie_Z"><meta property="article:tag" content="compiler"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://rookie-zgy1513.github.io/images/compiler.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://rookie-zgy1513.github.io/2025/08/14/compiler/"},"headline":"RooKie_Z Compilerç¼–è¯‘å™¨è®¾è®¡æ–‡æ¡£","image":["https://rookie-zgy1513.github.io/images/compiler.png"],"datePublished":"2025-08-14T13:06:06.000Z","dateModified":"2025-08-14T16:51:15.261Z","author":{"@type":"Person","name":"RooKie_Z"},"publisher":{"@type":"Organization","name":"RooKie_Zçš„å°çª","logo":{"@type":"ImageObject","url":"https://rookie-zgy1513.github.io/img/logo.png"}},"description":"&#x2F;* å¸¸ç”¨é¢œè‰²ç±» *&#x2F; .text-cadetblue { color: CadetBlue !important; } .text-blue { color: #007bff !important; } .text-green { color: #28a745 !important; } .text-red { color: #DC143C !important; } .text-orange"}</script><link rel="canonical" href="https://rookie-zgy1513.github.io/2025/08/14/compiler/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="RooKie_Zçš„å°çª" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">ä¸»é¡µ</a><a class="navbar-item" href="/archives">å½’æ¡£</a><a class="navbar-item" href="/categories">åˆ†ç±»</a><a class="navbar-item" href="/tags">æ ‡ç­¾</a><a class="navbar-item" href="/about">å…³äº</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/rookie-zgy1513"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="ç›®å½•" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="æœç´¢" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-lightbulb" id="night-icon"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/images/compiler.png" alt="RooKie_Z Compilerç¼–è¯‘å™¨è®¾è®¡æ–‡æ¡£"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2025-08-14T13:06:06.000Z" title="2025/8/14 21:06:06">2025-08-14</time>å‘è¡¨</span><span class="level-item"><time dateTime="2025-08-14T16:51:15.261Z" title="2025/8/15 00:51:15">2025-08-15</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/%E5%A4%A7%E4%B8%89%E4%B8%8A%E8%AF%BE%E4%B8%8A/">å¤§ä¸‰ä¸Šè¯¾ä¸Š</a></span><span class="level-item">2 å°æ—¶è¯»å®Œ (å¤§çº¦22263ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile">RooKie_Z Compilerç¼–è¯‘å™¨è®¾è®¡æ–‡æ¡£</h1><div class="content"><style>
/* å¸¸ç”¨é¢œè‰²ç±» */
.text-cadetblue { color: CadetBlue !important; }
.text-blue { color: #007bff !important; }
.text-green { color: #28a745 !important; }
.text-red { color: #DC143C !important; }
.text-orange { color: #fd7e14 !important; }
.text-purple { color: #6f42c1 !important; }

.text-emphasis { color: #007bff; font-weight: bold; }
.text-warning { color: #ffc107; font-weight: bold; }
.text-success { color: #28a745; font-weight: bold; }
.text-danger { color: #7835dc; font-weight: bold; }

/* è­¦å‘Šæ¡†æ ·å¼ */
blockquote {
    position: relative;
    margin: 20px 0;
    padding: 16px 20px;
    border-left: 4px solid #007bff;
    background: #f8f9fa;
    border-radius: 0 6px 6px 0;
    font-style: normal;
}

blockquote[data-callout="important"] {
    border-left-color: #7835dc;
    background: rgb(242, 241, 251);
    border-left-width: 6px;
}

blockquote[data-callout="important"]::before {
    content: "ğŸ’¬ é‡è¦";
    display: block;
    font-weight: bold;
    color: #7835dc;
    margin-bottom: 8px;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

blockquote[data-callout="caution"] {
    border-left-color: #ffc107;
    background: #fffbf0;
    border-left-width: 6px;
}

blockquote[data-callout="caution"]::before {
    content: "âš ï¸ æ³¨æ„";
    display: block;
    font-weight: bold;
    color: #b8860b;
    margin-bottom: 8px;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

blockquote[data-callout="note"] {
    border-left-color: #17a2b8;
    background: #f0f9ff;
    border-left-width: 6px;
}

blockquote[data-callout="note"]::before {
    content: "â„¹ï¸ æç¤º";
    display: block;
    font-weight: bold;
    color: #17a2b8;
    margin-bottom: 8px;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
</style>

<script>
// å¤„ç†è­¦å‘Šæ¡†
document.addEventListener('DOMContentLoaded', function() {
    const blockquotes = document.querySelectorAll('blockquote');
    blockquotes.forEach(function(blockquote) {
        const firstParagraph = blockquote.querySelector('p:first-child');
        if (firstParagraph) {
            const text = firstParagraph.textContent;
            const calloutMatch = text.match(/\[!(IMPORTANT|CAUTION|NOTE)\]/i);

            if (calloutMatch) {
                const calloutType = calloutMatch[1].toLowerCase();
                blockquote.setAttribute('data-callout', calloutType);
          
                // ç§»é™¤æ ‡è®°æ–‡æœ¬
                const cleanText = text.replace(/\[![^\]]+\]\s*/, '');
                firstParagraph.textContent = cleanText;
            }
        }
    });
});
</script>

<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p><strong>RooKie_Z Compiler</strong>ç¼–è¯‘å™¨è®¾è®¡æ–‡æ¡£ï¼Œæœ¬ç¼–è¯‘å™¨ <strong><span class="text-cadetblue">åœ¨æœ€ç»ˆçš„ç«é€Ÿä¸­æ’åç¬¬äº”</strong></p>
<span id="more"></span>

<p><em><code>Update time: 2024å¹´12æœˆ3æ—¥ æ˜ŸæœŸäºŒ 18æ—¶19åˆ†15ç§’ CST</code></em></p>
<h2 id="â€œå…è´£å£°æ˜â€"><a href="#â€œå…è´£å£°æ˜â€" class="headerlink" title="â€œå…è´£å£°æ˜â€"></a>â€œå…è´£å£°æ˜â€</h2><blockquote>
<p>æ–‡æ¡£æ’°å†™è¦æ±‚ä¸­è¦æ±‚æŒ‰ç…§<br><strong>ç¼–ç å‰çš„è®¾è®¡ã€ç¼–ç å®Œæˆä¹‹åçš„ä¿®æ”¹</strong>çš„é¡ºåºå®Œæˆå„éƒ¨åˆ†æ’°å†™</p>
</blockquote>
<p>è€Œäº‹å®ä¸Šï¼Œæˆ‘å‘æ¥åå¥½<strong>è°ƒç ”å…ˆäºå®è·µï¼Œè®¾è®¡æ—©äºç¼–ç </strong>çš„ä»£ç æ’°å†™ç†å¿µï¼Œè€Œè¿™ç¯‡è®¾è®¡æ–‡æ¡£ä¹Ÿå®Œå…¨æ˜¯æœ¬äººçš„æœ‰æ„Ÿè€Œå‘ï¼Œè®¾è®¡ç”¨æ—¶ç›¸è¾ƒç¼–ç ç”¨æ—¶æé•¿ï¼Œæ•…ä»£ç é‡æ„è¾ƒå°‘ï¼Œå› æ­¤ï¼Œè¯·å…è®¸æˆ‘ä¸é‡‡ç”¨æ¨èçš„æ ¼å¼ï¼ŒæŒ‰ç…§æˆ‘çš„ç¼–è¯‘å™¨è®¾è®¡å®Œæˆçš„æ€è·¯å®Œæˆè¿™ç¯‡è®¾è®¡æ–‡æ¡£ï¼Œä¸èƒœæ„Ÿæ¿€ï¼ï¼ï¼</p>
<h2 id="å‚è€ƒç¼–è¯‘å™¨ä»‹ç»"><a href="#å‚è€ƒç¼–è¯‘å™¨ä»‹ç»" class="headerlink" title="å‚è€ƒç¼–è¯‘å™¨ä»‹ç»"></a>å‚è€ƒç¼–è¯‘å™¨ä»‹ç»</h2><p>å‚è€ƒäº†<a target="_blank" rel="noopener" href="https://github.com/Thysrael/Pansy">å¼ºç”Ÿå­¦é•¿çš„ <code>Pansy</code>ç¼–è¯‘å™¨</a>ï¼Œè¿™æ˜¯ä¸€ä¸ª<del>ç®€å•</del>çš„ç¼–è¯‘SysYè¯­è¨€åˆ°Mipsçš„ç¼–è¯‘å™¨ã€‚è¯¥ç¼–è¯‘å™¨è®¾è®¡æä¸ºç²¾ç¾ï¼Œæ¶æ„ç›¸å½“å®Œæ•´ï¼Œå¯æ‹“å±•æ€§å¼ºï¼Œæˆ‘çš„æ¶æ„ä¸»è¦ä¹Ÿæ¨¡ä»¿äº† <code>Pansy</code>ç¼–è¯‘å™¨</p>
<blockquote>
<p>å¦å¤–ï¼Œæ®å¼ºç”Ÿå­¦é•¿ä»‹ç»ï¼Œ<code>Pansy</code>è¿˜æœ‰ç¾äººä¹‹æ„ï¼Œè¿™æ ·ä¸€çœ‹æˆ‘çš„ä»£ç ä¹Ÿå±äºæ˜¯ä¸œæ–½æ•ˆé¢¦äº†ğŸ˜‡</p>
</blockquote>
<h3 id="æ€»ä½“ç»“æ„"><a href="#æ€»ä½“ç»“æ„" class="headerlink" title="æ€»ä½“ç»“æ„"></a>æ€»ä½“ç»“æ„</h3><p><img src="/2025/08/14/compiler/image-20241202194601115.png"></p>
<h3 id="æ¥å£è®¾è®¡"><a href="#æ¥å£è®¾è®¡" class="headerlink" title="æ¥å£è®¾è®¡"></a>æ¥å£è®¾è®¡</h3><p>å…·ä½“çš„æ¥å£å±‚æœ‰å››å±‚</p>
<ul>
<li>Tokens -&gt; CSTï¼šå‘å‰è´Ÿè´£ï¼Œæœ‰ä¸€ä¸ªç»Ÿä¸€çš„ Parser ç”¨äºç”Ÿæˆ CSTã€‚</li>
<li>CST -&gt; LLVM IRï¼šå‘åè´Ÿè´£ï¼ŒCST çš„æ¯ä¸ªèŠ‚ç‚¹å®ç°äº†ç›¸åº”çš„ irBuildã€‚</li>
<li>CST -&gt; Errorsï¼šå‘åè´Ÿè´£ï¼ŒCST çš„æ¯ä¸ªèŠ‚ç‚¹å®ç°äº†ç›¸åº”çš„ checkã€‚</li>
<li>LLVM IR -&gt; MIRï¼šå‘å‰è´Ÿè´£ï¼Œæœ‰ä¸€ä¸ªç»Ÿä¸€çš„ IrParser ç”¨äºç”Ÿæˆ MIRã€‚</li>
</ul>
<h3 id="æ–‡ä»¶ç»„ç»‡"><a href="#æ–‡ä»¶ç»„ç»‡" class="headerlink" title="æ–‡ä»¶ç»„ç»‡"></a>æ–‡ä»¶ç»„ç»‡</h3><p><img src="/2025/08/14/compiler/pansy_doc.jpg"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ Compiler.java</span><br><span class="line">â”œâ”€â”€ back</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Backend.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ README.md</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ component</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjBlock.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjFunction.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjGlobalVariable.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ ObjModule.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ instruction</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjBinary.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjBranch.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjCall.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjCoMove.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjComment.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjCompare.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjCondType.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjInstr.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjLoad.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjMove.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjRet.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjShift.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ ObjStore.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ operand</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjImm.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjLabel.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjOperand.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjPhyReg.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ObjReg.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ ObjVirReg.java</span><br><span class="line">â”‚Â Â  â””â”€â”€ process</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ BlockLiveInfo.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ IrParser.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ Peephole.java</span><br><span class="line">â”‚Â Â      â””â”€â”€ RegAllocator.java</span><br><span class="line">â”œâ”€â”€ check</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ CheckDataType.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Checker.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ErrorType.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ FuncInfo.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ PansyException.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ README.md</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ SymbolInfo.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ SymbolTable.java</span><br><span class="line">â”‚Â Â  â””â”€â”€ VarInfo.java</span><br><span class="line">â”œâ”€â”€ driver</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Config.java</span><br><span class="line">â”‚Â Â  â””â”€â”€ Driver.java</span><br><span class="line">â”œâ”€â”€ ir</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ IrBuilder.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ IrSymbolTable.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ README.md</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ types</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ArrayType.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DataType.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ FunctionType.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ IntType.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LabelType.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ PointerType.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ValueType.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ VoidType.java</span><br><span class="line">â”‚Â Â  â””â”€â”€ values</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ Argument.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ BasicBlock.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ Function.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ GlobalVariable.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ Module.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ User.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ Value.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ constants</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ConstArray.java</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ConstInt.java</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ConstStr.java</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Constant.java</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ ZeroInitializer.java</span><br><span class="line">â”‚Â Â      â””â”€â”€ instructions</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Add.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Alloca.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ BinInstruction.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Br.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Call.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ GetElementPtr.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Icmp.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Instruction.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Load.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ MemInstruction.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Mul.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Phi.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Ret.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Sdiv.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Srem.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Store.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ Sub.java</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ TerInstruction.java</span><br><span class="line">â”‚Â Â          â””â”€â”€ Zext.java</span><br><span class="line">â”œâ”€â”€ lexer</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Lexer.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ README.md</span><br><span class="line">â”‚Â Â  â””â”€â”€ token</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ Comment.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ Delimiter.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ EOFToken.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ FormString.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ Identifier.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ IntConst.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ Reserved.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ SyntaxType.java</span><br><span class="line">â”‚Â Â      â””â”€â”€ Token.java</span><br><span class="line">â”œâ”€â”€ parser</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ParseSupporter.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Parser.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ README.md</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ SysY.g4</span><br><span class="line">â”‚Â Â  â””â”€â”€ cst</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ AddExpNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ AssignStmtNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ BTypeNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ BlockItemNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ BlockNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ BreakStmtNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ CSTNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ CalleeNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ CondNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ ConditionStmtNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ ConstDeclNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ ConstDefNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ ConstExpNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ ConstInitValNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ ContinueStmtNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ DeclNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ EqExpNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ ExpNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ ExpStmtNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ FuncDefNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ FuncFParamNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ FuncFParamsNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ FuncRParamsNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ FuncTypeNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ InStmtNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ InitValNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ LAndExpNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ LOrExpNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ LValNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ MainFuncDefNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ MulExpNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ NumberNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ OutStmtNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ PrimaryExpNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ RelExpNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ ReturnStmtNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ RootNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ StmtNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ TokenNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ UnaryExpNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ UnaryOpNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ VarDeclNode.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ VarDefNode.java</span><br><span class="line">â”‚Â Â      â””â”€â”€ WhileStmtNode.java</span><br><span class="line">â”œâ”€â”€ pass</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Pass.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ PassManager.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ README.md</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ analyze</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BuildCFG.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DomInfo.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Loop.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LoopInfo.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LoopInfoAnalysis.java</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ SideEffectAnalysis.java</span><br><span class="line">â”‚Â Â  â””â”€â”€ refactor</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ BranchOpt.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ DeadCodeEmit.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ FunctionClone.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ GCM.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ GVN.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ GlobalVariableLocalize.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ InlineFunction.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ InstructionSimplify.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ Mem2reg.java</span><br><span class="line">â”‚Â Â      â””â”€â”€ UselessRetEmit.java</span><br><span class="line">â””â”€â”€ util</span><br><span class="line">    â”œâ”€â”€ MyCompare.java</span><br><span class="line">    â”œâ”€â”€ MyIO.java</span><br><span class="line">    â”œâ”€â”€ MyList.java</span><br><span class="line">    â”œâ”€â”€ MyMath.java</span><br><span class="line">    â”œâ”€â”€ MyPair.java</span><br><span class="line">    â””â”€â”€ MyPrintf.java</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ç¼–è¯‘å™¨æ€»ä½“è®¾è®¡"><a href="#ç¼–è¯‘å™¨æ€»ä½“è®¾è®¡" class="headerlink" title="ç¼–è¯‘å™¨æ€»ä½“è®¾è®¡"></a>ç¼–è¯‘å™¨æ€»ä½“è®¾è®¡</h2><h3 id="æ€»ä½“ç»“æ„-1"><a href="#æ€»ä½“ç»“æ„-1" class="headerlink" title="æ€»ä½“ç»“æ„"></a>æ€»ä½“ç»“æ„</h3><p>é€šè¿‡ç†è®ºè¯¾çš„å­¦ä¹ å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬é€šå¸¸å°†ç¼–è¯‘è¿‡ç¨‹åˆ†ä¸ºå¦‚ä¸‹é˜¶æ®µï¼š</p>
<p>è¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æï¼Œ<code>llvm</code>ç”Ÿæˆï¼Œ<code>llvm</code>ä¼˜åŒ–ï¼Œ<code>mips</code>ç”ŸæˆåŠä¼˜åŒ–ï¼Œå…¶ä¸­é”™è¯¯å¤„ç†è´¯ç©¿æ•´ä¸ªå‰ç«¯è¿‡ç¨‹ã€‚</p>
<ul>
<li><p>å‰ç«¯</p>
<ul>
<li><strong>è¯æ³•åˆ†æ</strong>ï¼šæ„å»ºäº†è´ªå¿ƒç®€åŒ–çš„ <code>DFA</code>ï¼Œè¾“å…¥æºç¨‹åºï¼Œè¾“å‡º <code>token</code>åºåˆ—ã€‚</li>
<li><strong>è¯­æ³•åˆ†æ</strong>ï¼šé€šè¿‡é€’å½’ä¸‹é™å­ç¨‹åºï¼Œè¿›è¡Œæœ€å·¦æ¨å¯¼ã€‚å…¶ä¸­é‡‡ç”¨äº† <code>æ‰©å……çš„BNFèŒƒå¼</code>è§£å†³å·¦é€’å½’é—®é¢˜ï¼Œå¹¶é€šè¿‡ <code>é¢„è¯»FIRSTé›†</code>çš„æ–¹å¼æ¥å°½å¯èƒ½é¿å…å›æº¯å¹¶å®Œæˆé”™è¯¯å¤„ç†ã€‚</li>
<li><strong>è¯­ä¹‰åˆ†æ</strong>ï¼šé€šè¿‡éå†è¯­æ³•åˆ†æå¾—åˆ°çš„è¯­æ³•æ ‘ï¼Œæ„å»ºç¬¦å·è¡¨ã€‚</li>
<li><strong>é”™è¯¯å¤„ç†</strong>ï¼šåœ¨è¯æ³•åˆ†æã€è¯­æ³•åˆ†æä¸­è¿›è¡Œè¯­æ³•é”™è¯¯å¤„ç†ï¼Œåœ¨è¯­ä¹‰åˆ†æä¸­è¿›è¡Œè¯­ä¹‰é”™è¯¯å¤„ç†ã€‚</li>
</ul>
</li>
<li><p>ä¸­ç«¯(<code>llvm</code>ä¼˜åŒ–)</p>
<p>ä¸­ç«¯å®ç°äº† <code>Mem2reg</code>ï¼Œé‡æ„å¹¶ç”Ÿæˆäº†å¸¦æœ‰ <code>phi</code>å‡½æ•°çš„ä¸­é—´ä»£ç ã€‚</p>
<ul>
<li>æ„å»ºæ§åˆ¶æµå›¾(CFG)ï¼Œæ±‚è§£æ”¯é…è€…ä¸æ”¯é…è¾¹ç•Œã€‚</li>
<li>é‡æ„SSAï¼Œ<code>phi</code>æŒ‡ä»¤çš„æ’å…¥ä¸å˜é‡é‡å‘½åã€‚</li>
<li>å‰¯ä½œç”¨åˆ†æ</li>
<li><code>GVL</code></li>
<li><code>DCE</code>ï¼ˆæ­»ä»£ç åˆ é™¤ï¼‰</li>
</ul>
</li>
<li><p>åç«¯(<code>mips</code>ä»£ç ç”ŸæˆåŠä¼˜åŒ–)</p>
<ul>
<li>é <code>phi</code>æŒ‡ä»¤ä¸­é—´ä»£ç çš„ç¿»è¯‘ï¼Œ<code>phi</code>æŒ‡ä»¤çš„ç¿»è¯‘ã€‚è‡³æ­¤ä¸ºæ­¢åˆ†é…çš„éƒ½æ˜¯è™šæ‹Ÿå¯„å­˜å™¨ã€‚</li>
<li>å›¾ç€è‰²å¯„å­˜å™¨åˆ†é…ã€‚</li>
<li>å°‘é‡çª¥å­”ä¼˜åŒ–ã€‚</li>
</ul>
</li>
</ul>
<h3 id="æ¥å£è®¾è®¡-1"><a href="#æ¥å£è®¾è®¡-1" class="headerlink" title="æ¥å£è®¾è®¡"></a>æ¥å£è®¾è®¡</h3><p>ç±»ä¼¼äº <code>Pansy</code>ï¼š</p>
<p>å…·ä½“çš„æ¥å£å±‚æœ‰å››å±‚</p>
<ul>
<li><code>Tokens -&gt; AST</code>ï¼šå‘å‰è´Ÿè´£ï¼Œæœ‰ä¸€ä¸ªç»Ÿä¸€çš„ Parser ç”¨äºç”Ÿæˆ ASTã€‚</li>
<li><code>AST -&gt; Symbol</code>ï¼šå‘åè´Ÿè´£ï¼ŒAST çš„æ¯ä¸ªèŠ‚ç‚¹å®ç°äº†ç›¸åº”çš„ <code>visit</code>æ–¹æ³•ã€‚</li>
<li><code>AST -&gt; Errors</code>ï¼šå‘åè´Ÿè´£ï¼ŒAST çš„æ¯ä¸ªèŠ‚ç‚¹å®ç°äº†ç›¸åº”çš„ <code>visit</code>æ–¹æ³•åœ¨å…¶ä¸­å®Œæˆé”™è¯¯å¤„ç†ã€‚</li>
<li><code>AST -&gt; LLVM IR</code>ï¼šå‘åè´Ÿè´£ï¼ŒAST çš„æ¯ä¸ªèŠ‚ç‚¹å®ç°äº†ç›¸åº”çš„ <code>BuildIr</code>æ–¹æ³•ã€‚</li>
<li><code>LLVM IR -&gt; MIPS</code>ï¼šå‘å‰è´Ÿè´£ï¼Œæœ‰ä¸€ä¸ªç»Ÿä¸€çš„ <code>MipsBuilder</code>ç”¨äºç”Ÿæˆ MIPSã€‚</li>
</ul>
<h3 id="æ–‡ä»¶ç»„ç»‡-1"><a href="#æ–‡ä»¶ç»„ç»‡-1" class="headerlink" title="æ–‡ä»¶ç»„ç»‡"></a>æ–‡ä»¶ç»„ç»‡</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ Compiler.java</span><br><span class="line">â”œâ”€â”€ backend</span><br><span class="line">â”‚   â”œâ”€â”€ MipsBuilder.java</span><br><span class="line">â”‚   â”œâ”€â”€ MipsFactory.java</span><br><span class="line">â”‚   â”œâ”€â”€ components</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsBlock.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsFunction.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsGlobalVariable.java</span><br><span class="line">â”‚   â”‚   â””â”€â”€ MipsModule.java</span><br><span class="line">â”‚   â”œâ”€â”€ instructions</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsBinary.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsBranch.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsCall.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsComment.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsCompare.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsCondType.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsInstruction.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsLoad.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsMacro.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsMove.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsMoveHI.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsRet.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsShift.java</span><br><span class="line">â”‚   â”‚   â””â”€â”€ MipsStore.java</span><br><span class="line">â”‚   â”œâ”€â”€ operands</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsImm.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsLabel.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsOperand.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsRealReg.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ MipsVirtualReg.java</span><br><span class="line">â”‚   â”‚   â””â”€â”€ RegType.java</span><br><span class="line">â”‚   â”œâ”€â”€ reg</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ BlockLiveVarInfo.java</span><br><span class="line">â”‚   â”‚   â””â”€â”€ RegAllocator.java</span><br><span class="line">â”‚   â””â”€â”€ utils</span><br><span class="line">â”‚       â”œâ”€â”€ MipsMathOpt.java</span><br><span class="line">â”‚       â”œâ”€â”€ MipsUtil.java</span><br><span class="line">â”‚       â”œâ”€â”€ Pair.java</span><br><span class="line">â”‚       â””â”€â”€ Triple.java</span><br><span class="line">â”œâ”€â”€ compiler.zip</span><br><span class="line">â”œâ”€â”€ config.json</span><br><span class="line">â”œâ”€â”€ error</span><br><span class="line">â”‚   â”œâ”€â”€ Error.java</span><br><span class="line">â”‚   â”œâ”€â”€ ErrorHandler.java</span><br><span class="line">â”‚   â”œâ”€â”€ ErrorType.java</span><br><span class="line">â”‚   â””â”€â”€ ErrorUtil.java</span><br><span class="line">â”œâ”€â”€ exception</span><br><span class="line">â”‚   â””â”€â”€ LexerException.java</span><br><span class="line">â”œâ”€â”€ frontend</span><br><span class="line">â”‚   â”œâ”€â”€ Lexer.java</span><br><span class="line">â”‚   â”œâ”€â”€ Parser.java</span><br><span class="line">â”‚   â””â”€â”€ Visitor.java</span><br><span class="line">â”œâ”€â”€ ir</span><br><span class="line">â”‚   â”œâ”€â”€ IrBuilder.java</span><br><span class="line">â”‚   â”œâ”€â”€ IrFactory.java</span><br><span class="line">â”‚   â”œâ”€â”€ IrSymbolTable.java</span><br><span class="line">â”‚   â”œâ”€â”€ IrSymbolTableStack.java</span><br><span class="line">â”‚   â”œâ”€â”€ IrUtil.java</span><br><span class="line">â”‚   â”œâ”€â”€ types</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ ArrayType.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ CharType.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ FuncType.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ IntType.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ LabelType.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ PointerType.java</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ ValueType.java</span><br><span class="line">â”‚   â”‚   â””â”€â”€ VoidType.java</span><br><span class="line">â”‚   â””â”€â”€ values</span><br><span class="line">â”‚       â”œâ”€â”€ BasicBlock.java</span><br><span class="line">â”‚       â”œâ”€â”€ Function.java</span><br><span class="line">â”‚       â”œâ”€â”€ GlobalVariable.java</span><br><span class="line">â”‚       â”œâ”€â”€ Module.java</span><br><span class="line">â”‚       â”œâ”€â”€ User.java</span><br><span class="line">â”‚       â”œâ”€â”€ Value.java</span><br><span class="line">â”‚       â”œâ”€â”€ constants</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ ConstArray.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ ConstChar.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ ConstInt.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ ConstString.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Constant.java</span><br><span class="line">â”‚       â”‚   â””â”€â”€ ZeroInitializer.java</span><br><span class="line">â”‚       â”œâ”€â”€ instructions</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Add.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Alloca.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ ArithmeticInstruction.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Br.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Call.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ GetElementPtr.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Icmp.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Instruction.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Load.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Mul.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Phi.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Ret.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Sdiv.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Srem.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Store.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Sub.java</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€ Trunc.java</span><br><span class="line">â”‚       â”‚   â””â”€â”€ Zext.java</span><br><span class="line">â”‚       â””â”€â”€ pass</span><br><span class="line">â”‚           â”œâ”€â”€ AggressiveDeadCodeEmit.java</span><br><span class="line">â”‚           â”œâ”€â”€ BuildCFG.java</span><br><span class="line">â”‚           â”œâ”€â”€ DeadCodeEmit.java</span><br><span class="line">â”‚           â”œâ”€â”€ DomInfo.java</span><br><span class="line">â”‚           â”œâ”€â”€ GVL.java</span><br><span class="line">â”‚           â”œâ”€â”€ Loop.java</span><br><span class="line">â”‚           â”œâ”€â”€ LoopInfo.java</span><br><span class="line">â”‚           â”œâ”€â”€ Mem2Reg.java</span><br><span class="line">â”‚           â”œâ”€â”€ SideEffectAnalysis.java</span><br><span class="line">â”‚           â””â”€â”€ UselessRetEmit.java</span><br><span class="line">â”œâ”€â”€ node</span><br><span class="line">â”‚   â”œâ”€â”€ AddExpNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ BTypeNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ BlockItemNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ BlockNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ CharacterNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ CompUnitNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ CondNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ ConstDeclNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ ConstDefNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ ConstExpNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ ConstInitValNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ DeclNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ EqExpNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ ExpNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ ForStmtNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ FuncDefNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ FuncFParamNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ FuncFParamsNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ FuncRParamsNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ FuncTypeNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ InitValNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ LAndExpNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ LOrExpNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ LValNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ MainFuncDefNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ MulExpNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ Node.java</span><br><span class="line">â”‚   â”œâ”€â”€ NodeType.java</span><br><span class="line">â”‚   â”œâ”€â”€ NumberNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ PrimaryExpNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ RelExpNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ StmtNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ StmtType.java</span><br><span class="line">â”‚   â”œâ”€â”€ UnaryExpNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ UnaryOpNode.java</span><br><span class="line">â”‚   â”œâ”€â”€ VarDeclNode.java</span><br><span class="line">â”‚   â””â”€â”€ VarDefNode.java</span><br><span class="line">â”œâ”€â”€ opt</span><br><span class="line">â”‚   â””â”€â”€ Peephole.java</span><br><span class="line">â”œâ”€â”€ symbol</span><br><span class="line">â”‚   â”œâ”€â”€ CharSymbol.java</span><br><span class="line">â”‚   â”œâ”€â”€ FuncSymbol.java</span><br><span class="line">â”‚   â”œâ”€â”€ NumSymbol.java</span><br><span class="line">â”‚   â”œâ”€â”€ Symbol.java</span><br><span class="line">â”‚   â”œâ”€â”€ SymbolTable.java</span><br><span class="line">â”‚   â”œâ”€â”€ SymbolTableStack.java</span><br><span class="line">â”‚   â””â”€â”€ SymbolType.java</span><br><span class="line">â”œâ”€â”€ test</span><br><span class="line">â”‚   â””â”€â”€ testReg.java</span><br><span class="line">â”œâ”€â”€ token</span><br><span class="line">â”‚   â”œâ”€â”€ Token.java</span><br><span class="line">â”‚   â””â”€â”€ TokenType.java</span><br><span class="line">â”œâ”€â”€ utils</span><br><span class="line">â”‚   â”œâ”€â”€ Config.java</span><br><span class="line">â”‚   â”œâ”€â”€ IO.java</span><br><span class="line">â”‚   â””â”€â”€ Phases.java</span><br><span class="line">â””â”€â”€ è®¾è®¡æ–‡æ¡£.md</span><br></pre></td></tr></table></figure>

<h2 id="è¯æ³•åˆ†æ"><a href="#è¯æ³•åˆ†æ" class="headerlink" title="è¯æ³•åˆ†æ"></a>è¯æ³•åˆ†æ</h2><h3 id="å¤§ä½“æ€è·¯"><a href="#å¤§ä½“æ€è·¯" class="headerlink" title="å¤§ä½“æ€è·¯"></a>å¤§ä½“æ€è·¯</h3><p>è¯æ³•åˆ†æéƒ¨åˆ†çš„ä¸»è¦ä»»åŠ¡æ˜¯é¡ºåºéå†æºç¨‹åºä»£ç ï¼Œå°†å…¶æŒ‰ç…§æ–‡æ³•è½¬åŒ–ä¸ºtokenåºåˆ—ã€‚</p>
<p>è¯æ³•åˆ†æå¯ä»¥é€šè¿‡<strong>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…</strong>æˆ–è€…<strong>è´ªå¿ƒç®€åŒ–è¿‡çš„DFA</strong>å®ç°ï¼Œæˆ‘å®Œæˆäº†æ­£åˆ™è¡¨è¾¾å¼çš„æ’°å†™ï¼Œä½†ç”±äºæˆ‘æ˜¯<strong>æ­£åˆ™è‹¦æ‰‹</strong>&#x1FAE0;ï¼Œæœ€ç»ˆæˆ‘é€‰æ‹©äº†åè€…ã€‚</p>
<h3 id="DFAçš„è®¾è®¡"><a href="#DFAçš„è®¾è®¡" class="headerlink" title="DFAçš„è®¾è®¡"></a>DFAçš„è®¾è®¡</h3><p><code>DFA</code>é€šè¿‡ <code>fronted/Lexer.java</code>å®ç°ï¼Œæˆ‘ä»¬çš„å•è¯å¤§è‡´åˆ†ä¸ºå››ç±»ï¼Œåˆ†åˆ«æ˜¯ä¿ç•™å­—ã€ å­—ç¬¦ä¸²å¸¸é‡ã€æ ‡è¯†ç¬¦ã€åˆ†ç•Œç¬¦ã€‚<strong>é€šè¿‡è´ªå¿ƒåŒ¹é…ä¸åŒç±»åˆ«çš„FIRSTé›†åˆï¼Œå³å¯æ ¹æ®å½“å‰å­—ç¬¦ï¼Œç¡®å®šä¸‹é¢å°†è¦å¤„ç†çš„å•è¯çš„å¤§è‡´ç§ç±»</strong>ã€‚</p>
<p><img src="/2025/08/14/compiler/image-20231220103042494.png"></p>
<p>è°ƒç”¨ <code>next()</code>æ–¹æ³•å³å¯è¯»å–ä¸‹ä¸€ä¸ªtokenï¼Œå¤§è‡´æ¡†æ¶å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Token <span class="title function_">next</span><span class="params">()</span> <span class="keyword">throws</span> LexerException &#123;</span><br><span class="line">        currentToken = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            skipWhite();</span><br><span class="line">        &#125; <span class="keyword">while</span> (skipComment());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pos &gt; maxLength) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> <span class="variable">nowChar</span> <span class="operator">=</span> inputText.charAt(pos);</span><br><span class="line">        <span class="keyword">if</span> (Character.isDigit(nowChar)) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">endPos</span> <span class="operator">=</span> pos + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (endPos &lt;= maxLength &amp;&amp; Character.isDigit(inputText.charAt(endPos))) &#123;</span><br><span class="line">                endPos++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> inputText.substring(pos, endPos);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ›´æ–°pos</span></span><br><span class="line">            pos = endPos;</span><br><span class="line"></span><br><span class="line">            currentToken = <span class="keyword">new</span> <span class="title class_">Token</span>(str, lineNum, TokenType.INTCON);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isIdentifierNondigit(nowChar)) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">endPos</span> <span class="operator">=</span> pos + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (endPos &lt;= maxLength &amp;&amp; isIdentifierDigit(inputText.charAt(endPos))) &#123;</span><br><span class="line">                endPos++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> inputText.substring(pos, endPos);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ›´æ–°pos</span></span><br><span class="line">            pos = endPos;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºä¿ç•™å­—</span></span><br><span class="line">            <span class="type">TokenType</span> <span class="variable">type</span> <span class="operator">=</span> TokenType.isReserved(str);</span><br><span class="line"></span><br><span class="line">            currentToken = <span class="keyword">new</span> <span class="title class_">Token</span>(str, lineNum, Objects.requireNonNullElse(type, TokenType.IDENFR));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nowChar == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">endPos</span> <span class="operator">=</span> pos + <span class="number">1</span>;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">backslashFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">while</span> (endPos &lt;= maxLength &amp;&amp; (inputText.charAt(endPos) != <span class="string">&#x27;\&#x27;&#x27;</span> || (inputText.charAt(endPos) == <span class="string">&#x27;\&#x27;&#x27;</span> &amp;&amp; backslashFlag))) &#123;</span><br><span class="line">                backslashFlag = inputText.charAt(endPos) == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !backslashFlag;</span><br><span class="line">                endPos++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  æ£€æŸ¥&#x27;æ˜¯å¦åŒ¹é…</span></span><br><span class="line">            <span class="keyword">if</span> (endPos &gt; maxLength) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LexerException</span>(lineNum);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            endPos++;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> inputText.substring(pos, endPos);</span><br><span class="line"></span><br><span class="line">            pos = endPos;</span><br><span class="line"></span><br><span class="line">            currentToken = <span class="keyword">new</span> <span class="title class_">Token</span>(str, lineNum, TokenType.CHRCON);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nowChar == <span class="string">&#x27;\&quot;&#x27;</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">endPos</span> <span class="operator">=</span> pos + <span class="number">1</span>;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">backslashFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">while</span> (endPos &lt;= maxLength &amp;&amp; (inputText.charAt(endPos) != <span class="string">&#x27;\&quot;&#x27;</span> || inputText.charAt(endPos) == <span class="string">&#x27;\&quot;&#x27;</span> &amp;&amp; backslashFlag)) &#123;</span><br><span class="line">                backslashFlag = inputText.charAt(endPos) == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !backslashFlag;</span><br><span class="line">                endPos++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  æ£€æŸ¥&quot;æ˜¯å¦åŒ¹é…</span></span><br><span class="line">            <span class="keyword">if</span> (endPos &gt; maxLength) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LexerException</span>(lineNum);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            endPos++;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> inputText.substring(pos, endPos);</span><br><span class="line"></span><br><span class="line">            pos = endPos;</span><br><span class="line"></span><br><span class="line">            currentToken = <span class="keyword">new</span> <span class="title class_">Token</span>(str, lineNum, TokenType.STRCON);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">TokenType</span> <span class="variable">tokenType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">tokenLength</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (TokenType.singleCharList.contains(nowChar)) &#123;</span><br><span class="line">                tokenType = TokenType.getTokenType((str = inputText.substring(pos, pos + <span class="number">1</span>)));</span><br><span class="line">                tokenLength = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pos &lt; maxLength &amp;&amp; TokenType.doubleCharList.contains(nowChar)) &#123;</span><br><span class="line">                <span class="type">TokenType</span> <span class="variable">t</span> <span class="operator">=</span> TokenType.getTokenType(inputText.substring(pos, pos + <span class="number">2</span>));</span><br><span class="line">                <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">                    tokenType = t;</span><br><span class="line">                    tokenLength = <span class="number">2</span>;</span><br><span class="line">                    str = inputText.substring(pos, pos + <span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isErrorA(inputText.charAt(pos))) &#123;</span><br><span class="line">                    System.out.println(inputText.charAt(pos) + <span class="string">&quot; &quot;</span> + <span class="string">&quot;æˆ‘åšäº†é”™é¥­&quot;</span>);</span><br><span class="line">                    ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(ErrorType.a, lineNum));</span><br><span class="line">                    tokenType = (inputText.charAt(pos) == <span class="string">&#x27;&amp;&#x27;</span>) ? TokenType.AND : TokenType.OR;</span><br><span class="line">                    str = (inputText.charAt(pos) == <span class="string">&#x27;&amp;&#x27;</span>) ? <span class="string">&quot;&amp;&amp;&quot;</span> : <span class="string">&quot;||&quot;</span>;</span><br><span class="line">                    tokenLength = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (tokenType != <span class="literal">null</span>) &#123;</span><br><span class="line">                currentToken = <span class="keyword">new</span> <span class="title class_">Token</span>(str, lineNum, tokenType);</span><br><span class="line">                pos += tokenLength;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentToken != <span class="literal">null</span>) &#123;</span><br><span class="line">            tokenResult.add(currentToken);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> currentToken;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Tokenç±»"><a href="#Tokenç±»" class="headerlink" title="Tokenç±»"></a>Tokenç±»</h3><p>ä¸ºäº†è¿›è¡Œå¯èƒ½çš„è¯­æ³•æ‹“å±•ï¼Œæˆ‘å¯¹äºå„ç§ <code>token</code>è¿›è¡Œäº†æŠ½è±¡ï¼Œå»ºç«‹Tokenç±»ï¼Œè¯¥ç±»è®°å½•äº† <code>Tokençš„åŸå­—ç¬¦ä¸²ï¼Œtokençš„ç±»å‹ï¼Œä»¥åŠå…¶æ‰€åœ¨è¡Œå·ï¼ˆä¾›é”™è¯¯å¤„ç†ä½¿ç”¨ï¼‰</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Token</span><span class="params">(String content, <span class="type">int</span> lineNum, TokenType type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">        <span class="built_in">this</span>.lineNum = lineNum;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="æœ‰å…³æ–‡æ³•è®¾å®šéƒ¨åˆ†"><a href="#æœ‰å…³æ–‡æ³•è®¾å®šéƒ¨åˆ†" class="headerlink" title="æœ‰å…³æ–‡æ³•è®¾å®šéƒ¨åˆ†"></a>æœ‰å…³æ–‡æ³•è®¾å®šéƒ¨åˆ†</h4><p>ä½äº <code>token/TokenType.java</code></p>
<p>å¯¹äºæ‰€æœ‰ <code>Token</code>æ ‡è¯†ç¬¦ï¼Œæˆ‘éƒ½åŠ ä»¥æšä¸¾ï¼Œå®šä¹‰åœ¨æšä¸¾ç±» <code>TokenType</code>é‡Œã€‚</p>
<p>æ­¤å¤–ï¼Œä¸ºäº†ä¾¿äºçŠ¶æ€æœºè¯»å–å½“å‰å­—ç¬¦åçš„è¿›ä¸€æ­¥çŠ¶æ€è½¬ç§»ï¼Œå¯¹äºæ–‡æ³•ä¸­è§„å®šçš„ <code>ä¿ç•™å­—</code>ã€ä»¥åŠ <code>å•/åŒåˆ†ç•Œç¬¦</code>$ &#x3D;&#x3D;, \ne, \le, \ge, \gt, \lt, !, &amp;, |$ï¼Œè¿›è¡Œ<strong>å»ºè¡¨ä¸åˆ’åˆ†</strong>ã€‚</p>
<p>ä»¥ä¸Šä¸¤ç§ä¿¡æ¯å‡ä¸ºâ€œæ–‡æ³•ç»™å‡ºçš„è®¾å®šâ€ï¼Œå› æ­¤åœ¨è®¾è®¡ä¸Šç†åº”æ”¾å…¥ä¸€ä¸ªç±»ä¸­ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬çš„ <code>Lexer</code>ç±»å¹¶ä¸ä¼šæŠŠæ–‡æ³•å†™æ­»åœ¨ä»£ç é‡Œï¼Œä¾¿äºåç»­æœŸä¸­æœŸæœ«è€ƒè¯•ä¿®æ”¹æ–‡æ³•æ—¶ï¼Œå¿«é€Ÿå®Œæˆ<strong>è¯æ³•åˆ†æéƒ¨åˆ†çš„ä¿®æ”¹</strong>ã€‚</p>
<h2 id="è¯­æ³•åˆ†æ"><a href="#è¯­æ³•åˆ†æ" class="headerlink" title="è¯­æ³•åˆ†æ"></a>è¯­æ³•åˆ†æ</h2><h3 id="å¤§ä½“æ€è·¯-1"><a href="#å¤§ä½“æ€è·¯-1" class="headerlink" title="å¤§ä½“æ€è·¯"></a>å¤§ä½“æ€è·¯</h3><p>è¯­æ³•åˆ†æçš„ä»»åŠ¡æ˜¯æ˜¯è¯»å…¥ <code>tokenåºåˆ—</code>ï¼Œå¹¶åˆ†æç¡®å®šå…¶è¯­æ³•ç»“æ„ï¼Œæœ€ç»ˆç”Ÿæˆè¯­æ³•æ ‘çš„è¿‡ç¨‹ã€‚</p>
<blockquote>
<p>[!NOTE]<br><strong>é€šè¿‡ç†è®ºè¯¾æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€’å½’ä¸‹é™åˆ†ææ³•æ¥å®ç°è¯­æ³•åˆ†æï¼Œè€Œç”±äºé€’å½’ä¸‹é™å­ç¨‹åºæœ¬è´¨ä¸Šæ˜¯åœ¨è¿›è¡Œæœ€å·¦æ¨å¯¼ï¼Œå› æ­¤å¯èƒ½ä¼šé‡åˆ°å·¦é€’å½’å’Œå›æº¯çš„é—®é¢˜ã€‚</strong></p>
</blockquote>
<p><strong>å…·ä½“æ¥è¯´:</strong> æˆ‘ä¸ºæ¯ä¸ªéç»ˆç»“ç¬¦ç¼–å†™ä¸€ä¸ªé€’å½’å­ç¨‹åºï¼Œä»¥å®Œæˆè¯¥éç»ˆç»“ç¬¦æ‰€å¯¹åº”çš„è¯­æ³•æˆåˆ†çš„åˆ†æä¸è¯†åˆ«ä»»åŠ¡ï¼Œè‹¥æ­£ç¡®è¯†åˆ«ï¼Œåˆ™å¯ä»¥é€€å‡ºè¯¥éç»ˆç»“ç¬¦å·çš„å­ç¨‹åºï¼Œè¿”å›åˆ°ä¸Šä¸€çº§çš„å­ç¨‹åºç»§ç»­åˆ†æï¼›è‹¥å‘ç”Ÿé”™è¯¯ï¼Œå³æºç¨‹åºä¸ç¬¦åˆæ–‡æ³•ï¼Œåˆ™è¦è¿›è¡Œç›¸åº”çš„é”™è¯¯ä¿¡æ¯æŠ¥å‘Šä»¥åŠé”™è¯¯å¤„ç†ã€‚</p>
<h4 id="nextSym-çš„å®ç°"><a href="#nextSym-çš„å®ç°" class="headerlink" title="nextSym()çš„å®ç°"></a><code>nextSym()çš„å®ç°</code></h4><blockquote>
<p>[!NOTE]</p>
<p>é€šè¿‡ç†è®ºè¯¾çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œæ³•åˆ†æçš„æ¨è¿›ï¼Œæœ¬è´¨ä¸Šæ˜¯ç»ˆç»“ç¬¦è¯†åˆ«è¿›åº¦çš„æ¨è¿›ï¼Œå› æ­¤ <strong><code>nextSym</code>çš„è°ƒç”¨æ—¶æœºåº”å½“æ˜¯æˆåŠŸè¯†åˆ«ä¸€ä¸ªç»ˆç»“ç¬¦å</strong>ã€‚</p>
<p>äº‹å®ä¸Šï¼Œåœ¨ç†è®ºè¯¾æä¾›çš„ <code>Pascal</code>è¯­è¨€ç¼–è¯‘å™¨çš„è¯­æ³•åˆ†æéƒ¨åˆ†ï¼Œå¯¹äº <code>nextSym</code>çš„è®¾è®¡å¤ªè¿‡ç®€å•ï¼Œå¯¼è‡´ç¤ºä¾‹ç¨‹åº<strong>ä½å†…èšï¼Œé«˜è€¦åˆ</strong>ï¼Œè€ƒè™‘åˆ°åœ¨è¯­æ³•åˆ†æéƒ¨åˆ†å°±æœ‰è¿›è¡Œé”™è¯¯å¤„ç†çš„éœ€è¦ï¼Œæˆ‘å¯¹äº <code>nextSym()</code>ç¨‹åºè¿›è¡Œäº†æ”¹å†™ã€‚</p>
<p>å…·ä½“æ€è·¯ä¸ºï¼š<strong>å°†è¯†åˆ«ç»ˆç»“ç¬¦ï¼Œ<code>nextSym</code>ï¼Œä»¥åŠåç»­å¯èƒ½çš„é”™è¯¯å¤„ç†æ•´åˆè¿›ä¸€ä¸ªå‡½æ•°å½“ä¸­ã€‚</strong></p>
</blockquote>
<h4 id="å·¦é€’å½’çš„å¤„ç†"><a href="#å·¦é€’å½’çš„å¤„ç†" class="headerlink" title="å·¦é€’å½’çš„å¤„ç†"></a>å·¦é€’å½’çš„å¤„ç†</h4><p>æ¶‰åŠåˆ°å·¦é€’å½’çš„æ–‡æ³•ä¸»è¦æ˜¯å…³äº <code>Exp</code>ç³»åˆ—çš„éç»ˆç»“ç¬¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddExp -&gt; MulExp | AddExp (<span class="string">&#x27;+&#x27;</span> | <span class="string">&#x27;âˆ’&#x27;</span>) MulExp</span><br></pre></td></tr></table></figure>

<blockquote>
<p>[!NOTE]</p>
<p><strong>é€šè¿‡ç†è®ºè¯¾çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹äºå·¦é€’å½’æ–‡æ³•ï¼Œä¸€èˆ¬æœ‰2ç§å¤„ç†æ–¹å¼â€”â€”å³é€’å½’æ”¹å†™ or é‡‡ç”¨æ‰©å……çš„BNFèŒƒå¼</strong></p>
</blockquote>
<h5 id="å³é€’å½’æ”¹å†™"><a href="#å³é€’å½’æ”¹å†™" class="headerlink" title="å³é€’å½’æ”¹å†™"></a>å³é€’å½’æ”¹å†™</h5><p><code>ä¾‹å¦‚ï¼š</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddExp -&gt; MulExp | MulExp (<span class="string">&#x27;+&#x27;</span> | <span class="string">&#x27;âˆ’&#x27;</span>) AddExp</span><br></pre></td></tr></table></figure>

<p><img src="/2025/08/14/compiler/image-20231220110847759.png"></p>
<p>ä½†å¦‚æ­¤å¤„ç†æ˜¯å­˜åœ¨æ½œåœ¨é£é™©çš„ï¼Œ<strong>å› ä¸ºä¿®æ”¹äº†æ–‡æ³•</strong></p>
<h5 id="æ‰©å……çš„BNFèŒƒå¼"><a href="#æ‰©å……çš„BNFèŒƒå¼" class="headerlink" title="æ‰©å……çš„BNFèŒƒå¼"></a>æ‰©å……çš„BNFèŒƒå¼</h5><p>è¿˜æœ‰ä¸€ç§å¤„ç†æ–¹å¼æ˜¯é‡‡ç”¨BNFèŒƒå¼ï¼Œä¿®æ”¹äº†æ–‡æ³•ï¼Œç›´æ¥ä¸¢æ‰ <code>AddExp</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddExp -&gt; MulExp &#123;&#x27;+&#x27; MulExp&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2025/08/14/compiler/image-20231220111136501.png"></p>
<p>è¿™ç§å¤„ç†æ–¹å¼<strong>ä¾ç„¶å­˜åœ¨é£é™©</strong>ï¼Œå› ä¸ºåç»­çš„æ‰€æœ‰ç¼–è¯‘ç¯èŠ‚éƒ½è¦ç›¸åº”åœ°ä½¿ç”¨ä¿®æ”¹åçš„æ–‡æ³•ã€‚</p>
<h4 id="å¤„ç†æ–¹å¼"><a href="#å¤„ç†æ–¹å¼" class="headerlink" title="å¤„ç†æ–¹å¼"></a>å¤„ç†æ–¹å¼</h4><blockquote>
<p>[!IMPORTANT]</p>
<p>ç»è¿‡ä¸Šè¿°åˆ†æï¼Œè€ƒè™‘åˆ°æœªæ¥ <code>æœŸä¸­æœŸæœ«è€ƒè¯•</code>å¯èƒ½æ¶‰åŠçš„æ½œåœ¨çš„æ–‡æ³•ä¿®æ”¹ä¸æ›´æ–°ï¼Œé€šè¿‡å‚è€ƒå­¦é•¿ç¼–è¯‘å™¨çš„è®¾è®¡ï¼Œæˆ‘å†³å®šé‡‡ç”¨ä¸€ç§æ›´ç¬¦åˆå®é™…ç¼–è¯‘å™¨æ’°å†™çš„æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œå³ï¼š</p>
<p>å¯¹äºä¸Šè¿°ä¾‹å­ï¼Œ<strong>åœ¨æ‰©å……çš„BNFèŒƒå¼çš„åŸºç¡€ä¸Šå†è¿›ä¸€æ­¥ï¼ŒæŠŠåˆšåˆšæ‹†å‡ºæ¥çš„æ‰€æœ‰ <code>MulExp</code>å…¨éƒ¨æ‰‹åŠ¨ç»„è£…å›å·¦é€’å½’çš„å½¢æ€ã€‚æˆ‘ä»¬åˆ©ç”¨ <code>java</code>çš„é¢å‘å¯¹è±¡ç‰¹æ€§ï¼Œå°†è§£æå‡ºçš„ <code>MulExp</code>é‡æ–°ç»„è£…ä¸º <code>AddExp</code>ã€‚</strong></p>
<p><strong>æ­¤æ—¶å·¦é€’å½’å¯¹äºåç»­çš„ç¼–è¯‘éƒ¨åˆ†ä¸å†æœ‰å½±å“ï¼Œå› ä¸ºæˆ‘ä»¬çš„ä¿¡æ¯å·²ç»å…¨éƒ¨å­˜å‚¨åœ¨ç¼–è¯‘å™¨ä¸­ï¼Œä¸å†å—åˆ°æœ€å·¦æ¨å¯¼çš„é™åˆ¶ã€‚</strong></p>
</blockquote>
<p><code>ä»£ç ç¤ºä¾‹ï¼š</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AddExp â†’ MulExp | AddExp (&#x27;+&#x27; | &#x27;âˆ’&#x27;) MulExp</span></span><br><span class="line">    <span class="keyword">public</span> AddExpNode <span class="title function_">AddExp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AddExpNode</span> <span class="variable">addExpNode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Token</span> <span class="variable">opToken</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">MulExpNode</span> <span class="variable">mulExpNode</span> <span class="operator">=</span> MulExp();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (currentToken.type == TokenType.PLUS || currentToken.type == TokenType.MINU) &#123;</span><br><span class="line">            addExpNode = <span class="keyword">new</span> <span class="title class_">AddExpNode</span>(addExpNode, opToken, mulExpNode);</span><br><span class="line">            opToken = matchToken(currentToken.type);</span><br><span class="line">            mulExpNode = MulExp();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AddExpNode</span>(addExpNode, opToken, mulExpNode);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="å›æº¯æ³•"><a href="#å›æº¯æ³•" class="headerlink" title="å›æº¯æ³•"></a>å›æº¯æ³•</h4><p>å¯¹äºä¸€èˆ¬çš„äº§ç”Ÿå¼ï¼Œæˆ‘ä»¬é‡‡ç”¨FIRSTé›†æ¥åˆ¤åˆ«å³å¯ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ä¸é‚£ä¹ˆå‹å¥½çš„äº§ç”Ÿå¼ï¼Œæˆ‘ä»¬éš¾ä»¥åˆ¤åˆ«ï¼š</p>
<ul>
<li>é€‰æ‹©å“ªä¸ªäº§ç”Ÿå¼ã€‚</li>
<li>äº§ç”Ÿå¼ä¸­ <code>&#123;xxx&#125;</code>çš„é‡å¤éƒ¨åˆ†ï¼Œåˆ°åº•åº”è¯¥ä½•æ—¶ç»“æŸã€‚</li>
</ul>
<p><strong>é‡å¤éƒ¨åˆ†å•¥æ—¶å€™ç»“æŸï¼Ÿçœ‹çœ‹ <code>)</code>ï¼Œ<code>]</code>ä¸å°±å¥½äº†ï¼Ÿäº‹å®ä¸Šï¼Œæˆ‘ä»¬åœ¨åç»­é”™è¯¯å¤„ç†ä¸­é‡‡å–çš„ï¼Œè¡¥å…¨çš„é”™è¯¯å±€éƒ¨åŒ–ç­–ç•¥ï¼Œè¿«ä½¿æˆ‘ä»¬çš„ç¨‹åºåœ¨ <code>)</code>ï¼Œ<code>]</code>ç¼ºå¤±æ—¶ä¾ç„¶è¦æ­£å¸¸å·¥ä½œã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åªå¾—ä»¥å¾ªç¯éƒ¨çš„FIRSTé›†æ¥åˆ¤åˆ«</strong>ã€‚</p>
<p>å›åˆ°æˆ‘ä»¬çš„å›æº¯é—®é¢˜æ¥ã€‚</p>
<p><strong>å›æº¯ï¼Œå³FIRSTä¹Ÿå¤±çµçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¢«è¿«è·³è¿‡æŸä¸ªéç»ˆç»“ç¬¦ï¼Œå¯¹åé¢çš„æ ‡å¿—æ€§ç¬¦å·è¿›è¡Œåˆ†æï¼Œä»è€Œåˆ¤æ–­é€‰å–çš„äº§ç”Ÿå¼åˆ†æ”¯çš„æ‰‹æ®µã€‚</strong></p>
<p>å›æº¯åªäº§ç”Ÿåœ¨ <code>Stmt</code>çš„å·¦å€¼ä¸ <code>Exp</code>åˆ¤åˆ«ä¸Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">plaintext</span><br><span class="line">Stmt -&gt; LVal &#x27;=&#x27; Exp &#x27;;&#x27;</span><br><span class="line">Stmt -&gt; [Exp] &#x27;;&#x27;</span><br><span class="line">Stmt -&gt; LVal &#x27;=&#x27; &#x27;getint&#x27;&#x27;(&#x27;&#x27;)&#x27;&#x27;;&#x27;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œï¼Œ<code>Exp</code>å½“ç„¶å¯ä»¥é€è¿‡ <code>PrimaryExp</code>æ¨å‡ºå·¦å€¼ <code>LVal</code>ï¼ŒFIRSTé›†å¤±çµã€‚</p>
<p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬è¦å¤„ç†æ‰ç¢äº‹çš„ <code>LVal</code>ï¼Œæš´éœ²å‡ºåé¢çš„ <code>=</code>å’Œ <code>getint</code>ã€‚</p>
<p>å›æº¯ä¸»è¦æ˜¯é‡‡ç”¨ <code>pinToken()</code>å’Œ <code>reflow()</code>æ¥è®°å½•ã€å¤åŸå½“å‰æ¸¸æ ‡åœ¨tokenåºåˆ—çš„ä½ç½®ã€‚è¯¦ç»†ä»£ç åŠæ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> -&gt; &#123;</span><br><span class="line">                <span class="comment">// æœ€å–œæ¬¢çš„ä¸€é›†</span></span><br><span class="line">                <span class="comment">// ä½™ä¸‹å››ç§æƒ…å†µï¼š</span></span><br><span class="line">                <span class="comment">//  LVal &#x27;=&#x27; Exp &#x27;;&#x27;</span></span><br><span class="line">                <span class="comment">//  [Exp] &#x27;;&#x27;</span></span><br><span class="line">                <span class="comment">//  LVal &#x27;=&#x27; &#x27;getint&#x27;&#x27;(&#x27;&#x27;)&#x27;&#x27;;&#x27;</span></span><br><span class="line">                <span class="comment">//  LVal &#x27;=&#x27; &#x27;getchar&#x27;&#x27;(&#x27;&#x27;)&#x27;&#x27;;&#x27;</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (currentToken.type == TokenType.SEMICN) &#123;</span><br><span class="line">                    <span class="comment">//ç›´æ¥åŒ¹é…ï¼Œæœ€å–œæ¬¢çš„ä¸€é›†</span></span><br><span class="line">                    tokens.add(matchToken(TokenType.SEMICN));</span><br><span class="line">                    type = StmtType.EXP;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pinToken();</span><br><span class="line">                    <span class="type">LValNode</span> <span class="variable">lValNode</span> <span class="operator">=</span> LVal();</span><br><span class="line">                    <span class="keyword">if</span> (currentToken.type == TokenType.ASSIGN) &#123;</span><br><span class="line">                        nodes.add(lValNode);</span><br><span class="line">                        tokens.add(matchToken(TokenType.ASSIGN));</span><br><span class="line">                        <span class="comment">//  LVal &#x27;=&#x27; &#x27;getint&#x27;&#x27;(&#x27;&#x27;)&#x27;&#x27;;&#x27;</span></span><br><span class="line">                        <span class="comment">//  LVal &#x27;=&#x27; &#x27;getchar&#x27;&#x27;(&#x27;&#x27;)&#x27;&#x27;;&#x27;</span></span><br><span class="line">                        <span class="keyword">if</span> (currentToken.type == TokenType.GETINTTK) &#123;</span><br><span class="line">                            tokens.add(matchToken(TokenType.GETINTTK));</span><br><span class="line">                            tokens.add(matchToken(TokenType.LPARENT));</span><br><span class="line">                            tokens.add(matchToken(TokenType.RPARENT));</span><br><span class="line">                            tokens.add(matchToken(TokenType.SEMICN));</span><br><span class="line">                            type = StmtType.LVALGETINT;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentToken.type == TokenType.GETCHARTK) &#123;</span><br><span class="line">                            tokens.add(matchToken(TokenType.GETCHARTK));</span><br><span class="line">                            tokens.add(matchToken(TokenType.LPARENT));</span><br><span class="line">                            tokens.add(matchToken(TokenType.RPARENT));</span><br><span class="line">                            tokens.add(matchToken(TokenType.SEMICN));</span><br><span class="line">                            type = StmtType.LVALGETCHR;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// LVal &#x27;=&#x27; Exp &#x27;;&#x27;</span></span><br><span class="line">                            nodes.add(Exp());</span><br><span class="line">                            tokens.add(matchToken(TokenType.SEMICN));</span><br><span class="line">                            type = StmtType.LVALASSIGN;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        reflow();</span><br><span class="line">                        <span class="type">ExpNode</span> <span class="variable">expNode</span> <span class="operator">=</span> Exp();</span><br><span class="line">                        nodes.add(expNode);</span><br><span class="line">                        tokens.add(matchToken(TokenType.SEMICN));</span><br><span class="line">                        type = StmtType.EXP;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Nodeç±»â€”â€”å‰ç«¯ğŸ”—ä¸­ç«¯çš„å…³é”®"><a href="#Nodeç±»â€”â€”å‰ç«¯ğŸ”—ä¸­ç«¯çš„å…³é”®" class="headerlink" title="Nodeç±»â€”â€”å‰ç«¯ğŸ”—ä¸­ç«¯çš„å…³é”®"></a>Nodeç±»â€”â€”å‰ç«¯ğŸ”—ä¸­ç«¯çš„å…³é”®</h3><p><strong><code>node</code>ç±»æ˜¯è¯­æ³•åˆ†æä¸­ï¼Œè¯­æ³•æ ‘çš„ç»“ç‚¹ï¼Œè®°å½•äº†è¯­æ³•åˆ†æçš„ç»“æœ</strong>ã€‚æ˜¯è´¯ç©¿äº†è¯­æ³•åˆ†æã€é”™è¯¯å¤„ç†ã€ä¸­é—´ä»£ç ç”Ÿæˆçš„é‡è¦ç±»ã€‚</p>
<p>å¯¹äºæ¯ä¸€ä¸ªéç»ˆç»“ç¬¦ï¼Œéƒ½å»ºç«‹ä¸€ä¸ª <code>node</code>ç±»ã€‚æ‰€æœ‰ <code>node</code>ç±»éƒ½ç»§æ‰¿äº†æŠ½è±¡çˆ¶ç±» <code>Node</code>ã€‚</p>
<p><code>Node</code>è§„å®šäº†æ‰€æœ‰ <code>node</code>ç±»éƒ½è¦å®ç°çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œç”¨äº<strong>åœ¨éå†è¯­æ³•æ ‘æ—¶æ‰§è¡Œç›¸åº”çš„åŠ¨ä½œ</strong>ï¼ˆå³é€’å½’ä¸‹é™æ—¶çš„åŠ¨ä½œç¬¦å·ï¼‰ï¼š</p>
<ul>
<li><code>print()</code>æ–¹æ³•ï¼Œé€è¿‡éå†è¯­æ³•æ ‘ï¼Œè¾“å‡ºè¯­æ³•åˆ†æç»“æœè‡³æ–‡ä»¶ã€‚</li>
<li><code>visit()</code>æ–¹æ³•ï¼Œé€è¿‡éå†è¯­æ³•æ ‘ï¼Œæ£€æŸ¥é”™è¯¯å¹¶è®°å½•ã€‚</li>
<li><code>buildIr()</code>æ–¹æ³•ï¼Œé€è¿‡éå†è¯­æ³•æ ‘ï¼Œç”Ÿæˆ <code>llvm</code>ä»£ç ã€‚</li>
</ul>
<h2 id="è¯­ä¹‰åˆ†æ-é”™è¯¯å¤„ç†"><a href="#è¯­ä¹‰åˆ†æ-é”™è¯¯å¤„ç†" class="headerlink" title="è¯­ä¹‰åˆ†æ&amp;&amp;é”™è¯¯å¤„ç†"></a>è¯­ä¹‰åˆ†æ&amp;&amp;é”™è¯¯å¤„ç†</h2><p>åœ¨å½“å‰å‰ç«¯é˜¶æ®µï¼Œæˆ‘ä»¬è¦æ±‚ç”Ÿæˆçš„ç¬¦å·è¡¨è¿˜æ˜¯è¿‡äºç®€æ˜“ï¼Œå®é™…ä¸Šï¼Œåªå¯¹äºé”™è¯¯å¤„ç†æœ‰æŒ‡å¯¼æ„ä¹‰ï¼Œå¯ä»¥è¯´ï¼Œæˆ‘ä»¬çš„åˆæ­¥è¯­ä¹‰åˆ†æï¼Œå°±æ˜¯ä¸ºäº†é”™è¯¯å¤„ç†å‡†å¤‡çš„ã€‚</p>
<h3 id="é”™è¯¯æ€»è®º"><a href="#é”™è¯¯æ€»è®º" class="headerlink" title="é”™è¯¯æ€»è®º"></a>é”™è¯¯æ€»è®º</h3><h4 id="è¯­æ³•-è¯æ³•é”™è¯¯"><a href="#è¯­æ³•-è¯æ³•é”™è¯¯" class="headerlink" title="è¯­æ³•&amp;&amp;è¯æ³•é”™è¯¯"></a>è¯­æ³•&amp;&amp;è¯æ³•é”™è¯¯</h4><p>å¹¶ä¸æ˜¯æ‰€æœ‰çš„é”™è¯¯éƒ½æ˜¯è¯­ä¹‰é”™è¯¯ï¼Œå¸¸è§çš„è¯­ä¹‰é”™è¯¯æœ‰â€œå˜é‡é‡å‘½åï¼Œå˜é‡æœªå®šä¹‰â€ç­‰ï¼Œè¿™äº›é”™è¯¯æ˜¯å¯ä»¥é€šè¿‡è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æçš„ï¼Œä¸ä¼šé€ æˆè¯­æ³•åˆ†æçš„é”™è¯¯ã€‚ä½†æ˜¯æœ‰äº›é”™è¯¯ï¼Œæ˜¯æ²¡æœ‰åŠæ³•é€šè¿‡è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æçš„ï¼Œæœ‰å¦‚ä¸‹è¿™äº›ç±»</p>
<table>
<thead>
<tr>
<th>ç¼–å·</th>
<th>ç±»å‹</th>
<th>åŸå› </th>
</tr>
</thead>
<tbody><tr>
<td>a</td>
<td>éæ³•ç¬¦å·</td>
<td>æ— æ³•é€šè¿‡è¯æ³•åˆ†æ</td>
</tr>
<tr>
<td>i</td>
<td>ç¼ºå°‘åˆ†å·</td>
<td>æ— æ³•é€šè¿‡è¯­æ³•åˆ†æ</td>
</tr>
<tr>
<td>j</td>
<td>ç¼ºå°‘å³å°æ‹¬å·</td>
<td>æ— æ³•é€šè¿‡è¯­æ³•åˆ†æ</td>
</tr>
<tr>
<td>k</td>
<td>ç¼ºå°‘å³ä¸­æ‹¬å·</td>
<td>æ— æ³•é€šè¿‡è¯­æ³•åˆ†æ</td>
</tr>
</tbody></table>
<p>å¯¹äº <code>A</code>ç±»é”™è¯¯ï¼Œæ­¤ç±»é”™è¯¯ç›´æ¥å¤„ç†ä¹Ÿä¸ä¼šå¯¼è‡´è¯­æ³•ï¼Œè¯­ä¹‰åˆ†ææ— æ³•è¿›è¡Œï¼Œæ•…ç›´æ¥å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(ErrorType.a, lineNum));</span><br><span class="line">                    tokenType = (inputText.charAt(pos) == <span class="string">&#x27;&amp;&#x27;</span>) ? TokenType.AND : TokenType.OR;</span><br><span class="line">                    str = (inputText.charAt(pos) == <span class="string">&#x27;&amp;&#x27;</span>) ? <span class="string">&quot;&amp;&amp;&quot;</span> : <span class="string">&quot;||&quot;</span>;</span><br><span class="line">                    tokenLength = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>è€Œå¯¹äº <code>iï¼Œjï¼Œk</code>è¿™äº›å¯¼è‡´è¯­æ³•åˆ†æè¿›è¡Œä¸ä¸‹å»çš„é”™è¯¯ä¸€å®šéœ€è¦è¢«â€œåŒ…å®¹â€ï¼Œå¦åˆ™å°±åšæŒä¸åˆ°é”™è¯¯å¤„ç†æµç¨‹äº†ã€‚è¿™ç§åŒ…å®¹è®¾ç½®è¿˜æœ‰ä¸€ç§â€œè¡¥å……â€çš„æ„å‘³åœ¨é‡Œé¢ã€‚ä½†æ˜¯æœ€éš¾çš„å…¶å®æ˜¯ç¼ºå¤±ç¬¦å·å¯¹äºæ­£å¸¸è¯­æ³•è§£æçš„å½±å“ï¼Œç¼ºå¤±ç¬¦å·ä¼šè®©åŸæœ¬å°±å¾ˆå›°éš¾çš„è¯­æ³•åˆ†æå˜å¾—æ›´åŠ å›°éš¾ï¼Œè¿™æ˜¯å› ä¸ºè¯­æ³•åˆ†ææœ¬å°±éœ€è¦ä¾é ç¬¦å·ç¡®å®šè§£æçš„åˆ†æ”¯ï¼Œç¼ºå°‘ç¬¦å·ä¼šè®©è¿™ä¸ªè¿‡ç¨‹å˜å¾—æ¨¡ç³Šä¸æ¸…ï¼Œè¿™ä¹Ÿæ˜¯åƒ <code>i, j, k</code> è¿™ç±»é”™è¯¯å¹¶ä¸å¤ªå¤šçš„åŸå› ï¼Œå› ä¸ºä¸€æ—¦å¤šäº†ï¼Œå°±ä¼šå¯¼è‡´è§£æå›°éš¾ã€‚</p>
<p>åœ¨ä¸‰ç§ç¼ºå¤±ä¸­ï¼Œä»¥ç¼ºå°‘å³ä¸­æ‹¬å·æœ€ä¸ºå¥½å¤„ç†ï¼Œä¸­æ‹¬å·æ„å‘³ç€ç»´åº¦ä¿¡æ¯ï¼Œåªè¦æœ‰å·¦ä¸­æ‹¬å·ï¼Œé‚£ä¹ˆå³ä¸­æ‹¬å·ä¸€å®šæ˜¯å¯ä»¥è¡¥ä¸Šçš„ï¼ŒåŸºæœ¬ä¸Šæ— è„‘å°±å¯ä»¥äº†ã€‚</p>
<p>ä½†æ˜¯å¯¹äºç¼ºå¤±åˆ†å·å’Œå°æ‹¬å·ï¼Œæœ‰å¯èƒ½é€ æˆè§£æåˆ†æ”¯çš„åˆ¤æ–­ä¸å½“ã€‚æ‰€ä»¥éœ€è¦è¿›è¡Œå›é€€å¤„ç†ï¼ˆå¦‚æœä¸å›é€€çš„è¯å°±è¦æ”¹å†™æ–‡æ³•ï¼Œè€Œä¸”æ–‡æ³•æ”¹çš„æ¯«æ— è¯­ä¹‰æ„ä¹‰ï¼‰ã€‚</p>
<p>å¯¹äºç¼ºå¤±åˆ†å·ï¼Œæœ‰æ— æ³•åŒºåˆ†èµ‹å€¼è¯­å¥å’Œè¡¨è¾¾å¼çš„é—®é¢˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼ºå¤±å‰</span></span><br><span class="line">i + <span class="number">1</span>;</span><br><span class="line">a = b + c;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼ºå¤±å</span></span><br><span class="line">i + <span class="number">1</span></span><br><span class="line">a = b + c;</span><br></pre></td></tr></table></figure>

<p>è¿™å°±æ„å‘³ç€æ²¡æ³•é€šè¿‡å‰ç»ï¼ˆå³â€œåœ¨åˆ†å·å‰æœ‰ä¸€ä¸ªç­‰äºå·â€œï¼‰æ¥ç¡®å®šæ˜¯å¦æ˜¯èµ‹å€¼è¯­å¥ã€‚æ‰€ä»¥åªèƒ½é€šè¿‡â€œå°è¯•è§£æ-åˆ¤æ–­ LASTâ€çš„æ–¹æ³•è¿›è¡Œã€‚</p>
<p>å¯¹äº <code>return</code> è¯­å¥ï¼Œå¯èƒ½ä¹Ÿæœ‰è¿™ç§ç°è±¡ï¼Œè™½ç„¶åº”è¯¥è¢«è¯­ä¹‰çº¦æŸäº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼ºå¤±å‰</span></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">a;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼ºå¤±å</span></span><br><span class="line"><span class="keyword">return</span> </span><br><span class="line">a;</span><br></pre></td></tr></table></figure>

<p>å¯¹äº <code>Callee</code> è¯­å¥ï¼Œä¹Ÿæ˜¯è¿™æ ·ï¼ˆåº”è¯¥ä¹Ÿè¢«çº¦æŸäº†ï¼‰ï¼Œè¿™é‡Œåº”è¯¥æ˜¯åŒæ—¶ç¼ºå¤±äº†å°æ‹¬å·å’Œåˆ†å·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼ºå¤±å‰</span></span><br><span class="line">f();</span><br><span class="line">a;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼ºå¤±å</span></span><br><span class="line">f(</span><br><span class="line">a;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“æ¥çœ‹ï¼Œæˆ‘ä»¬ç»“åˆå‰æ–‡ <code>Parser</code>ä¸­ <code>nextSym</code>çš„å®ç°ï¼Œç»Ÿä¸€å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é€šè¿‡ä¾æ¬¡åŒ¹é…ç†æƒ³è¯­æ³•æˆåˆ†æ¥é¿å…å›æº¯</span></span><br><span class="line">    <span class="keyword">public</span> Token <span class="title function_">matchToken</span><span class="params">(TokenType tokenType)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentToken.type == tokenType) &#123;</span><br><span class="line">            <span class="type">Token</span> <span class="variable">tmp</span> <span class="operator">=</span> currentToken;</span><br><span class="line">            <span class="keyword">if</span> (pos &lt; maxLength) &#123;</span><br><span class="line">                pos++;</span><br><span class="line">                currentToken = tokens.get(pos);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tokenType == TokenType.SEMICN || tokenType == TokenType.RPARENT || tokenType == TokenType.RBRACK) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">lineNum</span> <span class="operator">=</span> tokens.get(pos - <span class="number">1</span>).lineNum;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> tokenType.getStr();</span><br><span class="line">            <span class="type">ErrorType</span> <span class="variable">errorType</span> <span class="operator">=</span> mismatchErrors.get(tokenType);</span><br><span class="line"></span><br><span class="line">            ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(errorType, lineNum));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Token</span>(str, lineNum, tokenType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="è¯­ä¹‰é”™è¯¯å¤„ç†-è¯­ä¹‰åˆ†æ"><a href="#è¯­ä¹‰é”™è¯¯å¤„ç†-è¯­ä¹‰åˆ†æ" class="headerlink" title="è¯­ä¹‰é”™è¯¯å¤„ç† &amp;&amp; è¯­ä¹‰åˆ†æ"></a>è¯­ä¹‰é”™è¯¯å¤„ç† &amp;&amp; è¯­ä¹‰åˆ†æ</h4><p>é”™è¯¯å¤„ç†çš„å„ä¸ªè¯­ä¹‰é”™è¯¯ç±»å‹æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ï¼Œå½¼æ­¤ä¹‹é—´ä»…å­˜åœ¨ä¸€å®šçš„è”ç³»ï¼Œå¯ä»¥åˆ†åˆ«å¯¹æ¯ä¸€ç§é”™è¯¯è¿›è¡Œå¤„ç†ã€‚åœ¨è¿›è¡Œé”™è¯¯å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å»ºç«‹äº†<strong>æ ˆå¼ç¬¦å·è¡¨</strong>ã€‚</p>
<h5 id="ç¬¦å·Symbol"><a href="#ç¬¦å·Symbol" class="headerlink" title="ç¬¦å·Symbol"></a>ç¬¦å·Symbol</h5><p>æˆ‘å°†ç¬¦å·çš„ç±»å‹åˆ†ä¸ºå‡½æ•°ç¬¦å· <code>FuncSymbol</code>å’Œå˜é‡ç¬¦å· <code>NumSymbol, CharSymbol</code>ï¼ŒäºŒè€…éƒ½ç»§æ‰¿ä¸€ä¸ªçˆ¶ç±» <code>Symbol</code>ã€‚</p>
<p>å¯¹äºå‡½æ•°ç¬¦å·ï¼Œæˆ‘ä»¬é¢å¤–è®°å½•å…¶è¿”å›å€¼ç±»å‹ä»¥åŠå½¢å‚çš„Symbolï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FuncSymbol</span> <span class="keyword">extends</span> <span class="title class_">Symbol</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">FuncReturnType</span>&#123;</span><br><span class="line">        INT, VOID, CHAR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> FuncReturnType returnType;</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;NumSymbol&gt; params;    <span class="comment">// å‚æ•°ç¬¦å·åˆ—è¡¨</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºå˜é‡ç¬¦å·ï¼Œç”±äºå…¶åªå¯èƒ½æ˜¯ <code>int char æˆ–è€…int charæ•°ç»„ç±»å‹</code>ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦é¢å¤–è®°å½•å…¶ç»´æ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NumSymbol</span> <span class="keyword">extends</span> <span class="title class_">Symbol</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> dim;        <span class="comment">// æ•°ç»„ç»´æ•° 0 1</span></span><br><span class="line">    <span class="keyword">private</span> String ifArray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CharSymbol</span> <span class="keyword">extends</span> <span class="title class_">Symbol</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> dim;        <span class="comment">// æ•°ç»„ç»´æ•° 0 1</span></span><br><span class="line">    <span class="keyword">private</span> String ifArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç¬¦å·è¡¨SymbolTable"><a href="#ç¬¦å·è¡¨SymbolTable" class="headerlink" title="ç¬¦å·è¡¨SymbolTable"></a>ç¬¦å·è¡¨SymbolTable</h5><p>å¯¹äºç¬¦å·è¡¨ï¼Œæˆ‘ä½¿ç”¨<strong>æ ˆå¼ç¬¦å·è¡¨</strong>ã€‚åœ¨è®¾è®¡ä¹‹åˆï¼Œæˆ‘æ˜¯æƒ³è¦ä¿ç•™ä¸€ä¸ªåŒå‘çš„ç±»ä¼¼æ ‘ç»“æ„ï¼ˆå…¶å®ä¹Ÿç¡®å®å®ç°äº†ï¼Œ<strong>ä½†æ˜¯irç”Ÿæˆæ—¶æ²¡æœ‰é‡‡ç”¨è¯¥ç¬¦å·è¡¨</strong>ï¼‰ï¼Œåœ¨ä½¿ç”¨æ ˆå¼ç¬¦å·è¡¨åä¿ç•™æ ¹èŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥ç•™ä¸‹è¯¥ç¬¦å·è¡¨ã€‚å…·ä½“æ¥è¯´æ˜¯æŠŠä¸‹å›¾ä¸­çš„å•å‘è¾¹æ¢æˆåŒå‘è¾¹ï¼š</p>
<p><img src="/2025/08/14/compiler/image-20231220163717060.png"></p>
<p>æ¯ä¸ªç¬¦å·è¡¨ä¸­ï¼Œéƒ½ç”± <code>TreeMap</code>æ¥å­˜å‚¨å…·ä½“ä¿¡æ¯ï¼Œ<code>fatherSymbolTable</code>å’Œ <code>sonSymbolTables</code>ç»´æŠ¤çˆ¶å­é—´çš„å…³ç³»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SymbolTable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;String, Symbol&gt; symbolMap;    <span class="comment">//TreeMapæé«˜æ£€ç´¢é€Ÿåº¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SymbolTable fatherSymbolTable;    <span class="comment">// æ‰€å±çš„çˆ¶ç¬¦å·è¡¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;SymbolTable&gt; sonSymbolTables;   <span class="comment">// æ‰€æœ‰å­ç¬¦å·è¡¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node node;    <span class="comment">// ç”±æ­¤è¯­æ³•æ ‘æˆåˆ†å¼€å§‹æ–°å»ºæ­¤ç¬¦å·è¡¨</span></span><br><span class="line">    <span class="keyword">private</span> Integer regionIndex;</span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">SymbolTable</span><span class="params">(SymbolTable fatherSymbolTable, Node node, Integer regionIndex)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.symbolMap = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.fatherSymbolTable = fatherSymbolTable;</span><br><span class="line">        <span class="built_in">this</span>.sonSymbolTables = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.node = node;</span><br><span class="line">        <span class="built_in">this</span>.regionIndex = regionIndex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç¬¦å·è¡¨æ ˆSymbolTableStack"><a href="#ç¬¦å·è¡¨æ ˆSymbolTableStack" class="headerlink" title="ç¬¦å·è¡¨æ ˆSymbolTableStack"></a>ç¬¦å·è¡¨æ ˆSymbolTableStack</h5><p>è¯¥ç±»å†…å°è£…æœ‰æ„å»ºç¬¦å·è¡¨ã€æŸ¥ç¬¦å·è¡¨çš„å„ç§æ–¹æ³•ï¼Œä»¥åŠä¸€ä¸ªç¬¦å·è¡¨æ ˆ <code>Stack</code>ã€‚</p>
<p>è¯¥ç±»å†…è¿˜æœ‰ä¸º <code>continue</code>ï¼Œ<code>break</code>ï¼Œ<code>return</code>ç­‰å¯¹åº”é”™è¯¯è€Œè®¾ç½®çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SymbolTableStack</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Stack&lt;SymbolTable&gt; stack;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TreeMap&lt;Integer, ArrayList&lt;Symbol&gt;&gt; visitResults = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Integer</span> <span class="variable">regionIndex</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SymbolTableStack</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">SymbolTableStack</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SymbolTableStack</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SymbolTableStack <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ====================== æ ˆæ“ä½œ=======================</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SymbolTable <span class="title function_">peek</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance.stack.empty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance.stack.peek();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">stackPush</span><span class="params">(SymbolTable symbolTable)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!instance.stack.empty()) &#123;</span><br><span class="line">            peek().addSon(symbolTable);</span><br><span class="line">        &#125;</span><br><span class="line">        instance.stack.push(symbolTable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">nodePush</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        regionIndex++;</span><br><span class="line">        stackPush(<span class="keyword">new</span> <span class="title class_">SymbolTable</span>(peek(), node, regionIndex));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">pop</span><span class="params">()</span> &#123;</span><br><span class="line">        instance.stack.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addSymbolToPeek</span><span class="params">(Symbol symbol)</span> &#123;</span><br><span class="line">        peek().addSymbol(symbol);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">index</span> <span class="operator">=</span> peek().getRegionIndex();</span><br><span class="line">        <span class="keyword">if</span> (!visitResults.containsKey(index)) &#123;</span><br><span class="line">            ArrayList&lt;Symbol&gt; symbols = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            symbols.add(symbol);</span><br><span class="line">            visitResults.put(index, symbols);</span><br><span class="line">            <span class="comment">//System.out.println(&quot;æˆåŠŸå‘ç¬¦å·è¡¨ä¸­æ·»åŠ å…ƒç´  &quot; + index + &quot; &quot; + symbol);</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            visitResults.get(index).add(symbol);</span><br><span class="line">            <span class="comment">//System.out.println(&quot;æˆåŠŸå‘ç¬¦å·è¡¨ä¸­æ·»åŠ å…ƒç´  &quot; + index + &quot; &quot; + symbol);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TreeMap&lt;Integer, ArrayList&lt;Symbol&gt;&gt; <span class="title function_">getVisitResults</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> visitResults;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">outputResult</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, ArrayList&lt;Symbol&gt;&gt; entry : visitResults.entrySet()) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            ArrayList&lt;Symbol&gt; symbols = entry.getValue();</span><br><span class="line">            <span class="keyword">for</span> (Symbol symbol : symbols) &#123;</span><br><span class="line">                System.out.println(key + <span class="string">&quot;  - &quot;</span> + symbol);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================= æ ˆæŸ¥æ‰¾ =================</span></span><br><span class="line">    <span class="comment">// æ£€æµ‹æ ˆé¡¶ç¬¦å·è¡¨æ˜¯å¦åŒ…å«æŒ‡å®šåç§°çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">peekHasSymbol</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> peek().hasSymbol(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ•´ä¸ªæ ˆå†…æŸ¥æ‰¾å¹¶è¿”å›ç¬¬ä¸€ä¸ªæŒ‡å®šåç§°æŒ‡å®šç±»å‹çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Symbol <span class="title function_">getSymbol</span><span class="params">(String name, SymbolType symbolType)</span> &#123;</span><br><span class="line">        Symbol symbol;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> instance.stack.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            symbol = instance.stack.get(i).getSymbol(name, symbolType);</span><br><span class="line">            <span class="keyword">if</span> (symbol != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> symbol;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ•´ä¸ªæ ˆå†…æ˜¯å¦åŒ…å«æŒ‡å®šåç§°çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">stackHasSymbol</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (SymbolTable symbolTable : instance.stack) &#123;</span><br><span class="line">            <span class="keyword">if</span> (symbolTable.hasSymbol(name)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">stackHasSymbolSameType</span><span class="params">(String name, SymbolType symbolType)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> instance.stack.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="type">Symbol</span> <span class="variable">symbol</span> <span class="operator">=</span> instance.stack.get(i).getSymbol(name, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (symbol != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (symbolType == SymbolType.Const) &#123;</span><br><span class="line">                    <span class="keyword">return</span> symbol.type.isConst();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> symbol.type == symbolType;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================= å¾ªç¯å·¥å…· =================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•å½“å‰æ‰€åœ¨çš„å¾ªç¯æ·±åº¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">loopDepth</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">inLoop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance.loopDepth &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">enterLoop</span><span class="params">()</span> &#123;</span><br><span class="line">        instance.loopDepth++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exitLoop</span><span class="params">()</span> &#123;</span><br><span class="line">        instance.loopDepth = instance.loopDepth &gt; <span class="number">0</span> ? instance.loopDepth - <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================= å‡½æ•°å·¥å…· =================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•å½“å‰æ˜¯å¦åœ¨ä¸€ä¸ªæ— è¿”å›å€¼çš„å‡½æ•°å†…éƒ¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">noReturn</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">ifNoReturn</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance.noReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setIfReturn</span><span class="params">(<span class="type">boolean</span> inVoidFunc)</span> &#123;</span><br><span class="line">        instance.noReturn = inVoidFunc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="å…¥æ ˆæ–°ç¬¦å·è¡¨çš„æ—¶æœº"><a href="#å…¥æ ˆæ–°ç¬¦å·è¡¨çš„æ—¶æœº" class="headerlink" title="å…¥æ ˆæ–°ç¬¦å·è¡¨çš„æ—¶æœº"></a>å…¥æ ˆæ–°ç¬¦å·è¡¨çš„æ—¶æœº</h5><p>åœ¨éå†è¯­æ³•æ ‘çš„è¿‡ç¨‹ä¸­ï¼Œäº <code>MainFuncDef</code>ï¼Œ<code>FuncDef</code>ä»¥åŠ <code>Stmt</code>çš„ <code>StmtType.BLOCK</code>åœºåˆä¸‹ï¼Œè°ƒç”¨ <code>SymbolTableStack</code>ä¸­å°è£…å¥½çš„æ–¹æ³•å³å¯å…¥æ ˆæ–°çš„ç¬¦å·è¡¨ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (type == StmtType.BLOCK) &#123;</span><br><span class="line">            SymbolTableStack.nodePush(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">stackPush</span><span class="params">(SymbolTable symbolTable)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!instance.stack.empty()) &#123;</span><br><span class="line">            peek().addSon(symbolTable);</span><br><span class="line">        &#125;</span><br><span class="line">        instance.stack.push(symbolTable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">nodePush</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        regionIndex++;</span><br><span class="line">        stackPush(<span class="keyword">new</span> <span class="title class_">SymbolTable</span>(peek(), node, regionIndex));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="æ·»åŠ æ–°ç¬¦å·çš„æ—¶æœº"><a href="#æ·»åŠ æ–°ç¬¦å·çš„æ—¶æœº" class="headerlink" title="æ·»åŠ æ–°ç¬¦å·çš„æ—¶æœº"></a>æ·»åŠ æ–°ç¬¦å·çš„æ—¶æœº</h5><p>åœ¨éå†è¯­æ³•æ ‘çš„è¿‡ç¨‹ä¸­ï¼Œäº <code>MainFuncDef</code>ï¼Œ<code>FuncDef</code>ä»¥åŠ <code>Stmt</code>çš„ <code>StmtType.BLOCK</code>åœºåˆä¸‹ï¼Œè¯»å–åˆ°æ–°ç¬¦å·ï¼ˆå˜é‡ã€å¸¸é‡ã€å‡½æ•°ï¼‰æ—¶è°ƒç”¨ <code>SymbolTableStack</code>ä¸­å°è£…å¥½çš„æ–¹æ³•å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FuncSymbol</span> <span class="variable">funcSymbol</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FuncSymbol</span>(identToken.content, identToken.lineNum, <span class="built_in">this</span>, returnType, params);</span><br><span class="line">            SymbolTableStack.addSymbolToPeek(funcSymbol);</span><br></pre></td></tr></table></figure>

<h4 id="é”™è¯¯å¤„ç†çš„é€»è¾‘"><a href="#é”™è¯¯å¤„ç†çš„é€»è¾‘" class="headerlink" title="é”™è¯¯å¤„ç†çš„é€»è¾‘"></a>é”™è¯¯å¤„ç†çš„é€»è¾‘</h4><h5 id="é”™è¯¯è®°å½•æ–¹æ³•"><a href="#é”™è¯¯è®°å½•æ–¹æ³•" class="headerlink" title="é”™è¯¯è®°å½•æ–¹æ³•"></a>é”™è¯¯è®°å½•æ–¹æ³•</h5><p>åœ¨ <code>error/ErrorUtil.java</code>å†…å°è£…æœ‰æ£€æŸ¥å½“å‰è¯­å¢ƒä¸‹é”™è¯¯å¹¶è®°å½•çš„æ–¹æ³•ã€‚åœ¨éå†åˆ°è¯­æ³•æ ‘çš„ç‰¹å®šä½ç½®æ—¶ç›´æ¥è°ƒç”¨ï¼Œå³å¯è¿›è¡Œé”™è¯¯å¤„ç†ã€‚</p>
<h5 id="è®°å½•é”™è¯¯çš„æ¥å£"><a href="#è®°å½•é”™è¯¯çš„æ¥å£" class="headerlink" title="è®°å½•é”™è¯¯çš„æ¥å£"></a>è®°å½•é”™è¯¯çš„æ¥å£</h5><p>æˆ‘å°†æ‰€æœ‰èƒ½å¤Ÿç”Ÿæˆå¹¶è®°å½•é”™è¯¯çš„æ–¹æ³•éƒ½ç»Ÿä¸€æ”¾ç½®åœ¨äº† <code>error/ErrorUtil.java</code>é‡Œï¼Œè°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ä¾¿å¯ï¼ˆåˆ¤æ–­å¹¶ï¼‰è®°å½•é”™è¯¯ï¼Œä¾¿äºåæœŸä¿®æ”¹ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token å½“å‰ç»ˆç»“ç¬¦</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> noDuplicateError</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//  é‡å®šä¹‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkDuplicateError</span><span class="params">(Token token)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">noDuplicateError</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (SymbolTableStack.peekHasSymbol(token.content)) &#123;</span><br><span class="line">            ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(ErrorType.b, token.lineNum));</span><br><span class="line">            noDuplicateError = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> noDuplicateError;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="å…·ä½“é”™è¯¯çš„å¤„ç†æ–¹æ³•"><a href="#å…·ä½“é”™è¯¯çš„å¤„ç†æ–¹æ³•" class="headerlink" title="å…·ä½“é”™è¯¯çš„å¤„ç†æ–¹æ³•"></a>å…·ä½“é”™è¯¯çš„å¤„ç†æ–¹æ³•</h5><ul>
<li><p><strong>b ç±»é”™è¯¯ - åå­—é‡å®šä¹‰</strong></p>
<p>å¯¹äºå‡ºç°é”™è¯¯çš„å››æ¡æ–‡æ³•ï¼Œè¯»å–åˆ° <code>ident</code>çš„åˆ›å»ºæ—¶ï¼Œè°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkDuplicateError</span><span class="params">(Token token)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">noDuplicateError</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (SymbolTableStack.peekHasSymbol(token.content)) &#123;</span><br><span class="line">            ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(ErrorType.b, token.lineNum));</span><br><span class="line">            noDuplicateError = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> noDuplicateError;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>c ç±»é”™è¯¯ - æœªå®šä¹‰çš„åå­—</strong></p>
<p>å¯¹äºå‡ºç°é”™è¯¯çš„ä¸‰æ¡æ–‡æ³•ï¼Œè¯»å–åˆ° <code>ident</code>çš„å¼•ç”¨æ—¶ï¼Œè°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  æœªå®šä¹‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkUndefinedError</span><span class="params">(Token token)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">noUndefinedError</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!SymbolTableStack.stackHasSymbol(token.content)) &#123;</span><br><span class="line">            ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(ErrorType.c, token.lineNum));</span><br><span class="line">            noUndefinedError = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> noUndefinedError;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>d ç±»é”™è¯¯ - å‡½æ•°å‚æ•°ä¸ªæ•°ä¸åŒ¹é…</strong></p>
<p>å¯¹äºé¢˜ç›®ç»™å‡ºçš„æ–‡æ³•ï¼Œå½“ <code>UnaryExp</code>éœ€è¦è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œä»ç¬¦å·è¡¨å¾—åˆ°å…¶å½¢å‚ä¸ªæ•°ï¼Œå†è¯»å–å…¶å­èŠ‚ç‚¹çš„ <code>funcRParamsNode</code>çš„ <code>expNodes</code>çš„ <code>size()</code>ï¼Œä¸¤è€…æ¯”è¾ƒï¼Œå¦‚æœä¸åŒï¼Œé‚£å°±æŠ¥é”™ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (identToken != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ErrorUtil.checkUndefinedError(identToken)) &#123;</span><br><span class="line">                <span class="type">FuncSymbol</span> <span class="variable">symbol</span> <span class="operator">=</span> (FuncSymbol) SymbolTableStack.getSymbol(identToken.content, SymbolType.Func);</span><br><span class="line">                <span class="keyword">if</span> (symbol == <span class="literal">null</span>) &#123;</span><br><span class="line">                    ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(ErrorType.d, identToken.lineNum));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.getParams().size() != getParaSize()) &#123;</span><br><span class="line">                    ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(ErrorType.d, identToken.lineNum));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!checkParamsIllegal(symbol)) &#123;</span><br><span class="line">                    ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(ErrorType.e, identToken.lineNum));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (funcRParamsNode != <span class="literal">null</span>) &#123;</span><br><span class="line">                funcRParamsNode.visit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br></pre></td></tr></table></figure></li>
<li><p><strong>e ç±»é”™è¯¯ - å‡½æ•°å‚æ•°ç±»å‹ä¸åŒ¹é…</strong></p>
<p>æˆ‘ä»¬çš„å˜é‡ç±»å‹åªæœ‰2ç§ï¼šæ•´å‹ã€ä¸€ç»´æ•°ç»„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (identToken != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ErrorUtil.checkUndefinedError(identToken)) &#123;</span><br><span class="line">                <span class="type">FuncSymbol</span> <span class="variable">symbol</span> <span class="operator">=</span> (FuncSymbol) SymbolTableStack.getSymbol(identToken.content, SymbolType.Func);</span><br><span class="line">                <span class="keyword">if</span> (symbol == <span class="literal">null</span>) &#123;</span><br><span class="line">                    ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(ErrorType.d, identToken.lineNum));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.getParams().size() != getParaSize()) &#123;</span><br><span class="line">                    ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(ErrorType.d, identToken.lineNum));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!checkParamsIllegal(symbol)) &#123;</span><br><span class="line">                    ErrorHandler.addError(<span class="keyword">new</span> <span class="title class_">Error</span>(ErrorType.e, identToken.lineNum));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (funcRParamsNode != <span class="literal">null</span>) &#123;</span><br><span class="line">                funcRParamsNode.visit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br></pre></td></tr></table></figure></li>
<li><p><strong>f ç±»é”™è¯¯ - æ— è¿”å›å€¼çš„å‡½æ•°å­˜åœ¨ä¸åŒ¹é…çš„ <code>return</code>è¯­å¥ï¼›g ç±»é”™è¯¯ - æœ‰è¿”å›å€¼çš„å‡½æ•°ç¼ºå°‘ <code>return</code>è¯­å¥</strong></p>
<p>åœ¨ <code>stmt</code>çš„ç±»å‹æ˜¯ <code>Return</code>æ—¶ï¼Œå¦‚æœåœ¨å‡½æ•°å½“ä¸­ä½† <code>expNode != null</code>å°±æŠ¥é”™ã€‚</p>
</li>
<li><p><strong>h ç±»é”™è¯¯ - ä¸èƒ½æ”¹å˜å¸¸é‡çš„å€¼</strong></p>
<p>åˆ¤æ–­ <code>&lt;LVal&gt;</code>å½“ä¸­çš„ <code>&lt;ident&gt;</code>æ˜¯å¦æ˜¯å¸¸é‡å³å¯ã€‚</p>
</li>
<li><p><strong>m ç±»é”™è¯¯ - åœ¨éå¾ªç¯å—ä¸­ä½¿ç”¨ <code>break</code> å’Œ <code>continue</code> è¯­å¥</strong></p>
<p>æˆ‘ä»¬åœ¨ç¬¦å·è¡¨æ ˆå†…ç»´æŠ¤äº† <code>loopCount</code>ï¼Œåˆå§‹ä¸º 0ï¼Œæ¯æ¬¡è¿›å…¥å¾ªç¯å°±åŠ ä¸€ï¼Œé€€å‡ºå¾ªç¯å°±å‡ä¸€ã€‚</p>
<p>åœ¨ <code>stmt</code> çš„ç±»å‹æ˜¯ <code>Break</code> æˆ–è€… <code>Continue</code> æ—¶ï¼Œåˆ¤æ–­å½“å‰çš„ <code>loopCount</code> æ˜¯å¦ä¸ºé›¶å³å¯ï¼Œå¦‚æœæ˜¯ï¼Œé‚£å°±æŠ¥é”™ã€‚</p>
</li>
</ul>
<h4 id="è¯­ä¹‰åˆ†æç»“æœè¾“å‡º"><a href="#è¯­ä¹‰åˆ†æç»“æœè¾“å‡º" class="headerlink" title="è¯­ä¹‰åˆ†æç»“æœè¾“å‡º"></a>è¯­ä¹‰åˆ†æç»“æœè¾“å‡º</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> &#123;</span><br><span class="line">        TreeMap&lt;Integer, ArrayList&lt;Symbol&gt;&gt; visitResults = SymbolTableStack.getVisitResults();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, ArrayList&lt;Symbol&gt;&gt; entry : visitResults.entrySet()) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            ArrayList&lt;Symbol&gt; symbols = entry.getValue();</span><br><span class="line">            <span class="keyword">for</span> (Symbol symbol : symbols) &#123;</span><br><span class="line">                IO.write(IO.IOType.VISITOR, (key + <span class="string">&quot; &quot;</span> + symbol), <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="LLVM-IRç”Ÿæˆ"><a href="#LLVM-IRç”Ÿæˆ" class="headerlink" title="LLVM IRç”Ÿæˆ"></a>LLVM IRç”Ÿæˆ</h2><h3 id="LLVMç®€ä»‹"><a href="#LLVMç®€ä»‹" class="headerlink" title="LLVMç®€ä»‹"></a>LLVMç®€ä»‹</h3><p>LLVMæ˜¯ä¸€ç§ä¸‰åœ°å€ç ï¼Œå³ä¸€æ¡LLVMè¯­å¥å¯ä»¥è¡¨ç¤ºä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;è¿ç®—ç»“æœ&gt; <span class="operator">=</span> &lt;æŒ‡ä»¤ç±»å‹&gt; &lt;æ“ä½œæ•°<span class="number">1</span>&gt;<span class="punctuation">,</span> &lt;æ“ä½œæ•°<span class="number">2</span>&gt;</span><br></pre></td></tr></table></figure>

<p>è§‚å¯Ÿè¿™ç§æŒ‡ä»¤å¯ä»¥å‘ç°ï¼Œä¸€æ¡è¯­å¥ä¸»è¦ç”±ä¸‰ä¸ªè¦ç´ ç»„æˆï¼š</p>
<p>ï¼ˆ1ï¼‰æ“ä½œæ•°ï¼ˆ2ï¼‰æŒ‡ä»¤ç±»å‹ï¼ˆ3ï¼‰è¿ç®—ç»“æœ</p>
<p>ç°åœ¨<strong>æˆ‘ä»¬éœ€è¦å°†LLVMçš„è¿™ç§è¯­è¨€ç‰¹æ€§ï¼Œä½¿ç”¨Javaçš„ç±»è®¾è®¡æ¥è¡¨è¾¾</strong>ï¼š</p>
<ol>
<li><strong>åœ¨Javaä»£ç ä¸­ï¼Œä½¿ç”¨å…·ä½“çš„ç±»å¯¹è±¡ï¼Œæ¥è¡¨ç¤ºè¯­å¥ä¸­çš„å„ä¸ªå…ƒç´ </strong>ã€‚ï¼ˆå°±åƒè¯­æ³•åˆ†æä¸­ä½¿ç”¨å„ç§ <code>node</code>ç±»æ¥è¡¨è¾¾å„ç§è¯­æ³•å…ƒç´ ä¸€æ ·ï¼‰</li>
<li>å…·ä½“æªæ–½æ˜¯ï¼Œ<strong>é€šè¿‡éå†ä¹‹å‰è¯­æ³•åˆ†æçš„è¯­æ³•æ ‘ï¼Œé€è¿‡ç»“åˆå±æ€§ç¿»è¯‘æ–‡æ³•çš„é€’å½’ä¸‹é™çš„æ–¹å¼ï¼Œæ¥ç”Ÿæˆllvmçš„è¯­æ³•æ ‘</strong>ã€‚</li>
</ol>
<h4 id="å¯¹LLVMçš„ç®€å•ç†è§£"><a href="#å¯¹LLVMçš„ç®€å•ç†è§£" class="headerlink" title="å¯¹LLVMçš„ç®€å•ç†è§£"></a>å¯¹LLVMçš„ç®€å•ç†è§£</h4><p>æˆ‘ä»¬å°† <code>llvm</code>é‡‡ç”¨æ ‘çš„å½¢å¼å­˜å‚¨ï¼Œæ ¹èŠ‚ç‚¹ä¸º <code>Module</code>ã€‚</p>
<ul>
<li>ä¸€ä¸ª <code>module</code> ä¸­å¯ä»¥æ‹¥æœ‰ä¸¤ç§é¡¶å±‚å®ä½“ï¼š <code>Function</code> å’Œ <code>GlobalVariable</code></li>
<li>æ¯ä¸ª <code>Function</code> ä¸‹éƒ½æœ‰è‹¥å¹²åŸºæœ¬å— <code>BasicBlock</code></li>
<li>æ¯ä¸ª <code>BasicBlock</code>ä¸‹éƒ½æœ‰è‹¥å¹²æŒ‡ä»¤ <code>instruction</code></li>
</ul>
<p>åœ¨ä»¥ä¸Šç»“æ„ä¸­ï¼Œå…³é”®èŠ‚ç‚¹ç±»çš„è®¾è®¡å¦‚ä¸‹ï¼š</p>
<p><img src="/2025/08/14/compiler/image-20231110104112393.png"></p>
<p><strong>ç©ºå¿ƒç²—ç®­å¤´è¡¨ç¤ºç±»ç»§æ‰¿å…³ç³»</strong>ï¼ˆUserå’ŒValueç±»ä¹Ÿæ˜¯ç»§æ‰¿å…³ç³»ï¼Œå›¾åº”è¯¥æ˜¯ç”»é”™äº†ï¼‰ã€‚</p>
<p><strong>å®å¿ƒç»†ç®­å¤´è¡¨ç¤ºèšåˆå…³ç³»ï¼Œä»è€Œå½¢æˆæ ‘ç»“æ„</strong>ï¼ˆä¾‹å¦‚æ¯ä¸€ä¸ªåŸºæœ¬å— <code>BasicBlock</code>é‡Œæœ‰ä¸€æ¡æ¡æŒ‡ä»¤ <code>Instruction</code>ï¼‰ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;è¿ç®—ç»“æœ&gt; = &lt;æŒ‡ä»¤ç±»å‹&gt; &lt;æ“ä½œæ•°1&gt;, &lt;æ“ä½œæ•°2&gt;</span><br></pre></td></tr></table></figure>

<h5 id="æ“ä½œæ•°-Valueç±»"><a href="#æ“ä½œæ•°-Valueç±»" class="headerlink" title="æ“ä½œæ•° Valueç±»"></a>æ“ä½œæ•° Valueç±»</h5><p>å°†æ“ä½œæ•°è¡¨ç¤ºä¸ºä¸€ä¸ªç±»ï¼šValueï¼Œå®ƒ<strong>è¡¨ç¤ºèƒ½å¤Ÿä½œä¸ºæ“ä½œæ•°çš„å¯¹è±¡</strong>ã€‚</p>
<p>ä¾‹å¦‚å¦‚ä¸‹ä¹˜æ³•è¯­å¥ä¸­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%2 = mul i32 %1, 2</span><br></pre></td></tr></table></figure>

<p>æŒ‰ç…§ä¸Šé¢çš„è®¾è®¡ï¼Œ<strong><code>%1</code>å’Œ <code>2</code>éƒ½æ˜¯Valueï¼Œåœ¨Javaä»£ç ä¸­éƒ½ä»¥Valueç±»çš„å½¢å¼å­˜åœ¨</strong>ã€‚</p>
<h5 id="æ“ä½œæ•°ä½¿ç”¨è€…-Userç±»"><a href="#æ“ä½œæ•°ä½¿ç”¨è€…-Userç±»" class="headerlink" title="æ“ä½œæ•°ä½¿ç”¨è€… Userç±»"></a>æ“ä½œæ•°ä½¿ç”¨è€… Userç±»</h5><p>å°†æŒ‡ä»¤çš„è¿ç®—ç»“æœè¡¨ç¤ºä¸ºä¸€ä¸ªç±»ï¼šUserï¼Œå®ƒ<strong>è¡¨ç¤ºèƒ½å¤Ÿä½œä¸ºè¿ç®—ç»“æœçš„å¯¹è±¡ï¼Œæˆ–è€…è¯´æ˜¯æ“ä½œæ•°çš„ä½¿ç”¨è€…</strong>ã€‚</p>
<p>ä¾‹å¦‚å¦‚ä¸‹ä¹˜æ³•è¯­å¥ä¸­ï¼š</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">%2</span> <span class="operator">=</span> <span class="keyword">mul</span> <span class="type">i32</span> <span class="variable">%1</span><span class="punctuation">,</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>æŒ‰ç…§ä¸Šé¢çš„è®¾è®¡ï¼Œ<code>%2</code>æ˜¯Userï¼Œå®ƒ <code>use</code>äº† <code>%1</code>å’Œ <code>2</code>ã€‚<strong><code>%2</code>åœ¨Javaä»£ç ä¸­ä»¥Userç±»çš„å½¢å¼å­˜åœ¨</strong>ã€‚</p>
<h5 id="Userç±»ç»§æ‰¿Valueç±»"><a href="#Userç±»ç»§æ‰¿Valueç±»" class="headerlink" title="Userç±»ç»§æ‰¿Valueç±»"></a>Userç±»ç»§æ‰¿Valueç±»</h5><p>è§‚å¯Ÿå¦‚ä¸‹è¯­å¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%2 = mul i32 %1, 2</span><br><span class="line">%3 = add i32 %2, 3</span><br></pre></td></tr></table></figure>

<p>ä¹˜æ³•äº§ç”Ÿçš„ <code>%2</code><strong>è¿ç®—ç»“æœ</strong>åœ¨ä¸‹ä¸€æ¡åŠ æ³•è¯­å¥ä¸­<strong>ä½œä¸ºäº†æ“ä½œæ•°</strong>ã€‚<code>User</code>ç±»åº”è¯¥ç»§æ‰¿ <code>Value</code>ç±»ï¼Œè¿™æ ·åé¢çš„è¿ç®—æ‰èƒ½ç”¨åˆ°å‰é¢çš„ç»“æœã€‚</p>
<h5 id="æŒ‡ä»¤-Instructionç±»"><a href="#æŒ‡ä»¤-Instructionç±»" class="headerlink" title="æŒ‡ä»¤ Instructionç±»"></a>æŒ‡ä»¤ Instructionç±»</h5><p>ä¸ºæ¯ä¸€ç§æŒ‡ä»¤ç±»å‹éƒ½åˆ›å»ºä¸€ä¸ª <code>Instruction</code>æŒ‡ä»¤ç±»ï¼Œè¿™ä¸ª<strong>æŒ‡ä»¤ç±»ç»§æ‰¿ <code>User</code>ï¼Œæ—¢ç”¨æ¥è¡¨ç¤ºè¿ç®—ç»“æœï¼Œä¹Ÿç”¨æ¥è¡¨ç¤ºè¿™ä¸€æ¡æŒ‡ä»¤</strong>ã€‚</p>
<p>å¦‚ä½•ç†è§£â€æ—¢ç”¨æ¥è¡¨ç¤ºè¿ç®—ç»“æœï¼Œä¹Ÿç”¨æ¥è¡¨ç¤ºè¿™ä¸€æ¡æŒ‡ä»¤â€ï¼Ÿ</p>
<p>å›åˆ° <code>Userç±»</code>çš„ä¾‹å­</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%2 = mul i32 %1, 2</span><br></pre></td></tr></table></figure>

<p>åœ¨ä»£ç å®ç°å½“ä¸­ï¼Œ<strong><code>%2</code>æ˜¯ä¸€ä¸ª <code>Mul</code>æŒ‡ä»¤ç±»å¯¹è±¡</strong>ã€‚</p>
<ul>
<li>å®ƒæ—¢<strong>è¡¨ç¤º <code>%2</code>è¿™ä¸ªè¿ç®—ç»“æœ</strong>ï¼šMul extends Userï¼Œè¿™æ„å‘³ç€è¿™ä¸ª <code>Mul</code>ç±»å¯¹è±¡å¯ä»¥è¡¨ç¤ºè¿ç®—ç»“æœï¼›User extends Valueï¼Œè¿™æ„å‘³ç€è¿™ä¸ª <code>Mul</code>ç±»å¯¹è±¡è¿˜å¯ä»¥ä½œä¸ºæ“ä½œæ•°ã€‚</li>
<li>åˆ<strong>è¡¨ç¤ºè¿™æ¡è¯­å¥æœ¬èº«</strong>ï¼šMulç±»æ˜¯llvmè¯­æ³•æ ‘ä¸­ï¼ŒæŒ‚åœ¨BasicBlockä¸‹çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡éå†è¯­æ³•æ ‘ï¼Œå¹¶è°ƒç”¨ <code>toString()</code>æ–¹æ³•ï¼Œå³å¯ä»è¿™ä¸ªMulç±»ä¸­å–å‡ºç›®æ ‡ä»£ç </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mul</span> <span class="keyword">extends</span> <span class="title class_">ArithmeticInstruction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Mul</span><span class="params">(String name, BasicBlock parent, Value op1, Value op2)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name, parent, op1, op2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getArithmeticString(<span class="string">&quot;mul&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†ä¾‹å¦‚ï¼Œå¦‚ä¸‹ä¸­é—´ä»£ç ï¼Œå°†å…¶ç¿»è¯‘ä¸ºJavaä»£ç ï¼Œå¯ä»¥æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span> = mul i32 <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">%<span class="number">2</span> = mul i32 %<span class="number">1</span>, %<span class="number">1</span></span><br><span class="line"><span class="comment">// IrBuilder.buildxxxæ˜¯å°è£…äº†å…·ä½“æ“ä½œçš„å·¥å‚æ¨¡å¼æ–¹æ³•ï¼Œ</span></span><br><span class="line"><span class="comment">// å…¶å‚æ•°æ˜¯æ“ä½œæ•°Valueç±»ï¼Œè¿”å›ç»“æœæ˜¯è®¡ç®—ç»“æœInstructionç±»</span></span><br><span class="line"><span class="type">Mul</span> <span class="variable">mul1</span> <span class="operator">=</span> IrBuilder.buildMulInstruction(<span class="keyword">new</span> <span class="title class_">ConstInt</span>(<span class="number">1</span>), <span class="keyword">new</span> <span class="title class_">ConstInt</span>(<span class="number">1</span>))</span><br><span class="line"><span class="type">Mul</span> <span class="variable">mul2</span> <span class="operator">=</span> IrBuilder.buildMulInstruction(mul2, mul2)  </span><br></pre></td></tr></table></figure>

<p>å¸¸ç”¨çš„llvmæŒ‡ä»¤ç½—åˆ—å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>LLVM IR</th>
<th>ä½¿ç”¨æ–¹æ³•</th>
<th>ç®€ä»‹</th>
</tr>
</thead>
<tbody><tr>
<td><code>add</code></td>
<td><code>&lt;result&gt; = add &lt;ty&gt; &lt;op1&gt;, &lt;op2&gt;</code></td>
<td>&#x2F;</td>
</tr>
<tr>
<td><code>sub</code></td>
<td><code>&lt;result&gt; = sub &lt;ty&gt; &lt;op1&gt;, &lt;op2&gt;</code></td>
<td>&#x2F;</td>
</tr>
<tr>
<td><code>mul</code></td>
<td><code>&lt;result&gt; = mul &lt;ty&gt; &lt;op1&gt;, &lt;op2&gt;</code></td>
<td>&#x2F;</td>
</tr>
<tr>
<td><code>sdiv</code></td>
<td><code>&lt;result&gt; = sdiv &lt;ty&gt; &lt;op1&gt;, &lt;op2&gt;</code></td>
<td>æœ‰ç¬¦å·é™¤æ³•</td>
</tr>
<tr>
<td><code>srem</code></td>
<td><code>&lt;result&gt; = srem &lt;type&gt; &lt;op1&gt;, &lt;op2&gt;</code></td>
<td>æœ‰ç¬¦å·å–ä½™</td>
</tr>
<tr>
<td><code>icmp</code></td>
<td><code>&lt;result&gt; = icmp &lt;cond&gt; &lt;ty&gt; &lt;op1&gt;, &lt;op2&gt;</code></td>
<td>æ¯”è¾ƒæŒ‡ä»¤</td>
</tr>
<tr>
<td><code>and</code></td>
<td><code>&lt;result&gt; = and &lt;ty&gt; &lt;op1&gt;, &lt;op2&gt;</code></td>
<td>æŒ‰ä½ä¸</td>
</tr>
<tr>
<td><code>or</code></td>
<td><code>&lt;result&gt; = or &lt;ty&gt; &lt;op1&gt;, &lt;op2&gt;</code></td>
<td>æŒ‰ä½æˆ–</td>
</tr>
<tr>
<td><code>call</code></td>
<td><code>&lt;result&gt; = call [ret attrs] &lt;ty&gt; &lt;name&gt;(&lt;...args&gt;)</code></td>
<td>å‡½æ•°è°ƒç”¨</td>
</tr>
<tr>
<td><code>alloca</code></td>
<td><code>&lt;result&gt; = alloca &lt;type&gt;</code></td>
<td>åˆ†é…å†…å­˜</td>
</tr>
<tr>
<td><code>load</code></td>
<td><code>&lt;result&gt; = load &lt;ty&gt;, ptr &lt;pointer&gt;</code></td>
<td>è¯»å–å†…å­˜</td>
</tr>
<tr>
<td><code>store</code></td>
<td><code>store &lt;ty&gt; &lt;value&gt;, ptr &lt;pointer&gt;</code></td>
<td>å†™å†…å­˜</td>
</tr>
<tr>
<td><code>getelementptr</code></td>
<td><code>&lt;result&gt; = getelementptr &lt;ty&gt;, ptr &lt;ptrval&gt;&#123;, &lt;ty&gt; &lt;idx&gt;&#125;*</code></td>
<td>è®¡ç®—ç›®æ ‡å…ƒç´ çš„ä½ç½®ï¼ˆæ•°ç»„éƒ¨åˆ†ä¼šå•ç‹¬è¯¦ç»†è¯´æ˜ï¼‰</td>
</tr>
<tr>
<td><code>phi</code></td>
<td><code>&lt;result&gt; = phi [fast-math-flags] &lt;ty&gt; [&lt;val0&gt;, &lt;label0&gt;], ...</code></td>
<td>&#x2F;</td>
</tr>
<tr>
<td><code>zext..to</code></td>
<td><code>&lt;result&gt; = zext &lt;ty&gt; &lt;value&gt; to &lt;ty2&gt;</code></td>
<td>å°† <code>ty</code> çš„ <code>value</code> çš„ type æ‰©å……ä¸º <code>ty2</code>ï¼ˆzero extendï¼‰</td>
</tr>
<tr>
<td><code>trunc..to</code></td>
<td><code>&lt;result&gt; = trunc &lt;ty&gt; &lt;value&gt; to &lt;ty2&gt;</code></td>
<td>å°† <code>ty</code> çš„ <code>value</code> çš„ type ç¼©å‡ä¸º <code>ty2</code>ï¼ˆtruncateï¼‰</td>
</tr>
<tr>
<td><code>br</code></td>
<td><code>br i1 &lt;cond&gt;, label &lt;iftrue&gt;, label &lt;iffalse&gt;</code> <code>br label &lt;dest&gt;</code></td>
<td>æ”¹å˜æ§åˆ¶æµ</td>
</tr>
<tr>
<td><code>ret</code></td>
<td><code>ret &lt;type&gt; &lt;value&gt; </code>, <code>ret void</code></td>
<td>é€€å‡ºå½“å‰å‡½æ•°ï¼Œå¹¶è¿”å›å€¼</td>
</tr>
</tbody></table>
<p>æˆ‘åœ¨ LLVM IR å½“ä¸­ï¼Œç»™æ¯æ¡æŒ‡ä»¤éƒ½å†™äº†ä¸€ä¸ªç±»ï¼ˆBinary æŒ‡çš„æ˜¯è¯¸å¦‚ add sub mul è¿™æ ·çš„äºŒå…ƒæŒ‡ä»¤ï¼‰ï¼Œä¸ºäº†æ–¹ä¾¿æˆ‘å¯¹æ¯ç§ç±»å‹çš„æŒ‡ä»¤è¿›è¡Œç®¡ç†å’Œè¾“å‡ºã€‚</p>
<h5 id="ç‰¹æ®Šçš„Valueç±»ï¼šFunctionå’ŒBasicBlockç±»"><a href="#ç‰¹æ®Šçš„Valueç±»ï¼šFunctionå’ŒBasicBlockç±»" class="headerlink" title="ç‰¹æ®Šçš„Valueç±»ï¼šFunctionå’ŒBasicBlockç±»"></a>ç‰¹æ®Šçš„Valueç±»ï¼šFunctionå’ŒBasicBlockç±»</h5><p><code>Function</code>å’Œ <code>BasicBlock</code>ç±»ä¹Ÿå¯ä»¥ä½œä¸ºæ“ä½œæ•°ã€‚</p>
<p>ä¾‹å¦‚è°ƒç”¨æŒ‡ä»¤ï¼š<code>&lt;result&gt; = call [ret attrs] &lt;ty&gt; &lt;fnptrval&gt;(&lt;function args&gt;)</code>çš„å®ç°ä¸Šï¼Œæˆ‘ä»¬ç›´æ¥å°†functionä½œä¸ºäº†ä¸€ä¸ªæ“ä½œæ•°ï¼Œç”¨æ¥æ„å»ºCallæŒ‡ä»¤ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Function</span> <span class="variable">function</span> <span class="operator">=</span> (Function) IrSymbolTableStack.getSymbol(identToken.content);</span><br><span class="line">                <span class="keyword">assert</span> function != <span class="literal">null</span>;</span><br><span class="line">                ArrayList&lt;Value&gt; argRValues = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();  <span class="comment">// å®å‚åˆ—è¡¨</span></span><br><span class="line">IrFactory.synValue = IrBuilder.buildCallInstruction(function, argRValues, IrFactory.curBlock);</span><br><span class="line">                <span class="keyword">if</span> (IrFactory.synValue.getType() <span class="keyword">instanceof</span> CharType) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (IrFactory.synValue <span class="keyword">instanceof</span> ConstChar) &#123;</span><br><span class="line">                        IrFactory.synValue = <span class="keyword">new</span> <span class="title class_">ConstInt</span>(<span class="number">32</span>, ((ConstChar) IrFactory.synValue).getValue());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        IrFactory.synValue = IrBuilder.buildZextInstruction(IrFactory.synValue, IrFactory.curBlock);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<h5 id="æ ¹èŠ‚ç‚¹ï¼šModuleç±»"><a href="#æ ¹èŠ‚ç‚¹ï¼šModuleç±»" class="headerlink" title="æ ¹èŠ‚ç‚¹ï¼šModuleç±»"></a>æ ¹èŠ‚ç‚¹ï¼šModuleç±»</h5><p>å¦‚åŒç¼–è¯‘å•å…ƒä¸€æ ·çš„å­˜åœ¨ï¼ŒLLVM IR æ–‡ä»¶çš„åŸºæœ¬å•ä½ç§°ä¸º <code>module</code>ï¼Œæˆ‘ä»¬çš„å®éªŒåªæœ‰å• <code>module</code>ã€‚</p>
<h3 id="å†…å­˜-SSA"><a href="#å†…å­˜-SSA" class="headerlink" title="å†…å­˜ SSA"></a>å†…å­˜ SSA</h3><p>llvm æ˜¯ SSA å½¢å¼çš„ï¼Œä½†æ˜¯åœ¨æ²¡æœ‰ç»è¿‡ mem2reg çš„æ—¶å€™ï¼ŒSSA æ˜¯å†…å­˜å½¢å¼çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ¯ä¸ªå˜é‡ï¼Œåªè¦åœ¨å®šä¹‰ä»–çš„æ—¶å€™ï¼Œä¸ºä»–åœ¨å†…å­˜ä¸­åˆ’åˆ†ç©ºé—´å­˜å…¥ï¼Œåœ¨ä½¿ç”¨ä»–çš„æ—¶å€™åœ¨å–å‡ºæ¥ï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ° SSA çš„æ•ˆæœã€‚è¿™æ˜¯å› ä¸º SSA åªè¦æ±‚æˆ‘ä»¬ä¸èƒ½æ”¹å˜ä¸€ä¸ªå·²ç»å®šä¹‰çš„å€¼ï¼Œæ”¹å˜å†…å­˜çš„å†…å®¹æ˜¾ç„¶å¹¶ä¸è¿æ³• SSAã€‚</p>
<p>è¿™ä¼šå¯¼è‡´å½“æˆ‘ä»¬æåˆ°ï¼ˆä¹Ÿå°±æ˜¯æŸ¥è¯¢ï¼‰ä¸€ä¸ªå±€éƒ¨å˜é‡çš„æ—¶å€™ï¼Œå…¶å®æ˜¯ä»ç¬¦å·è¡¨ä¸­å–å‡ºæ¥çš„æ˜¯å®ƒçš„æŒ‡é’ˆï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸€èˆ¬å‘ç”Ÿåœ¨ <code>LVal</code>ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¼šå¯¹å˜é‡å¹²ä¸¤ä»¶äº‹æƒ…ï¼Œ<strong>è¯»å˜é‡</strong>å’Œ<strong>å†™å˜é‡</strong>å’Œ<strong>åšå®å‚</strong>ã€‚å¯¹äºè¯»å˜é‡ï¼Œä¸€èˆ¬å‘ç”Ÿåœ¨ <code>LVal</code> ä½œä¸º <code>PrimaryExp</code> çš„æ—¶å€™å‘ç”Ÿï¼Œæ­¤æ—¶éœ€è¦åœ¨ <code>PrimaryExp</code> ä¸­å¯¹å…¶è¿›è¡Œ <code>Load</code>ï¼Œè€Œå†™å˜é‡ä¸€èˆ¬å‘ç”Ÿåœ¨ <code>LVal</code> åœ¨ <code>AssignStmt</code> å’Œ <code>InStmt</code> ä¸­ï¼Œåªéœ€è¦ç”¨ <code>Store</code> å°†å…¶å†™å…¥å³å¯ã€‚åšå®å‚è¦å•ç‹¬æŒ‘å‡ºæ¥è®²ï¼Œæ˜¯å› ä¸ºå®ƒçš„é€»è¾‘æ˜¯ä¸ C éœ€è¦ä¿æŒä¸€è‡´çš„ï¼Œä»–æ˜¯æœ‰æŒ‡é’ˆç±»å‹çš„ï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬å¯¹ä»–è¿›è¡Œå•ç‹¬çš„å¤„ç†ã€‚è¿™å°±æ˜¯å†…å­˜å¼ SSA çš„åŸºæœ¬é€»è¾‘ã€‚</p>
<hr>
<h3 id="ç¬¦å·è¡¨"><a href="#ç¬¦å·è¡¨" class="headerlink" title="ç¬¦å·è¡¨"></a>ç¬¦å·è¡¨</h3><p>æ­£å¦‚å‰é¢æ‰€è¿°ï¼Œå› ä¸º LLVM IR æ˜¯ SSA å½¢å¼çš„ï¼Œæ‰€ä»¥ç¬¦å·è¡¨ä¸­å­˜çš„å†…å®¹ä¹Ÿå’Œ C ä¸­ç†è§£å¹¶ä¸ç›¸åŒï¼Œæ¯”å¦‚è¯´å¯¹äº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ C ä¸­ï¼Œæˆ‘ä»¬ä¼šè®¤ä¸º <code>a</code> åœ¨ç¬¦å·è¡¨ä¸­æ˜¯ä¸€ä¸ª <code>int</code>ï¼Œä½†æ˜¯åœ¨ llvm ä¸­ï¼Œä¸ºäº†æ»¡è¶³ SSA ï¼Œæ‰€ä»¥åœ¨ç¬¦å·è¡¨ä¸­ï¼Œ<code>a</code> ä¸­å¯¹åº”çš„æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>int</code> çš„æŒ‡é’ˆï¼Œå¦‚æœæƒ³è¦è·å¾— <code>a</code> ä¸­çš„å†…å®¹ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨ä¸€ä¸ª <code>load</code> æŒ‡ä»¤ ã€‚è¿™å°±é€ æˆäº†æŸç§é€»è¾‘çš„ä¸ä¸€è‡´æ€§ã€‚æ›´å¯æ‚²çš„æ˜¯ï¼ŒC ä¸­è¿˜æœ‰ <code>const</code> çš„æ¦‚å¿µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">f()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="type">int</span> b[a] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ˜¯ä¸æ˜¯å¯ä»¥ç›´æ¥ä¹Ÿç”¨ä¸€ä¸ªæŒ‡é’ˆå»å­˜ä»–ï¼Œç„¶åç”¨ä¸€ä¸ª <code>load</code> è®¿å­˜å‘¢ï¼Ÿå¤§æ¦‚æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºä¸‹é¢é‚£ä¸ªè¯­å¥ä¼šç”¨åˆ° <code>alloca</code>ï¼Œè™½ç„¶æˆ‘ä¸ç¡®å®š <code>alloca</code> æ˜¯å¦å¯ä»¥åŠ¨æ€åˆ†é…ï¼Œä½†æ˜¯å¦‚æœæ˜¯ä¸‹é¢è¿™ç§ï¼Œå°±è‚¯å®šä¸è¡Œäº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> a = <span class="number">3</span>;</span><br><span class="line"><span class="type">int</span> b[a] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">f()</span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å…¨å±€éƒ¨åˆ†æ˜¯æ²¡æœ‰åŠæ³•ä½¿ç”¨ <code>load</code> æŒ‡ä»¤çš„ï¼Œå°¤å…¶æ˜¯æˆ‘ä»¬ä¸€èˆ¬é¢å¯¹ä¸Šé¢çš„æƒ…å†µï¼Œä¼šè¦æ±‚æ±‚å‡º <code>b</code> çš„ç»´åº¦ä¿¡æ¯ï¼Œå¦‚æœç»´åº¦ä¿¡æ¯ä¸æ˜¯ <code>3</code> ï¼Œè€Œæ˜¯ä¸€ä¸ª <code>load</code>ï¼Œæ˜¾ç„¶å°±æ— æ³•æ±‚å‡ºäº†ï¼Œè¿™å°±å¯¼è‡´é¢å¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¿…é¡»å­˜ä¸€ä¸ªå¸¸é‡åˆ°ç¬¦å·è¡¨ä¸­ï¼Œè¿™å°±æ›´è¦æ±‚æˆ‘ä»¬åœ¨è§£æçš„æ—¶å€™ï¼ŒçŸ¥é“æˆ‘ä¹ˆä½ å•¥æ—¶å€™å­˜çš„æ˜¯å¸¸é‡ï¼Œå•¥æ—¶å€™å­˜çš„æ˜¯æŒ‡é’ˆï¼Œè¿™éœ€è¦é¢å¤–çš„ç»§æ‰¿å±æ€§ï¼ˆä¹Ÿæ˜¯æœ€é‡è¦çš„ç»§æ‰¿å±æ€§ï¼‰<code>canCalValueDown</code> ï¼Œå…¶å®è¿™ä¸ªå±æ€§æ„å‘³ç€ä¸€ç§**â€œå¸¸é‡è¯»â€**ã€‚</p>
<hr>
<h3 id="ç¬¦å·çš„å®šä¹‰"><a href="#ç¬¦å·çš„å®šä¹‰" class="headerlink" title="ç¬¦å·çš„å®šä¹‰"></a>ç¬¦å·çš„å®šä¹‰</h3><p>ç¬¦å·çš„å®šä¹‰æœ¬è´¨æ˜¯å¡«å†™ç¬¦å·è¡¨å’Œå®šä¹‰ï¼Œæˆ‘æœ¬æ¥æ‰“ç®—æ€»ç»“èµ·æ¥å†å†™ï¼Œä½†æ˜¯æ„Ÿè§‰å¤ªå†—æ‚äº†ï¼Œå¾ˆéš¾ç†å‡ºä¸€ä¸ªå¤´ç»ªï¼Œæ‰€ä»¥å°±å˜æˆäº†ç½—åˆ—ã€‚</p>
<h4 id="å…¨å±€å•å¸¸é‡"><a href="#å…¨å±€å•å¸¸é‡" class="headerlink" title="å…¨å±€å•å¸¸é‡"></a>å…¨å±€å•å¸¸é‡</h4><p>å¦‚æœæ˜¯ä¸€ä¸ªå•å¸¸é‡ï¼Œé‚£ä¹ˆåªéœ€è¦æŠŠ <code>ConstInitVal</code> æ±‚è§£å‡ºæ¥ï¼Œä¼šå¾—åˆ°ä¸€ä¸ª <code>int</code> ï¼Œç„¶ååœ¨ç¬¦å·è¡¨ä¸­ï¼Œåªéœ€è¦å­˜å‚¨ä¸€ä¸ª <code>ConstInt</code> å°±å¯ä»¥äº†ã€‚</p>
<h4 id="å±€éƒ¨å•å¸¸é‡"><a href="#å±€éƒ¨å•å¸¸é‡" class="headerlink" title="å±€éƒ¨å•å¸¸é‡"></a>å±€éƒ¨å•å¸¸é‡</h4><p>ä¸å…¨å±€å•å¸¸é‡ç›¸åŒï¼Œä¾ç„¶æ˜¯å°† <code>ConstInt</code> å­˜å…¥åˆ°ç¬¦å·è¡¨ä¸­ï¼Œå¹¶æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚</p>
<h4 id="å…¨å±€å¸¸é‡æ•°ç»„"><a href="#å…¨å±€å¸¸é‡æ•°ç»„" class="headerlink" title="å…¨å±€å¸¸é‡æ•°ç»„"></a>å…¨å±€å¸¸é‡æ•°ç»„</h4><p>å¯¹äºå¸¸é‡æ•°ç»„çš„åˆå§‹å€¼ï¼Œæˆ‘ä»¬è¦æ±‚æ˜¯å¯ä»¥åœ¨ç¼–è¯‘å™¨æ±‚å€¼çš„ï¼Œæ‰€ä»¥å®ƒçš„æ¯ä¸ªå…ƒç´ çš„åˆå§‹å€¼ä¸€å®šæ˜¯å¯ä»¥è¢«æ±‚å€¼çš„ï¼Œå½“æˆ‘ä»¬æ±‚å‡ºæ¥å®ƒçš„å€¼ä»¥åï¼Œæ²¡æœ‰åŠæ³•ç›´æ¥åœ¨ç¬¦å·è¡¨ä¸­å­˜å…¥å®ƒçš„å€¼ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¼šè¿›è¡Œç±»ä¼¼äºå˜é‡çš„è®¿é—®ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> a[<span class="number">2</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">2</span>;</span><br><span class="line">    a[i];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬æ˜¯æ²¡æœ‰åŠæ³•åœ¨ç¼–è¯‘æ—¶å°±æ±‚å‡º <code>a[i]</code> çš„ï¼Œæ‰€ä»¥ <code>a</code> å¿…é¡»æä¾›å˜é‡è®¿é—®å½¢å¼ï¼Œè¿™å°±è¦æ±‚ä»–å¿…é¡»è¢«å½“æˆä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ‰€ä»¥ä»–ç¡®å®æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæˆ‘ä»¬åœ¨ç¬¦å·è¡¨ä¸­å­˜å…¥çš„å…¶å®æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå› ä¸ºåœ¨ llvm ä¸­ï¼Œå…¨å±€å˜é‡æœ¬è´¨æ˜¯ä¸€ä¸ªæŒ‡å‘å…¶å†…å®¹çš„æŒ‡é’ˆï¼Œæ‰€ä»¥å…¶å®ç¬¦å·è¡¨ä¸­å­˜å…¥çš„æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚ä½†æ˜¯ä¹Ÿéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå…¶å®ç¬¦å·è¡¨ä¸­ <code>a</code> è¿™ä¸ªä¸œè¥¿å¯¹åº”äº†ä¸¤ä¸ª <code>Value</code> ï¼Œä¸€ä¸ªæ˜¯ <code>GlobalVariable</code> ï¼Œå¦ä¸€ä¸ªæ˜¯ <code>GlobalVariable.getInitValue()</code> è·å¾—çš„ <code>ConstArray</code> ï¼Œè¿™æ ·æ˜¯æå…¶æœ‰å¿…è¦çš„ï¼Œå› ä¸ºå¯¹äºè¿™ç§æƒ…å†µ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> a[<span class="number">2</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> b = a[<span class="number">1</span>];</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">2</span>;</span><br><span class="line">    a[i];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>b</code> çš„åˆå§‹å€¼æ²¡æ³•ä½¿ç”¨ <code>load</code> è®¿é—®ï¼Œæ‰€ä»¥åªèƒ½ç”¨å¸¸é‡å½¢å¼è·å¾—ï¼Œæ‰€ä»¥ä¾ç„¶æ˜¯éœ€è¦ <code>ConstArray</code> çš„ã€‚</p>
<h4 id="å±€éƒ¨å¸¸é‡æ•°ç»„"><a href="#å±€éƒ¨å¸¸é‡æ•°ç»„" class="headerlink" title="å±€éƒ¨å¸¸é‡æ•°ç»„"></a>å±€éƒ¨å¸¸é‡æ•°ç»„</h4><p>å±€éƒ¨å¸¸é‡æ•°ç»„ä¸å…¨å±€å¸¸é‡æ•°ç»„ç±»ä¼¼ï¼Œå› ä¸ºå®ƒä¹Ÿå…·æœ‰â€œå˜é‡â€çš„è®¿é—®å½¢å¼ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½ä»…ä»…åœ¨ç¬¦å·è¡¨ä¸­å­˜å…¥ä¸€ä¸ª <code>ConstArray</code>ï¼Œè€Œæ˜¯éœ€è¦åˆ©ç”¨ <code>Alloca</code> åˆ†é…ä¸€å—å†…å­˜ï¼Œç„¶ååˆ©ç”¨ <code>gep, store</code> ï¼ˆè¿™ä¹ˆçœ‹æ¯”å…¨å±€å¸¸é‡æ•°ç»„è¿˜æœ‰éº»çƒ¦ä¸€äº›ï¼‰å°†è¿™ç‰‡å†…å­˜å¡«å†™æˆæ­£ç¡®çš„å€¼ã€‚åŒæ—¶ä¾ç„¶éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åœ¨ <code>Alloca</code> é‡Œé¢å­˜å…¥ä¸€ä¸ª <code>ConstArray</code> çš„ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¾ç„¶éœ€è¦åƒä¸€ä¸ªâ€œå¸¸é‡â€ä¸€æ ·è¯»å–è¿™ä¸ªå±€éƒ¨å¸¸é‡æ•°ç»„ï¼Œæ¯”å¦‚è¯´åœ¨ä¸€äº›å¸¸é‡åˆå§‹åŒ–æˆ–è€…ç»´åº¦ä¿¡æ¯æ–¹é¢ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦å­˜å…¥ <code>ConstArray</code> çš„ã€‚</p>
<h4 id="å…¨å±€å•å˜é‡"><a href="#å…¨å±€å•å˜é‡" class="headerlink" title="å…¨å±€å•å˜é‡"></a>å…¨å±€å•å˜é‡</h4><p>éœ€è¦å½“æˆä¸€ä¸ª <code>GlobalVariable</code> å¤„ç†ï¼Œè¿™æ˜¯å› ä¸ºå¿…é¡»ç»™è¿™ä¸ªå•å˜é‡å¼€è¾Ÿç©ºé—´ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æœ‰å¯èƒ½ä¿®æ”¹è¿™ä¸ªå€¼ã€‚</p>
<h4 id="å…¨å±€å˜é‡æ•°ç»„"><a href="#å…¨å±€å˜é‡æ•°ç»„" class="headerlink" title="å…¨å±€å˜é‡æ•°ç»„"></a>å…¨å±€å˜é‡æ•°ç»„</h4><p>ä¹Ÿéœ€è¦å½“æˆä¸€ä¸ª <code>GlobalVariable</code> å¤„ç†ï¼Œä¼¼ä¹è¿™é‡Œä¿è¯äº†åˆå§‹å€¼ä¸€å®šæ˜¯å¸¸é‡ã€‚</p>
<blockquote>
<p>å…¨å±€å˜é‡å£°æ˜ä¸­æŒ‡å®šçš„åˆå€¼è¡¨è¾¾å¼å¿…é¡»æ˜¯å¸¸é‡è¡¨è¾¾å¼ã€‚</p>
</blockquote>
<h4 id="å±€éƒ¨å•å˜é‡"><a href="#å±€éƒ¨å•å˜é‡" class="headerlink" title="å±€éƒ¨å•å˜é‡"></a>å±€éƒ¨å•å˜é‡</h4><p>ç”¨ <code>Alloca</code> å¤„ç†ï¼Œæœ€ååœ¨ç¬¦å·è¡¨ä¸­å­˜å…¥çš„æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚</p>
<h4 id="å±€éƒ¨å˜é‡æ•°ç»„"><a href="#å±€éƒ¨å˜é‡æ•°ç»„" class="headerlink" title="å±€éƒ¨å˜é‡æ•°ç»„"></a>å±€éƒ¨å˜é‡æ•°ç»„</h4><p>ç”¨ <code>Alloca</code> å¤„ç†ï¼Œä½†æ˜¯æ­¤æ—¶çš„ <code>Alloca</code> æ˜¯ä¸éœ€è¦åƒå±€éƒ¨å¸¸é‡æ•°ç»„ä¸€æ ·åœ¨é‡Œé¢å­˜å‚¨ä¸€ä¸ª <code>ConstArray</code> çš„ï¼Œè¿™æ˜¯å› ä¸ºç¬¬ä¸€æ²¡æœ‰æ„ä¹‰ï¼Œç¬¬äºŒä¸ä¸€å®šèƒ½åŠåˆ°ã€‚</p>
<hr>
<h3 id="ç¬¦å·çš„ä½¿ç”¨"><a href="#ç¬¦å·çš„ä½¿ç”¨" class="headerlink" title="ç¬¦å·çš„ä½¿ç”¨"></a>ç¬¦å·çš„ä½¿ç”¨</h3><h4 id="å†™å˜é‡"><a href="#å†™å˜é‡" class="headerlink" title="å†™å˜é‡"></a>å†™å˜é‡</h4><p>å†™ä¸€ä¸ªå˜é‡ä¸€èˆ¬éƒ½æ˜¯å¯¹äº <code>LVal</code> è¿›è¡Œæ“ä½œï¼Œå¹¶ä¸æ˜¯å¯ä»¥å†™å†…å­˜ä¸­çš„æ‰€æœ‰ä¸œè¥¿ï¼Œè¿™æ˜¯å› ä¸ºå¸¸é‡æ˜¯ä¸å…è®¸å†™æ“ä½œçš„ï¼Œæ‰€ä»¥å¯¹äº <code>LVal</code> è·å¾—çš„ä¸œè¥¿ä¸€å®šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ˆ<code>LVal</code> çš„æœ¬è´¨å°±æ˜¯åœ¨ç¬¦å·è¡¨ä¸­æŒ‰ç…§ç¬¦å·æŸ¥è¯¢å‡ºå¯¹åº”çš„ <code>Value</code> ï¼‰ï¼Œç„¶ååˆ©ç”¨ <code>Store</code> æŒ‡ä»¤å°±å¯ä»¥å°†å†…å®¹å†™å…¥ï¼Œâ€œå†™å˜é‡â€è¿™ä¸ªè¿‡ç¨‹æœ¬èº«ååˆ†ç®€å•ã€‚</p>
<p>æ¯”è¾ƒå¤æ‚çš„æ˜¯å¦‚ä½•å¤„ç† <code>LVal</code> ï¼Œé¦–å…ˆéœ€è¦æ˜ç™½ï¼Œå¯¹äº <code>LVal.builIr</code> å¯ä»¥å°†å…¶åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ <code>canCalValue</code> ï¼Œä¹Ÿå°±æ˜¯å¸¸é‡å½¢å¼çš„è¯»ï¼ˆæ˜¾ç„¶æ²¡æœ‰å¸¸é‡å†™ï¼‰ï¼Œå¦å¤–å°±æ˜¯æ²¡æœ‰åŠæ³•å¸¸é‡è¯»çš„ <code>build</code>ï¼Œå¯¹äºç¬¬äºŒç§æƒ…å†µï¼Œé™¤äº†åœ¨ç¬¦å·è¡¨ä¸­æ‰¾åˆ°æ‰¾åˆ°æŒ‡é’ˆï¼Œå¯¹äºæ•°ç»„æŒ‡é’ˆï¼Œè¿˜æ¶‰åŠä¸€äº› <code>gep</code> æ“ä½œä»¥æ‰¾åˆ°æ­£ç¡®çš„æ•°ç»„å…ƒç´ ã€‚</p>
<h4 id="è¯»å˜é‡"><a href="#è¯»å˜é‡" class="headerlink" title="è¯»å˜é‡"></a>è¯»å˜é‡</h4><h5 id="è¯»å˜é‡ç”¨äºè¡¨è¾¾å¼"><a href="#è¯»å˜é‡ç”¨äºè¡¨è¾¾å¼" class="headerlink" title="è¯»å˜é‡ç”¨äºè¡¨è¾¾å¼"></a>è¯»å˜é‡ç”¨äºè¡¨è¾¾å¼</h5><p>å½“ä¸€ä¸ª <code>LVal</code> ç”¨äºè¡¨è¾¾å¼çš„æ—¶å€™ï¼ˆä¹Ÿå°±æ˜¯å‚ä¸è¿ç®—çš„æ—¶å€™ï¼‰ï¼Œå¯ä»¥åˆ†æˆä¸¤ä¸ªæƒ…å†µè®¨è®ºï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œé‚£ä¹ˆå°±ç›´æ¥ç”¨å°±è¡Œäº†ï¼›å¦‚æœæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆå°±éœ€è¦å°†å…¶ <code>Load</code> å‡ºæ¥ä½¿ç”¨ã€‚</p>
<h5 id="è¯»å˜é‡ç”¨äºå®å‚"><a href="#è¯»å˜é‡ç”¨äºå®å‚" class="headerlink" title="è¯»å˜é‡ç”¨äºå®å‚"></a>è¯»å˜é‡ç”¨äºå®å‚</h5><p>å®å‚å’Œè¡¨è¾¾å¼è®¡ç®—ä¸åŒåœ¨äºï¼Œä»–å¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚è€Œå› ä¸º C çš„æŒ‡é’ˆä¸ llvm æ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚è¯´åŒæ ·ä¸€ä¸ªä¸€ç»´æ•°ç»„ <code>a[2]</code> ï¼Œåœ¨ C ä¸­ä¸º <code>int*</code> ï¼Œè€Œåœ¨ llvm ä¸­ï¼Œå´æ˜¯ <code>[2 x i32]*</code> ã€‚è€Œå½“å‚æ•°ä¸º <code>int a[]</code> çš„æ—¶å€™ï¼Œåˆè¦æ±‚ llvm åˆ’ä¸º <code>int*</code>ï¼Œè¿™å°±è¯´éœ€è¦æ§åˆ¶ <code>gep</code> çš„æ•°é‡è¿›è¡Œé™ç»´ï¼ŒåŒæ—¶å¯¹äºä¸ºæŒ‡é’ˆçš„å˜é‡ï¼Œä¹Ÿä¸èƒ½ä¸€å‘³çš„ <code>load</code>ï¼Œè¿™æ ·æœ‰å¯èƒ½å°†åŸæœ¬çš„æŒ‡é’ˆå®å‚ç»™ <code>Load</code> å‡ºä¸€ä¸ªæ•´å‹æ¥ã€‚</p>
<hr>
<h3 id="çŸ­è·¯æ±‚å€¼"><a href="#çŸ­è·¯æ±‚å€¼" class="headerlink" title="çŸ­è·¯æ±‚å€¼"></a>çŸ­è·¯æ±‚å€¼</h3><p>å¯¹äºçŸ­è·¯æ±‚å€¼ï¼Œå¹¶ä¸æ˜¯ä¸€ä»¶å¯æœ‰å¯æ— çš„äº‹æƒ…ï¼Œå› ä¸ºå¯¹äº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="number">1</span> == <span class="number">2</span> &amp;&amp; f()) </span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ²¡æœ‰çŸ­è·¯æ±‚å€¼ï¼Œé‚£ä¹ˆ <code>f()</code> å°±ä¼šè¢«æŒ‡ä»¤ï¼Œå¦‚æœ <code>f()</code> æ˜¯ä¸€ä¸ªæœ‰å‰¯ä½œç”¨çš„å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯å¯¹å†…å­˜å†™äº†ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´ bug çš„å‡ºç°ï¼Œæ‰€ä»¥çŸ­è·¯æ±‚å€¼æ˜¯å¿…è¦çš„ã€‚</p>
<p>å®ç°çŸ­è·¯æ±‚å€¼å°±æ˜¯å°†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cond1 &amp;&amp; cond2)</span><br></pre></td></tr></table></figure>

<p>å˜æˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cond1)</span><br><span class="line">	<span class="keyword">if</span> (cond2)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çš„ç»“æ„ï¼Œå°†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cond1 || cond2)</span><br></pre></td></tr></table></figure>

<p>å˜æˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cond1) &#123;</span><br><span class="line">    <span class="comment">// then-block</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cond2) &#123;</span><br><span class="line">        <span class="comment">// then-block</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// else-block</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºå¤šä¸ªæ¡ä»¶ï¼Œåªè¦ç¡®å®šå¥½ä¼˜å…ˆçº§ï¼Œé€’å½’å¤„ç†å³å¯ã€‚</p>
<hr>
<h3 id="æ§åˆ¶ç»“æ„"><a href="#æ§åˆ¶ç»“æ„" class="headerlink" title="æ§åˆ¶ç»“æ„"></a>æ§åˆ¶ç»“æ„</h3><p>æ§åˆ¶ç»“æ„å°±æ˜¯é€šè¿‡åˆ¶é€  <code>BasicBlock</code> æ¥å¯¹æ•°æ®æµè¿›è¡Œæ§åˆ¶ã€‚</p>
<h4 id="åˆ†æ”¯"><a href="#åˆ†æ”¯" class="headerlink" title="åˆ†æ”¯"></a>åˆ†æ”¯</h4><p><code>ConditionNode</code> æœ‰ä¸¤ç§å¯èƒ½ï¼Œæœ‰æ—  <code>else</code> å†³å®šäº†åˆ°åº•æ˜¯ 2 ä¸ª <code>BasicBlock</code> æˆ–è€…æ˜¯ 3 ä¸ª <code>BasicBlock</code>ã€‚å¯¹äºæ²¡æœ‰ <code>else</code> çš„åˆ†æ”¯ç»“æ„ï¼Œåªç”¨ä¸€ä¸ªä¸‰å‚æ•°çš„ <code>Br</code> å°±å¯ä»¥è§£å†³ï¼Œå¯¹äºæœ‰ <code>else</code> çš„ç»“æ„ï¼Œåªéœ€è¦å°† <code>Br</code> çš„ <code>falseBlock</code> è°ƒæ•´ä¸º <code>else</code> å¯¹åº”çš„å—å³å¯ã€‚</p>
<h4 id="å¾ªç¯"><a href="#å¾ªç¯" class="headerlink" title="å¾ªç¯"></a>å¾ªç¯</h4><p>éœ€è¦åˆ¶ä½œå‡º 3 ä¸ªå—ï¼Œåˆ†åˆ«ä¸º <code>condBlock, bodyBlock, nextBlock</code> ï¼Œå…¶ä¸­ <code>condBlock</code> é€‰æ‹©è·³è½¬åˆ° <code>bodyBlock</code> æˆ–è€…æ˜¯ <code>nextBlock</code> ï¼ˆè¿™ä¸ªéƒ¨åˆ†ç”± <code>LOrExp, LAndExp</code> è‡ªåŠ¨å®Œæˆ ï¼‰ï¼Œ<code>bodyBlock</code> ä¼šæ— æ¡ä»¶è·³è½¬åˆ° <code>condBlock</code>ã€‚</p>
<h4 id="Break-Continue-Return"><a href="#Break-Continue-Return" class="headerlink" title="Break &amp; Continue &amp; Return"></a>Break &amp; Continue &amp; Return</h4><p>è¿™äº›æŒ‡ä»¤é¢å¯¹çš„æœ€å¤§é—®é¢˜æ˜¯ä¸ºäº†æ»¡è¶³åŸºæœ¬å—çš„å®šä¹‰ï¼Œä¸è¿™äº›æŒ‡ä»¤æ‰€å¤„åŒä¸€åŸºæœ¬å—å¹¶ä½äºè¿™äº›æŒ‡ä»¤ä¹‹åçš„æŒ‡ä»¤ä¸åº”è¯¥å¾—åˆ°ç¿»è¯‘ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥åšä¸€ä¸ªæ–°çš„å—ï¼Œè®©å…¶åçš„æŒ‡ä»¤éƒ½ä¾é™„ä¸è¿™ä¸ªå—ï¼Œè€Œå…¥å£å—å¹¶æ²¡æœ‰åˆ°è¾¾è¿™ä¸ªå—çš„æ–¹å¼ï¼Œè¿™æ ·å°±å®Œæˆäº†å¯¹å…¶åæŒ‡ä»¤çš„å¿½ç•¥ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>break, continue</code> éƒ½éœ€è¦ç¡®å®šè·³è½¬çš„ç›®æ ‡ï¼Œ<code>break</code> ä¼šè·³è½¬åˆ° <code>nextBlock</code> ï¼Œè€Œ <code>continue</code> ä¼šè·³è½¬åˆ° <code>condBlock</code> ï¼Œä½†æ˜¯å› ä¸ºå¾ªç¯å­˜åœ¨åµŒå¥—ç»“æ„ï¼Œæ‰€ä»¥ä¸åŒå±‚çš„ <code>break, continue</code> éœ€è¦è·³è½¬åˆ°ä¸åŒçš„å±‚ã€‚æ‰€ä»¥åœ¨å…¨å±€ç”¨ä¸€ä¸ªæ ˆç»´æŠ¤è¯¥ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å¤šé‡å¾ªç¯ä¸­çš„continueï¼Œ</span></span><br><span class="line"><span class="comment">     * æ ˆé¡¶çš„loopEndBlockå³æ˜¯å½“å‰å±‚Continueè·³è½¬çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Stack&lt;BasicBlock&gt; loopEndBlockStack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å¤šæ¬¡å¾ªç¯ä¸­çš„break</span></span><br><span class="line"><span class="comment">     * æ ˆé¡¶çš„endBlockå³æ˜¯å½“å‰å±‚breakè·³è½¬çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Stack&lt;BasicBlock&gt; endBlockStack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨å¾ªç¯çš„æ—¶å€™ï¼Œè¿›è¡Œå‡ºå…¥æ ˆæ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">IrFactory.loopEndBlockStack.push(loopEndBlock);</span><br><span class="line">        IrFactory.endBlockStack.push(endBlock);</span><br><span class="line">        <span class="comment">// è§£æStmt</span></span><br><span class="line">        ((StmtNode) nodes.get(nodePos)).setStmtReturnType(<span class="built_in">this</span>.stmtReturnType);</span><br><span class="line">        nodes.get(nodePos).buildIr();</span><br><span class="line">        <span class="comment">// å®Œæˆå½“å‰è§£æï¼Œå¼¹æ ˆ</span></span><br><span class="line">        IrFactory.loopEndBlockStack.pop();</span><br><span class="line">        IrFactory.endBlockStack.pop();</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>break</code> ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼ºåˆ¶è·³è½¬è‡³endBlock</span></span><br><span class="line">        IrBuilder.buildBrInstruction(IrFactory.endBlockStack.peek(), IrFactory.curBlock);</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>continue</code> ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼ºåˆ¶è·³è½¬è‡³endLoopBlock</span></span><br><span class="line">        IrBuilder.buildBrInstruction(IrFactory.loopEndBlockStack.peek(), IrFactory.curBlock);</span><br></pre></td></tr></table></figure>

<h3 id="å…·ä½“æ¶æ„è®¾è®¡"><a href="#å…·ä½“æ¶æ„è®¾è®¡" class="headerlink" title="å…·ä½“æ¶æ„è®¾è®¡"></a>å…·ä½“æ¶æ„è®¾è®¡</h3><h4 id="IrBuilderç±»ï¼šæŒ‡ä»¤çš„å·¥å‚"><a href="#IrBuilderç±»ï¼šæŒ‡ä»¤çš„å·¥å‚" class="headerlink" title="IrBuilderç±»ï¼šæŒ‡ä»¤çš„å·¥å‚"></a>IrBuilderç±»ï¼šæŒ‡ä»¤çš„å·¥å‚</h4><p>IrBuilderç±»æ˜¯ä¸­é—´ä»£ç çš„å…¥å£ï¼ŒåŒæ—¶ä¹Ÿ<strong>å°è£…æœ‰æ„å»º <code>llvm</code>å…ƒç´ çš„å·¥å‚æ¨¡å¼æ–¹æ³•</strong>ã€‚</p>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬ç°åœ¨æ­£è¦å–å‡ºä¸€ä¸ªæŒ‡é’ˆç±»å‹å˜é‡æ‰€æŒ‡ç©ºé—´ä¸­çš„å†…å®¹ï¼Œå¯ä»¥æ„å»ºä¸€æ¡ <code>Load</code>æŒ‡ä»¤ï¼ˆå½“ç„¶å¦‚æœæ˜¯æ•°ç»„å°±éœ€è¦GEPæŒ‡ä»¤äº†ï¼‰ï¼Œå¹¶å°†å…¶æ’å…¥å½“å‰æ‰€å¤„çš„åŸºæœ¬å—ã€‚å¯ä»¥å¦‚æ­¤åšï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LValNode.javaï¼Œå…¶å¯¹åº”æ–‡æ³•LVal â†’ Ident &#123;&#x27;[&#x27; Exp &#x27;]&#x27;&#125;ï¼Œæ˜¯æŒ‡é’ˆçš„å‘ç¥¥åœ°</span></span><br><span class="line"><span class="type">Value</span> <span class="variable">fParamValue</span> <span class="operator">=</span> IrBuilder.buildLoadInstruction(lvalValue, IrFactory.curBlock);</span><br><span class="line">                <span class="keyword">if</span> (expNode == <span class="literal">null</span>) &#123;</span><br><span class="line">                    IrFactory.synValue = fParamValue;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    expNode.buildIr();</span><br><span class="line">                    <span class="keyword">if</span> (IrFactory.synValue.getType() <span class="keyword">instanceof</span> CharType) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (IrFactory.synValue <span class="keyword">instanceof</span> ConstChar) &#123;</span><br><span class="line">                            IrFactory.synValue = <span class="keyword">new</span> <span class="title class_">ConstInt</span>(<span class="number">32</span>, ((ConstChar) IrFactory.synValue).getValue());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            IrFactory.synValue = IrBuilder.buildZextInstruction(IrFactory.synValue, IrFactory.curBlock);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">Value</span> <span class="variable">indexValue</span> <span class="operator">=</span> IrFactory.synValue;</span><br><span class="line"></span><br><span class="line">                    <span class="type">Value</span> <span class="variable">ptrVal</span> <span class="operator">=</span> IrBuilder.buildGetElementPtrInstruction(fParamValue, indexValue, IrFactory.curBlock);</span><br><span class="line">                    <span class="keyword">if</span> (IrUtil.getPointingTypeOfPointer(fParamValue) <span class="keyword">instanceof</span> ArrayType) &#123;</span><br><span class="line">                        <span class="comment">// System.out.println(&quot;can&#x27;t delete&quot;);</span></span><br><span class="line">                        ptrVal = IrBuilder.buildRankDownInstruction(ptrVal, IrFactory.curBlock);</span><br><span class="line">                    &#125;</span><br><span class="line">                    IrFactory.synValue = ptrVal;</span><br><span class="line"><span class="comment">// IrBuilder.java</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ„å»ºåŠ è½½æŒ‡ä»¤</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pointer è¦åŠ è½½çš„åœ°å€ï¼Œä»è¿™ä¸ªåœ°å€å¤„è¯»å–æ“ä½œæ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å®ŒæˆåŠ è½½çš„Value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Load <span class="title function_">buildLoadInstruction</span><span class="params">(Value pointer, BasicBlock parent)</span> &#123;</span><br><span class="line">        <span class="type">Load</span> <span class="variable">load</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Load</span>(getName(), parent, pointer);</span><br><span class="line">        parent.addInstruction(load);</span><br><span class="line">        <span class="keyword">return</span> load;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="IrFactoryï¼šé€’å½’ä¸‹é™çš„ä¸Šä¸‹æ–‡ä¿¡æ¯"><a href="#IrFactoryï¼šé€’å½’ä¸‹é™çš„ä¸Šä¸‹æ–‡ä¿¡æ¯" class="headerlink" title="IrFactoryï¼šé€’å½’ä¸‹é™çš„ä¸Šä¸‹æ–‡ä¿¡æ¯"></a>IrFactoryï¼šé€’å½’ä¸‹é™çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</h4><p>åˆšåˆšæˆ‘ä»¬æåˆ°ï¼Œè¦è¿›è¡ŒåŸºäºå±æ€§ç¿»è¯‘æ–‡æ³•çš„é€’å½’ä¸‹é™ã€‚æ—¢ç„¶æ˜¯å±æ€§ç¿»è¯‘æ–‡æ³•ï¼ŒåŠ¿å¿…æ¶‰åŠåˆ°<strong>ç»¼åˆå±æ€§ï¼ˆ<code>synthesized attribute</code>)çš„å‘ä¸Šä¼ é€’</strong>ï¼Œä»¥åŠ<strong>ç»§æ‰¿å±æ€§ï¼ˆ<code>inherited attribute</code>ï¼‰çš„å‘ä¸‹ä¼ é€’</strong>ã€‚</p>
<p>å¾—ç›Šäºé€’å½’ä¸‹é™çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ <code>node</code>ç±»å†…ï¼Œé€šè¿‡çˆ¶å­ <code>node</code>é—´ç›´æ¥è°ƒç”¨å¯¹æ–¹çš„ç›¸å…³ <code>setter</code>æˆ–è€… <code>getter</code>æ¥ç²—æš´åœ°å®ç°ä¿¡æ¯ä¼ é€’ã€‚</p>
<p>ä½†å¦‚æœæˆ‘ä»¬ä¼ é€’çš„é“¾æ¡å¾ˆé•¿å‘¢ï¼Ÿè­¬å¦‚æˆ‘ä»¬åœ¨ä¸€ä¸ª <code>LVal</code>å†…çš„ä¿¡æ¯ï¼Œè¦ç»è¿‡å¥½é•¿å¥½é•¿çš„è·¯ï¼Œæ‰èƒ½æŠµè¾¾çœŸæ­£éœ€è¦è¯¥ä¿¡æ¯çš„ <code>ConstExp</code>ï¼Œè¿™æ—¶å€™å¦‚æœè¿˜è¦å†™é‚£ä¹ˆå¤š <code>setter</code>ï¼Œæœªå…ä¹Ÿè¿‡äºç¬¨ã€‚</p>
<p>è€ƒè™‘åˆ°åªæœ‰ç»¼åˆå±æ€§ä¼šå‡ºç°è¿™ç§é•¿çº¿çš„ä¼ é€’ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>Irc</code>é‡Œç›´æ¥è®°å½•å…¨å±€çš„ï¼Œæ­£åœ¨ä¼ é€’çš„ç»¼åˆå±æ€§ï¼ˆä»¬ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//=========================== ç»¼åˆå±æ€§ =================================</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Valueç±»å‹åˆ—è¡¨çš„ç»¼åˆå±æ€§ upå‘ä¸Šä¼ é€’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ArrayList&lt;Value&gt; synValueArray = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Valueç±»å‹çš„ç»¼åˆå±æ€§ upå‘ä¸Šä¼ é€’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Value</span> <span class="variable">synValue</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * intç±»å‹çš„ç»¼åˆå±æ€§ upå‘ä¸Šä¼ é€’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">synInt</span> <span class="operator">=</span> -<span class="number">114514</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ä¸­é—´ä»£ç çš„æ„å»ºè¿‡ç¨‹ï¼Œæ˜¯å­—é¢æ„ä¹‰ä¸Šæ‹†ä¸œå¢™å»ºè¥¿å¢™çš„è¿‡ç¨‹ï¼Œå³åœ¨æ ¹æ®æ–‡æ³•é€’å½’ä¸‹é™ æ‰«æè¯­æ³•åˆ†æç»“æœçš„åŒæ—¶ï¼Œåœ¨å¦ä¸€è¾¹é€æ­¥ï¼ˆç”¨åŠ¨ä½œç¬¦å·ï¼‰æ­å»ºèµ·å¦ä¸€ä¸ª <code>llvm</code>çš„ä½“ç³»ã€‚</strong></p>
<p>æ—¢ç„¶æ˜¯åŒæ­¥åœ¨æ‰«æä¸¤ä¸ªä½“ç³»ï¼Œå°±åº”å½“æœ‰ä¸¤ç»„æŒ‡é’ˆæ¥è®°å½•æ‰«æè¿›åº¦ã€‚<strong>è¯­æ³•åˆ†æçš„æ‰«æè¿›åº¦ï¼ˆç”±é€’å½’ä¸‹é™ä¿è¯å¤–ï¼Œè¿˜æœ‰å½“å‰æ˜¯å¦åœ¨æ‰«æå¸¸é‡è¡¨è¾¾å¼ï¼Œæ˜¯å¦åœ¨æ‰«æå‡½æ•°å®å‚ï¼Œæ˜¯å¦æ­£åœ¨ç»å†å¾ªç¯ï¼‰ï¼Œ<code>llvm</code>çš„æ„å»ºè¿›åº¦ï¼ˆå³å½“å‰åœ¨æ­å»ºå“ªä¸ªå‡½æ•°ï¼Œå“ªä¸ªåŸºæœ¬å—ï¼Œï¼‰éƒ½åº”å½“å¾—åˆ°è®°å½•</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰æ‰€åœ¨åŸºæœ¬å—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">BasicBlock</span> <span class="variable">curBlock</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰æ‰€åœ¨å‡½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Function</span> <span class="variable">curFunction</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰æ˜¯å¦æ­£åœ¨è®¡ç®— æ— å˜é‡å¸¸æ•°è¡¨è¾¾å¼</span></span><br><span class="line"><span class="comment">     * å¦‚æœæ˜¯ï¼Œé‚£ä¹ˆç»¼åˆå±æ€§åªéœ€è¦ä¼ é€’synIntï¼Œä¸”è®¡ç®—æƒ…å†µæœ‰æ‰€å‡å°‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">isBuildingConstExp</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰æ˜¯å¦åœ¨è¿›è¡Œå…¨å±€å˜é‡çš„åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">isBuildingGlobalInit</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰æ˜¯å¦æ­£åœ¨æ„å»ºä¸€ä¸ªintç±»å‹çš„å®å‚</span></span><br><span class="line"><span class="comment">     * å¦‚æœæ˜¯ï¼Œä½†æ˜¯å½“å‰è§£æåˆ°çš„å´æ˜¯int*ç±»å‹ï¼Œé‚£ä¹ˆéœ€è¦load</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">isBuildingPointerRParam</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å¤šé‡å¾ªç¯ä¸­çš„continueï¼Œ</span></span><br><span class="line"><span class="comment">     * æ ˆé¡¶çš„loopEndBlockå³æ˜¯å½“å‰å±‚Continueè·³è½¬çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Stack&lt;BasicBlock&gt; loopEndBlockStack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å¤šæ¬¡å¾ªç¯ä¸­çš„break</span></span><br><span class="line"><span class="comment">     * æ ˆé¡¶çš„endBlockå³æ˜¯å½“å‰å±‚breakè·³è½¬çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Stack&lt;BasicBlock&gt; endBlockStack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<h4 id="llvmå…ƒç´ "><a href="#llvmå…ƒç´ " class="headerlink" title="llvmå…ƒç´ "></a><code>llvm</code>å…ƒç´ </h4><p><code>llvm</code>å…ƒç´ ä¸»è¦æ”¾ç½®åœ¨ <code>ir/values</code>å†…ã€‚</p>
<p>è¯¥ç±»ä¸»è¦å­˜å‚¨äº† <code>llvm</code>ä½“ç³»ä¸‹ï¼Œè¯¥å…ƒç´ çš„è¦ç´ åŠå…¶ç›¸åº”çš„ <code>getter</code>å’Œ <code>setter</code>ã€‚</p>
<p>æ­¤å¤–ï¼Œæ‰€æœ‰ <code>llvm</code>å…ƒç´ éƒ½å®ç°äº† <code>buildMips()</code>æ–¹æ³•ï¼ˆåŠè¾…åŠ©æ–¹æ³•ï¼‰ï¼Œç”¨äºåç»­æ„å»º <code>mips</code>ä½“ç³»ã€‚</p>
<p>å› æ­¤ï¼Œ<strong><code>llvm</code>å…ƒç´ ç±»æ˜¯è´¯ç©¿äº† <code>llvm</code>åˆæ­¥ç”Ÿæˆï¼Œä¸­ç«¯çš„ <code>mem2reg</code>é‡æ„ï¼Œ<code>mips</code>åˆæ­¥ç”Ÿæˆ</strong>çš„é‡è¦ç±»ã€‚</p>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨åŸºæœ¬å— <code>BasicBlock</code>ç±»å†…ï¼Œä¼šè®°å½•è¿™æ ·çš„ä¸€äº›ä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‰é©±ä¸åç»§å—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;BasicBlock&gt; preBlocks = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;BasicBlock&gt; sucBlocks = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================æ”¯é…åˆ†æ====================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ”¯é…è€…å—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;BasicBlock&gt; domers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›´æ¥æ”¯é…çš„åŸºæœ¬å—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;BasicBlock&gt; idomees = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›´æ¥æ”¯é…åŸºæœ¬å—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BasicBlock Idomer;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨æ”¯é…æ ‘ä¸­çš„æ·±åº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> domLevel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ”¯é…è¾¹é™…ï¼Œå³åˆšå¥½ä¸è¢«å½“å‰åŸºæœ¬å—æ”¯é…çš„åŸºæœ¬å—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;BasicBlock&gt; dominanceFrontier = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;BasicBlock&gt; <span class="title function_">getDomers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> domers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰å—æ˜¯å¦æ˜¯å¦ä¸€ä¸ªå—çš„æ”¯é…è€…</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isDominating</span><span class="params">(BasicBlock other)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> other.domers.contains(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;BasicBlock&gt; <span class="title function_">getIdomees</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> idomees;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIdomer</span><span class="params">(BasicBlock idomer)</span> &#123;</span><br><span class="line">        Idomer = idomer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDomLevel</span><span class="params">(<span class="type">int</span> domLevel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.domLevel = domLevel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getDomLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> domLevel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> HashSet&lt;BasicBlock&gt; <span class="title function_">getDominanceFrontier</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dominanceFrontier;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BasicBlock <span class="title function_">getIdomer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Idomer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// =================== å¾ªç¯åˆ†æ ======================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰å—ç›´å±çš„å¾ªç¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Loop</span> <span class="variable">loop</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å¾—å¾ªç¯æ·±åº¦</span></span><br><span class="line"><span class="comment">     * å¦‚æœä¸åœ¨å¾ªç¯ä¸­ï¼Œåˆ™æ·±åº¦ä¸º 1</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å¾ªç¯æ·±åº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoopDepth</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (loop == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> loop.getLoopDepth();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoop</span><span class="params">(Loop loop)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loop = loop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Loop <span class="title function_">getLoop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> loop;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="å†è®®-SSA"><a href="#å†è®®-SSA" class="headerlink" title="å†è®® SSA"></a>å†è®® <code>SSA</code></h4><p>ç°åœ¨å†çœ‹å›SSAï¼š</p>
<p>å½“æ¶‰åŠåˆ°åˆ†æ”¯è¯­å¥æ—¶ï¼ŒSSAä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼Œä»¥ä¸‹é¢è¿™ä¸ªå¾ªç¯ä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    i = getint();</span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">    a = getint();</span><br><span class="line">    <span class="keyword">for</span>(; i &lt; <span class="number">10</span>; i = i + <span class="number">1</span>)&#123;</span><br><span class="line">    	i = i + <span class="number">2</span>;</span><br><span class="line">        a = a + <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¼šå‘ç°ï¼Œå¯¹äºå¾ªç¯çš„å½’çº³å˜é‡ï¼Œå…¶æ³¨å®šä¼šæœ‰ä¸¤å¤„èµ‹å€¼ã€‚å› æ­¤åŒæ ·å¯¹äº <code>i</code>å’Œ <code>a</code>ï¼Œæˆ‘ä»¬éœ€è¦å†æ¥ä¸€ä¸ª <code>i1</code>å’Œ <code>a1</code>æ¥æ”¾ç½®è¿™ç¬¬äºŒä¸ªèµ‹å€¼ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œåœ¨ <code>i1</code>å’Œ <code>a1</code>çš„æ±‡èšç‚¹ï¼Œåˆ°åº•è¯¥é‡‡å–å“ªä¸ªèµ‹å€¼ï¼Ÿè¿™æ—¶å€™å°±å¿…é¡»ç”¨åˆ° <code>phi</code>æŒ‡ä»¤ã€‚</p>
<p><code>phi</code> æŒ‡ä»¤è¿™ä¸ªæŒ‡ä»¤èƒ½å¤Ÿæ ¹æ®è¿›å…¥å½“å‰åŸºæœ¬å—ä¹‹å‰æ‰§è¡Œçš„æ˜¯å“ªä¸€ä¸ªåŸºæœ¬å—çš„ä»£ç æ¥é€‰æ‹©ä¸€ä¸ªå˜é‡çš„å€¼ã€‚</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;result&gt; <span class="operator">=</span> <span class="keyword">phi</span> &lt;ty&gt; [&lt;val<span class="number">0</span>&gt;<span class="punctuation">,</span> &lt;<span class="type">label</span><span class="number">0</span>&gt;]<span class="punctuation">,</span> [&lt;val<span class="number">1</span>&gt;<span class="punctuation">,</span> &lt;<span class="type">label</span><span class="number">1</span>&gt;] ...</span><br></pre></td></tr></table></figure>

<p>æœ‰äº† <code>phi</code>ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™å‡ºä»£ç ï¼š</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">define</span> dso_local <span class="type">i32</span> <span class="title">@main</span>() &#123;</span><br><span class="line">b<span class="number">0</span>:</span><br><span class="line">	<span class="variable">%i3</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> <span class="title">@getint</span>()</span><br><span class="line">	<span class="variable">%i7</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> <span class="title">@getint</span>()</span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%b9</span></span><br><span class="line">b<span class="number">9</span>:</span><br><span class="line">	<span class="variable">%p25</span> <span class="operator">=</span> <span class="keyword">phi</span> <span class="type">i32</span> [ <span class="variable">%i3</span><span class="punctuation">,</span> <span class="variable">%b0</span> ]<span class="punctuation">,</span>  [ <span class="variable">%i16</span><span class="punctuation">,</span> <span class="variable">%b11</span> ]</span><br><span class="line">	<span class="variable">%p24</span> <span class="operator">=</span> <span class="keyword">phi</span> <span class="type">i32</span> [ <span class="variable">%i7</span><span class="punctuation">,</span> <span class="variable">%b0</span> ]<span class="punctuation">,</span>  [ <span class="variable">%i19</span><span class="punctuation">,</span> <span class="variable">%b11</span> ]</span><br><span class="line">	<span class="variable">%i14</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">slt</span> <span class="type">i32</span> <span class="variable">%p25</span><span class="punctuation">,</span> <span class="number">10</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">i1</span> <span class="variable">%i14</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%b10</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%b12</span></span><br><span class="line">b<span class="number">10</span>:</span><br><span class="line">	<span class="variable">%i19</span> <span class="operator">=</span> <span class="keyword">add</span> <span class="type">i32</span> <span class="variable">%p24</span><span class="punctuation">,</span> <span class="number">2</span></span><br><span class="line">	<span class="variable">%i22</span> <span class="operator">=</span> <span class="keyword">add</span> <span class="type">i32</span> <span class="variable">%p25</span><span class="punctuation">,</span> <span class="number">3</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%b11</span></span><br><span class="line">b<span class="number">11</span>:</span><br><span class="line">	<span class="variable">%i16</span> <span class="operator">=</span> <span class="keyword">add</span> <span class="type">i32</span> <span class="variable">%i22</span><span class="punctuation">,</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%b9</span></span><br><span class="line">b<span class="number">12</span>:</span><br><span class="line">	<span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†å®é™…ä¸Šï¼Œ<code>phi</code>æŒ‡ä»¤çš„æ„å»ºæœ‰äº¿ç‚¹ç‚¹å¤æ‚ï¼Œè¿™ä¹Ÿå¤ªéš¾å†™äº†ï¼å¦‚æœæœ‰ä¸€ä¸ªèƒ½å¤Ÿæ‘†è„±SSAé™åˆ¶çš„åŠæ³•å°±å¥½äº†ã€‚</p>
<p>è¿™å°±è¦ç”¨åˆ°æˆ‘ä»¬ä¹‹å‰æåˆ°çš„<strong>å†…å­˜SSAï¼š</strong></p>
<p>è¿™ç§ç”Ÿæˆå­˜å–å†…å­˜çš„ <code>llvm</code>æœ‰å››ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¯ä¸ªå±€éƒ¨å˜é‡éƒ½å˜ä¸ºäº†æ ˆä¸Šåˆ†é…çš„ç©ºé—´ï¼ˆå˜é‡åœ¨ç¬¦å·è¡¨ä¸­å­˜çš„å…¶å®æ˜¯å…¶ <code>alloca</code> æŒ‡ä»¤ï¼‰</li>
<li>æ¯æ¬¡å¯¹å±€éƒ¨å˜é‡çš„è¯»éƒ½å˜æˆäº†ä»å†…å­˜ç©ºé—´ä¸­çš„ä¸€æ¬¡è¯»ï¼ˆåœ¨ <code>LValNode</code>ä¸­å®ç°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™é‡Œæ˜¯æŒ‡é’ˆçš„æ•…ä¹¡ä¹‹ä¸€ï¼ï¼‰</li>
<li>æ¯æ¬¡å¯¹å±€éƒ¨å˜é‡çš„å†™éƒ½å˜æˆäº†å¯¹å†…å­˜çš„ä¸€æ¬¡å†™ï¼ˆæ¯æ¬¡æ›´æ–°ä¸€ä¸ªå˜é‡çš„å€¼éƒ½å˜æˆäº†é€šè¿‡ <code>store</code> å¯¹å˜é‡æ‰€åœ¨å†…å­˜çš„å†™ï¼‰</li>
<li>è·å–å±€éƒ¨å˜é‡çš„åœ°å€ç­‰ä»·äºè·å–å†…å­˜çš„åœ°å€</li>
</ul>
<p>éœ€è¦è¿›è¡Œçš„ä¸»è¦æ“ä½œæœ‰ï¼š</p>
<ul>
<li><p>å±€éƒ¨å˜é‡å®šä¹‰æ—¶ï¼š</p>
<ul>
<li><strong><code>alloca</code>ï¼ˆåˆ†é…å˜é‡çš„æ ˆç©ºé—´ï¼Œè¿”å›æŒ‡å‘è¯¥ç©ºé—´çš„æŒ‡é’ˆï¼‰</strong></li>
<li>å°† <code>alloca</code>è®°å½•è¿›å…¥ç¬¦å·è¡¨ã€‚</li>
<li><strong><code>store</code>ï¼ˆç»™å˜é‡èµ‹å€¼ï¼Œå³å‘æŒ‡é’ˆæ‰€æŒ‡ç©ºé—´å†…è¿›è¡Œå†™ï¼‰</strong></li>
</ul>
</li>
<li><p>å±€éƒ¨å˜é‡ä½¿ç”¨æ—¶ï¼š</p>
<ul>
<li>LVal: æŸ¥ç¬¦å·è¡¨è·å¾—æŒ‡å®šå±€éƒ¨å˜é‡æˆ–å½¢å‚çš„ <code>alloca</code>æŒ‡é’ˆ</li>
<li>PrimaryExp: å¯¹äºLValä¼ ä¸Šæ¥çš„ <code>alloca</code>æŒ‡é’ˆï¼Œè¿›è¡Œ <code>load</code>å¤„ç†</li>
</ul>
</li>
<li><p>å‡½æ•°å½¢å‚æ¥æ”¶æ—¶ï¼š</p>
<p>ç‰¹åˆ«åœ°ï¼Œ<strong>å‡½æ•°çš„å½¢å‚ä¹Ÿç±»ä¼¼äºå±€éƒ¨å˜é‡ï¼Œæˆ‘ä»¬ä¹Ÿè¦å°†å…¶å¤„ç†ä¸ºSSAå½¢å¼ï¼Œåœ¨æ ˆä¸Šåˆ†é…ç©ºé—´å¹¶èµ‹å€¼ä»¥ä»£ä¹‹ï¼Œå¦åˆ™è¿˜æ˜¯ä¼šé‡åˆ°æˆ‘ä»¬ä¸Šä¸€èŠ‚åˆ†æå‡ºæ¥çš„é—®é¢˜</strong>ï¼</p>
<ul>
<li>FuncFParamNodeï¼šè¯»å–å½¢å‚çš„ç±»å‹ã€åç§°ï¼Œåˆ›å»ºå½¢å‚çš„Value</li>
<li>FuncFParamsNodeï¼š å¯¹äºæ¯ä¸€ä¸ªå½¢å‚ï¼Œéƒ½è¿›è¡Œ <code>alloca</code>ï¼Œ<code>store</code>ï¼Œå…¶ä¸­ <code>store</code>çš„å†…å®¹å°±æ˜¯åˆšåˆ›å»ºçš„å½¢å‚çš„Valueã€‚ç¬¦å·è¡¨ä¸­å­˜å…¥çš„ä¹Ÿæ˜¯ <code>alloca</code>å¯¹åº”çš„value</li>
</ul>
</li>
</ul>
<h4 id="ConstExpçš„å¤„ç†ä¸â€œåé—¨â€å¸¸é‡ä¼ æ’­"><a href="#ConstExpçš„å¤„ç†ä¸â€œåé—¨â€å¸¸é‡ä¼ æ’­" class="headerlink" title="ConstExpçš„å¤„ç†ä¸â€œåé—¨â€å¸¸é‡ä¼ æ’­"></a>ConstExpçš„å¤„ç†ä¸â€œåé—¨â€å¸¸é‡ä¼ æ’­</h4><p>åœ¨æˆ‘ä»¬çš„æ–‡æ³•å½“ä¸­ï¼Œæœ‰è¿™æ ·çš„å£°æ˜ï¼š</p>
<blockquote>
<p>å¸¸é‡è¡¨è¾¾å¼ ConstExp</p>
<p>ConstExp -&gt; AddExp ä¸­ä½¿ç”¨çš„ ident å¿…é¡»æ˜¯å¸¸é‡</p>
</blockquote>
<p>ä½•ä¸ºå¸¸é‡ï¼Ÿå³èƒ½å¤Ÿåœ¨ç¼–è¯‘é˜¶æ®µå°±ç¡®å®šå€¼çš„é‡ï¼ŒåŒ…æ‹¬äº†å¸¸é‡æ ‡è¯†ç¬¦ä¸ç«‹å³æ•°ã€‚<strong>å¯¹äºå¸¸é‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¼–è¯‘é˜¶æ®µå°±è®¡ç®—å‡ºå¸¸é‡è¡¨è¾¾å¼çš„å€¼ï¼Œä»¥åŠå°†å¸¸é‡æ ‡è¯†ç¬¦æ›¿æ¢ä¸ºå…¶å€¼</strong>ã€‚</p>
<p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨ <code>IrFactory</code>é‡Œè®¾ç½®æœ‰å­—æ®µï¼Œåœ¨ <code>Exp</code>ç³»çš„ <code>buildIr</code>å†…ï¼Œæ„å»ºå¸¸é‡æ—¶çš„åˆ†ç±»è®¨è®ºçš„æ–¹å¼æœ‰æ‰€ä¸åŒï¼Œä¸”ç”±äºèƒ½å¤Ÿè®¡ç®—å‡ºintç±»å‹å…·ä½“å€¼ï¼Œæˆ‘ä»¬åªéœ€è¦è¿›è¡Œ <code>synInt</code>ç»¼åˆå±æ€§çš„ä¼ é€’ã€‚</p>
<p>å¸¸é‡åˆ†ä¸ºæ•°ç»„å¸¸é‡å’Œéæ•°ç»„å¸¸é‡ï¼Œå…¶è¡Œä¸ºæœ‰æ‰€ä¸åŒï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>intå¸¸é‡</th>
<th>æ•°ç»„å¸¸é‡</th>
</tr>
</thead>
<tbody><tr>
<td>æ˜¯å¦åœ¨llvmä»£ç ä¸­æ˜¾å¼å£°æ˜</td>
<td>å¦</td>
<td>ä¸æ™®é€šæ•°ç»„å˜é‡ä¸€è‡´ï¼Œé‡‡ç”¨alloca,store</td>
</tr>
<tr>
<td>åœ¨ <code>ConstExp</code>ä¸‹</td>
<td>ç›´æ¥æ±‚å‡ºint, charå€¼</td>
<td>ç›´æ¥æ±‚å‡ºæŒ‡å®šå…ƒç´ çš„intå€¼</td>
</tr>
<tr>
<td>é <code>ConstExp</code>ä¸‹</td>
<td>ç›´æ¥æ±‚å‡ºint, charå€¼</td>
<td>ä¸æ™®é€šæ•°ç»„å˜é‡ä¸€è‡´ï¼Œé‡‡ç”¨gepï¼Œload</td>
</tr>
</tbody></table>
<h2 id="Mips-ç”Ÿæˆ"><a href="#Mips-ç”Ÿæˆ" class="headerlink" title="Mips ç”Ÿæˆ"></a>Mips ç”Ÿæˆ</h2><p>åœ¨llvmä¸­ï¼Œ<strong>æˆ‘ä»¬å·²ç»å°†æºä»£ç è½¬æ¢æˆäº†å¾ˆæ¥è¿‘ä¸­é—´ä»£ç çš„å½¢å¼äº†ï¼šæˆ‘ä»¬åˆ’åˆ†å¹¶ç”Ÿæˆäº†åŸºæœ¬å—ï¼Œç”Ÿæˆäº†å‡ ä¹èƒ½ä¸€ç­‰ä¸€è½¬åŒ–ä¸ºmipsçš„llvmæŒ‡ä»¤</strong>ã€‚å› æ­¤åœ¨ç›®æ ‡ä»£ç çš„<strong>åˆæ­¥</strong>ç”Ÿæˆçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„å…³æ³¨ç‚¹ä¸»è¦åœ¨äº<strong>å­˜å‚¨ç®¡ç†ã€æŒ‡ä»¤çš„ç­‰ä»·ç¿»è¯‘</strong>ã€‚</p>
<h3 id="MipsBuilderï¼šæŒ‡ä»¤çš„å·¥å‚ç±»"><a href="#MipsBuilderï¼šæŒ‡ä»¤çš„å·¥å‚ç±»" class="headerlink" title="MipsBuilderï¼šæŒ‡ä»¤çš„å·¥å‚ç±»"></a>MipsBuilderï¼šæŒ‡ä»¤çš„å·¥å‚ç±»</h3><p>åœ¨MipsBuilderä¸­å°è£…æœ‰æ„å»ºå„ç§æŒ‡ä»¤ã€æ„å»ºæ“ä½œæ•°çš„å·¥å‚æ¨¡å¼æ–¹æ³•ã€‚</p>
<p>ä¾‹å¦‚æ„å»ºä¸€æ¡ <code>add</code>æŒ‡ä»¤å¹¶åŠ å…¥æŒ‡å®šçš„ <code>MipsBlock</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ„å»ºåŒæ“ä½œæ•°æŒ‡ä»¤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type æŒ‡ä»¤ç±»å‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MipsBinary <span class="title function_">buildBinary</span><span class="params">(MipsBinary.BinaryType type, MipsOperand dst, MipsOperand src1, MipsOperand src2, BasicBlock irBlock)</span> &#123;</span><br><span class="line">        <span class="type">MipsBinary</span> <span class="variable">binary</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MipsBinary</span>(type, dst, src1, src2);</span><br><span class="line">        MipsFactory.irBlock2MipsBlock(irBlock).addInstruction(binary);</span><br><span class="line">        <span class="keyword">return</span> binary;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="MipsFactoryï¼šè®°å½•-llvmæˆåˆ†åˆ°-mipsæˆåˆ†çš„æ˜ å°„"><a href="#MipsFactoryï¼šè®°å½•-llvmæˆåˆ†åˆ°-mipsæˆåˆ†çš„æ˜ å°„" class="headerlink" title="MipsFactoryï¼šè®°å½• llvmæˆåˆ†åˆ° mipsæˆåˆ†çš„æ˜ å°„"></a>MipsFactoryï¼šè®°å½• <code>llvm</code>æˆåˆ†åˆ° <code>mips</code>æˆåˆ†çš„æ˜ å°„</h3><p>æˆ‘ä»¬æ˜¯åœ¨llvmçš„æˆåˆ†ç±»ä¸­è¿›è¡Œçš„mipsç”Ÿæˆï¼Œå› æ­¤éœ€è¦å°†llvmæˆåˆ†ä¸mipsæˆåˆ†è¿›è¡Œæ˜ å°„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–irå‡½æ•°å¯¹è±¡ å¯¹åº”çš„ mipså‡½æ•°å¯¹è±¡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> irFunction irå‡½æ•°å¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mipså‡½æ•°å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MipsFunction <span class="title function_">irFunction2MipsFunction</span><span class="params">(Function irFunction)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> functionMap.get(irFunction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–iråŸºæœ¬å—å¯¹è±¡ å¯¹åº”çš„ mipsåŸºæœ¬å—å¯¹è±¡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> irBlock iråŸºæœ¬å—å¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mipsåŸºæœ¬å—å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MipsBlock <span class="title function_">irBlock2MipsBlock</span><span class="params">(BasicBlock irBlock)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> blockMap.get(irBlock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ir Valueå¯¹è±¡ å¯¹åº”çš„ mipsOperandå¯¹è±¡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> irValue ir Valueå¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mipsOperandå¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MipsOperand <span class="title function_">irValue2MipsOp</span><span class="params">(Value irValue)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> opMap.get(irValue);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="llvmçš„æˆåˆ†ç±»ï¼šmipsç”Ÿæˆçš„ä¸»è¦åœºæ‰€"><a href="#llvmçš„æˆåˆ†ç±»ï¼šmipsç”Ÿæˆçš„ä¸»è¦åœºæ‰€" class="headerlink" title="llvmçš„æˆåˆ†ç±»ï¼šmipsç”Ÿæˆçš„ä¸»è¦åœºæ‰€"></a><code>llvm</code>çš„æˆåˆ†ç±»ï¼šmipsç”Ÿæˆçš„ä¸»è¦åœºæ‰€</h3><p>é€šè¿‡éå† <code>llvm</code>çš„æ ‘å½¢ç»“æ„æ¥ç”Ÿæˆ <code>mips</code>ï¼Œéå†åœ¨ <code>ir/values</code>ä¸‹çš„å„ä¸ªvalueç±»è¿›è¡Œï¼Œä»–ä»¬éƒ½å®ç°äº†çˆ¶ç±» <code>Value</code>çš„ <code>buildMips()</code>æ–¹æ³•ã€‚</p>
<h3 id="backend-instructions-MipsæŒ‡ä»¤ç±»"><a href="#backend-instructions-MipsæŒ‡ä»¤ç±»" class="headerlink" title="backend/instructions: MipsæŒ‡ä»¤ç±»"></a><code>backend/instructions</code>: MipsæŒ‡ä»¤ç±»</h3><p>æŒ‡ä»¤ç±»éƒ½ç»§æ‰¿äº† <code>MipsInstruction</code>ç±»ï¼Œ<strong>è¯¥ç±»å†…æœ‰ <code>src</code>æ“ä½œæ•°å’Œ <code>dst</code>æ“ä½œæ•°çš„ç›¸åº”ç®¡ç†æ–¹æ³•ï¼ŒåŒ…æ‹¬ <code>use</code>ï¼Œ<code>def</code>çš„è®°å½•ï¼Œç”¨äºæ´»è·ƒå˜é‡åˆ†æï¼Œä»¥åŠåç»­å¯„å­˜å™¨åˆ†é…æ—¶ï¼Œå¯¹è™šæ‹Ÿå¯„å­˜å™¨è¿›è¡ŒæŸ¥è¯¢ã€æ›¿æ¢</strong>ã€‚</p>
<h3 id="backend-operands-æ“ä½œæ•°ç±»"><a href="#backend-operands-æ“ä½œæ•°ç±»" class="headerlink" title="backend/operands: æ“ä½œæ•°ç±»"></a><code>backend/operands</code>: æ“ä½œæ•°ç±»</h3><p>è¯¥åŒ…å†…çš„ç±»å‡å¯ä»¥ä½œä¸º <code>mips</code>æŒ‡ä»¤çš„æ“ä½œæ•°ï¼Œå…·ä½“æ¥è¯´æœ‰ç«‹å³æ•°ã€è™šæ‹Ÿå¯„å­˜å™¨ã€ç‰©ç†å¯„å­˜å™¨ã€æ ‡ç­¾ã€‚</p>
<p>ç‰©ç†å¯„å­˜å™¨çš„ç›¸å…³é…ç½®åœ¨ <code>RegType</code>æšä¸¾ç±»ä¸­ï¼Œè®°å½•äº†ç‰©ç†å¯„å­˜å™¨çš„ç¼–å·ã€åç§°ã€ä½•è€…éœ€è¦åœ¨å‡½æ•°è°ƒç”¨æ—¶ä¿å­˜ã€ä½•è€…èƒ½å¤Ÿä½œä¸ºå…¨å±€å¯„å­˜å™¨åˆ†é…ç­‰ä¿¡æ¯ã€‚</p>
<h3 id="æ„å»ºæµç¨‹"><a href="#æ„å»ºæµç¨‹" class="headerlink" title="æ„å»ºæµç¨‹"></a>æ„å»ºæµç¨‹</h3><p>å¸¦æœ‰è™šæ‹Ÿå¯„å­˜å™¨çš„mipsçš„æ€»ä½“æ„å»ºæµç¨‹å¦‚ä¸‹ï¼š</p>
<h4 id="æ„å»º-dataæ®µ"><a href="#æ„å»º-dataæ®µ" class="headerlink" title="æ„å»º.dataæ®µ"></a>æ„å»º.dataæ®µ</h4><p>æ„å»º.dataæ®µä¸»è¦æ˜¯åœ¨ç¿»è¯‘ <code>llvm</code>çš„å…¨å±€å˜é‡å…ƒç´  <code>GlobalVariable</code>ã€‚</p>
<p>å…ˆå‰åœ¨ <code>llvm</code>ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†éœ€è¦ <code>printf</code>è¾“å‡ºçš„å­—ç¬¦ä¸²é‡æ–°åˆ†é…ä¸ºäº†å…¨å±€å¸¸é‡å­—ç¬¦ä¸²ï¼Œå› æ­¤è¿™é‡Œå…¨å±€å˜é‡å…±æœ‰ä¸‰ç±»ï¼šå­—ç¬¦ä¸²ã€intå˜é‡ã€intæ•°ç»„ã€‚ä¾æ¬¡æ„å»º <code>mipsGlobalVariable</code>ï¼Œç„¶ååŠ å…¥ <code>MipsModule</code>å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buildMips</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MipsGlobalVariable</span> <span class="variable">mipsGlobalVariable</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// æ— åˆå§‹å€¼é”™è¯¯</span></span><br><span class="line">        <span class="keyword">if</span> (initValue == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;[buildMips] GlobalVariableï¼šinitValue == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœªåˆå§‹åŒ–çš„å…¨å±€æ•°ç»„</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (initValue <span class="keyword">instanceof</span> ZeroInitializer) &#123;</span><br><span class="line">            mipsGlobalVariable = <span class="keyword">new</span> <span class="title class_">MipsGlobalVariable</span>(getName(), initValue.getType().getSize());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¸¸é‡å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (initValue <span class="keyword">instanceof</span> ConstString) &#123;</span><br><span class="line">            mipsGlobalVariable = <span class="keyword">new</span> <span class="title class_">MipsGlobalVariable</span>(getName(), ((ConstString) initValue).getContent());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// intå˜é‡</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (initValue <span class="keyword">instanceof</span> ConstInt) &#123;</span><br><span class="line">            mipsGlobalVariable = <span class="keyword">new</span> <span class="title class_">MipsGlobalVariable</span>(getName(), <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;() &#123;&#123;</span><br><span class="line">                add(((ConstInt) initValue).getValue());</span><br><span class="line">            &#125;&#125;, MipsGlobalVariable.GVType.Int);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initValue <span class="keyword">instanceof</span> ConstChar) &#123;</span><br><span class="line">            mipsGlobalVariable = <span class="keyword">new</span> <span class="title class_">MipsGlobalVariable</span>(getName(), <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;() &#123;&#123;</span><br><span class="line">                add(((ConstChar) initValue).getValue());</span><br><span class="line">            &#125;&#125;, MipsGlobalVariable.GVType.Char);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// int | Charæ•°ç»„</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (initValue <span class="keyword">instanceof</span> ConstArray) &#123;</span><br><span class="line">            ArrayList&lt;Integer&gt; inits = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span> (((ConstArray) initValue).getElements().get(<span class="number">0</span>).getType() <span class="keyword">instanceof</span> IntType) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Constant element : ((ConstArray) initValue).getElements()) &#123;</span><br><span class="line">                    inits.add(((ConstInt) element).getValue());</span><br><span class="line">                &#125;</span><br><span class="line">                mipsGlobalVariable = <span class="keyword">new</span> <span class="title class_">MipsGlobalVariable</span>(getName(), inits, MipsGlobalVariable.GVType.Int);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (Constant element : ((ConstArray) initValue).getElements()) &#123;</span><br><span class="line">                    inits.add(((ConstChar) element).getValue());</span><br><span class="line">                &#125;</span><br><span class="line">                mipsGlobalVariable = <span class="keyword">new</span> <span class="title class_">MipsGlobalVariable</span>(getName(), inits, MipsGlobalVariable.GVType.Char);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        MipsModule.addGlobalVariable(mipsGlobalVariable);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä¸ºæ‰€æœ‰Blockå’ŒFunctionåˆ›å»ºMipså¯¹è±¡ï¼Œå¹¶æ˜ å°„åˆ°llvmçš„ç›¸åº”å¯¹è±¡"><a href="#ä¸ºæ‰€æœ‰Blockå’ŒFunctionåˆ›å»ºMipså¯¹è±¡ï¼Œå¹¶æ˜ å°„åˆ°llvmçš„ç›¸åº”å¯¹è±¡" class="headerlink" title="ä¸ºæ‰€æœ‰Blockå’ŒFunctionåˆ›å»ºMipså¯¹è±¡ï¼Œå¹¶æ˜ å°„åˆ°llvmçš„ç›¸åº”å¯¹è±¡"></a>ä¸ºæ‰€æœ‰Blockå’ŒFunctionåˆ›å»ºMipså¯¹è±¡ï¼Œå¹¶æ˜ å°„åˆ°llvmçš„ç›¸åº”å¯¹è±¡</h4><p>æ²¡æœ‰å¤ªå¤šå¯è¯´çš„ï¼Œä½œç”¨ä¸»è¦æ˜¯æ–¹ä¾¿åœ¨åç»­éå†è¯­å¥æ—¶ï¼Œèƒ½å¤Ÿæ–¹ä¾¿åœ°å¼•ç”¨å‡½æ•°å’ŒåŸºæœ¬å—ï¼ˆç”¨äºcallã€brç­‰llvmæŒ‡ä»¤çš„ç¿»è¯‘ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†ä¸­é—´ä»£ç çš„å‡½æ•°å’ŒåŸºæœ¬å—å¯¹è±¡:</span></span><br><span class="line"><span class="comment">     * 1.æ„å»ºmipsé‡Œçš„ç›¸åº”å¯¹è±¡</span></span><br><span class="line"><span class="comment">     * 2.åŠ å…¥Module</span></span><br><span class="line"><span class="comment">     * 3.ä¿¡æ¯å­˜å‚¨åˆ°mipså¯¹è±¡é‡Œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mapFunctionBlockIr2Mips</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰å‡½æ•°</span></span><br><span class="line">        <span class="keyword">for</span> (Function irFunction : functions) &#123;</span><br><span class="line">            <span class="comment">// æ„å»ºå‡½æ•°å¯¹è±¡</span></span><br><span class="line">            <span class="type">MipsFunction</span> <span class="variable">mipsFunction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MipsFunction</span>(irFunction.getName(), irFunction.isLibFunc());</span><br><span class="line"></span><br><span class="line">            MipsFactory.addFunctionMapping(irFunction, mipsFunction);</span><br><span class="line">            MipsModule.addFunction(mipsFunction);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ„å»ºåŸºæœ¬å—å¯¹è±¡</span></span><br><span class="line">            ArrayList&lt;BasicBlock&gt; blocks = irFunction.getBasicBlocks();</span><br><span class="line">            <span class="keyword">for</span> (BasicBlock irBlock : blocks) &#123;</span><br><span class="line">                <span class="type">MipsBlock</span> <span class="variable">mipsBlock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MipsBlock</span>(irBlock.getName(), irBlock.getLoopDepth());</span><br><span class="line">                MipsFactory.addBlockMapping(irBlock, mipsBlock);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è®°å½•mipsBlockçš„å‰é©±å—ä¿¡æ¯, å‰é©±å—å½“ç„¶ä¹Ÿæ˜¯mipsBlock</span></span><br><span class="line">            <span class="keyword">for</span> (BasicBlock irBlock : blocks) &#123;</span><br><span class="line">                <span class="type">MipsBlock</span> <span class="variable">mipsBlock</span> <span class="operator">=</span> MipsFactory.irBlock2MipsBlock(irBlock);</span><br><span class="line">                <span class="keyword">for</span> (BasicBlock irPreBlock : irBlock.getPreBlocks()) &#123;</span><br><span class="line">                    mipsBlock.addPreBlock(MipsFactory.irBlock2MipsBlock(irPreBlock));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="éå†-llvmçš„æ ‘å½¢ç»“æ„"><a href="#éå†-llvmçš„æ ‘å½¢ç»“æ„" class="headerlink" title="éå† llvmçš„æ ‘å½¢ç»“æ„"></a>éå† <code>llvm</code>çš„æ ‘å½¢ç»“æ„</h4><p>ä¾åºéå† <code>llvm</code>çš„æ‰€æœ‰å‡½æ•°ã€æ‰€æœ‰åŸºæœ¬å—ã€æ‰€æœ‰æŒ‡ä»¤ï¼Œè¿›è¡Œç¿»è¯‘ã€‚</p>
<h3 id="å…·ä½“æ„å»ºéš¾ç‚¹"><a href="#å…·ä½“æ„å»ºéš¾ç‚¹" class="headerlink" title="å…·ä½“æ„å»ºéš¾ç‚¹"></a>å…·ä½“æ„å»ºéš¾ç‚¹</h3><p>å®é™…ä¸Šï¼Œå°† <code>LLVM</code>æŒ‡ä»¤æŒ¨ä¸ªç¿»è¯‘æˆ <code>MIPS</code>æŒ‡ä»¤å¹¶ä¸å›°éš¾ï¼Œæˆ‘ä»¬é‡ç‚¹è®²ä¸€ä¸‹ç¿»è¯‘æˆ <code>Mips</code>æ—¶å‡½æ•°è°ƒç”¨çš„éƒ¨åˆ†ï¼Œè¿™æ˜¯ä¸€å¤§éš¾ç‚¹ï¼Œè‡³äºå¯„å­˜å™¨åˆ†é…åˆ™æ”¾åˆ°ä¼˜åŒ–éƒ¨åˆ†è¯¦è¿°ã€‚</p>
<h4 id="Callï¼šå‚æ•°ä¼ é€’"><a href="#Callï¼šå‚æ•°ä¼ é€’" class="headerlink" title="Callï¼šå‚æ•°ä¼ é€’"></a>Callï¼šå‚æ•°ä¼ é€’</h4><p>Callçš„ä½œç”¨æ˜¯è°ƒç”¨å‡½æ•°ï¼Œç†æ‰€å½“ç„¶åœ°ï¼Œåœ¨mipsä¸­éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è¿›è¡Œå®å‚çš„ä¼ é€’ï¼ŒåŒæ—¶è®°å½• <code>MipsCall</code>æŒ‡ä»¤å¯¹äºå¯„å­˜å™¨çš„ä¿®æ”¹ï¼ˆå³defï¼‰ã€‚</p>
<p>å¯¹äºå‰å››ä¸ªå‚æ•°ï¼Œä¿å­˜åœ¨ <code>a0</code>-<code>a3</code>é‡Œå³å¯ã€‚å¯¹äºæ›´å¤šçš„å‚æ•°ï¼Œéœ€è¦ä¿å­˜åœ¨æ ˆä¸Šã€‚</p>
<p>è°ƒç”¨å‡½æ•°åœ¨è°ƒç”¨è€…å¤„çš„å‡†å¤‡å·¥ä½œï¼Œéƒ½ç”±Callè¿›è¡Œç¿»è¯‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buildMips</span><span class="params">()</span> &#123;</span><br><span class="line">        MipsBuilder.buildComment(<span class="built_in">this</span>.toString(), getParent());</span><br><span class="line"></span><br><span class="line">        <span class="type">MipsBlock</span> <span class="variable">mipsBlock</span> <span class="operator">=</span> MipsFactory.irBlock2MipsBlock(getParent());</span><br><span class="line">        <span class="type">MipsFunction</span> <span class="variable">mipsFunction</span> <span class="operator">=</span> MipsFactory.irFunction2MipsFunction(function);</span><br><span class="line">        <span class="comment">// å…ˆæ„å»ºå‡ºcallæŒ‡ä»¤ï¼Œåç»­è¦è®°å½•è¯¥æŒ‡ä»¤ç”¨åˆ°çš„Aå¯„å­˜å™¨</span></span><br><span class="line">        <span class="comment">// ï¼è¿™ä¹Ÿæ˜¯å”¯ä¸€ä¸€æ¬¡ä½¿ç”¨é‡ç”Ÿæœªå°è£…çš„new MipsInstruction</span></span><br><span class="line">        MipsInstruction call;</span><br><span class="line">        <span class="comment">// å†…å»ºå‡½æ•°ï¼Œéœ€è¦å®è°ƒç”¨</span></span><br><span class="line">        <span class="keyword">if</span> (function.isLibFunc()) &#123;</span><br><span class="line">            call = <span class="keyword">new</span> <span class="title class_">MipsMacro</span>(mipsFunction.getName());</span><br><span class="line">            <span class="comment">// ç³»ç»Ÿè°ƒç”¨å¿…ç„¶æ”¹å˜ v0, v0åŠ å…¥def</span></span><br><span class="line">            call.addDefReg(MipsRealReg.V0); <span class="comment">// <span class="doctag">TODO:</span> addDefReg åŒå‚æ•°ä¿®æ”¹ä¸ºå•å‚æ•°</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// éå†…å»ºå‡½æ•°ï¼Œç›´æ¥æ„å»ºjalæŒ‡ä»¤å³å¯</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            call = <span class="keyword">new</span> <span class="title class_">MipsCall</span>(mipsFunction);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿›è¡Œä¼ å‚, éå†æ‰€æœ‰irValueå‚æ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">argc</span> <span class="operator">=</span> getArgs().size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line">            <span class="type">Value</span> <span class="variable">irArg</span> <span class="operator">=</span> getArgs().get(i);</span><br><span class="line">            MipsOperand src;</span><br><span class="line">            <span class="comment">// å‰å››ä¸ªå‚æ•°å­˜å‚¨åœ¨a0-3å†…</span></span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">4</span>) &#123;</span><br><span class="line">                src = MipsBuilder.buildOperand(irArg, <span class="literal">true</span>, MipsFactory.curIrFunction, getParent());</span><br><span class="line">                <span class="type">MipsMove</span> <span class="variable">move</span> <span class="operator">=</span> MipsBuilder.buildMove(<span class="keyword">new</span> <span class="title class_">MipsRealReg</span>(<span class="string">&quot;a&quot;</span> + i), src, getParent());</span><br><span class="line">                <span class="comment">// åŠ å…¥useï¼Œä¿æŠ¤å¯„å­˜å™¨åˆ†é…æ—¶ä¸æ¶ˆé™¤move</span></span><br><span class="line">                call.addUseReg(move.getDst());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åé¢çš„å‚æ•°å…ˆå­˜è¿›å¯„å­˜å™¨é‡Œï¼Œå†storeè¿›å†…å­˜</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isByte</span> <span class="operator">=</span> irArg.getType() <span class="keyword">instanceof</span> CharType;</span><br><span class="line">                <span class="comment">// è¦æ±‚å­˜å…¥å¯„å­˜å™¨</span></span><br><span class="line">                src = MipsBuilder.buildOperand(irArg, <span class="literal">false</span>, MipsFactory.curIrFunction, getParent());</span><br><span class="line">                <span class="comment">// å­˜å…¥ SP - 4 * nowNum å¤„</span></span><br><span class="line">                <span class="type">MipsImm</span> <span class="variable">offsetOperand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MipsImm</span>(-(argc - i) * <span class="number">4</span>);</span><br><span class="line">                MipsBuilder.buildStore(src, MipsRealReg.SP, offsetOperand, getParent(), isByte);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ ˆçš„ç”Ÿé•¿</span></span><br><span class="line">        <span class="keyword">if</span> (argc &gt; <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="comment">// å‘ä¸‹ç”Ÿé•¿4 * allNum: SP = SP - 4 * allNum</span></span><br><span class="line">            <span class="type">MipsOperand</span> <span class="variable">offsetOperand</span> <span class="operator">=</span> MipsBuilder.buildImmOperand(<span class="number">4</span> * (argc - <span class="number">4</span>), <span class="literal">true</span>, MipsFactory.curIrFunction, getParent());</span><br><span class="line">            MipsBuilder.buildBinary(MipsBinary.BinaryType.SUBU, MipsRealReg.SP, MipsRealReg.SP, offsetOperand, getParent());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‚æ•°å‡†å¤‡å¦¥å½“åï¼Œå†æ‰§è¡ŒjalæŒ‡ä»¤</span></span><br><span class="line">        mipsBlock.addInstruction(call);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™æ¡è¯­å¥æ‰§è¡Œå®Œæˆçš„åœºåˆï¼Œæ°æ˜¯ä»å‡½æ•°ä¸­è¿”å›</span></span><br><span class="line">        <span class="comment">// æ ˆçš„æ¢å¤ ä¸ç”Ÿé•¿ç›¸åï¼ŒåšåŠ æ³•å³å¯</span></span><br><span class="line">        <span class="keyword">if</span> (argc &gt; <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="type">MipsOperand</span> <span class="variable">offsetOperand</span> <span class="operator">=</span> MipsBuilder.buildImmOperand(<span class="number">4</span> * (argc - <span class="number">4</span>), <span class="literal">true</span>, MipsFactory.curIrFunction, getParent());</span><br><span class="line">            MipsBuilder.buildBinary(MipsBinary.BinaryType.ADDU, MipsRealReg.SP, MipsRealReg.SP, offsetOperand, getParent());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å› ä¸ºå¯„å­˜å™¨åˆ†é…æ˜¯ä»¥å‡½æ•°ä¸ºå•ä½çš„ï¼Œæ‰€ä»¥ç›¸å½“äº call æŒ‡ä»¤åªéœ€è¦è€ƒè™‘åœ¨è°ƒç”¨è€…å‡½æ•°ä¸­çš„å½±å“</span></span><br><span class="line">        <span class="comment">// é‚£ä¹ˆ call å¯¹åº”çš„ bl æŒ‡ä»¤ä¼šä¿®æ”¹ lr å’Œ r0 (å¦‚æœæœ‰è¿”å›å€¼çš„è¯)</span></span><br><span class="line">        <span class="comment">// æ­¤å¤–ï¼Œr0 - r3 æ˜¯è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨ï¼Œè¿™ä¼šå¯¼è‡´å¯èƒ½éœ€è¦é¢å¤–çš„æ“ä½œ mov ï¼Œæ‰€ä»¥è¿™è¾¹è€ƒè™‘å…¨éƒ¨å¼„æˆè¢«è°ƒç”¨è€…ä¿å­˜</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            call.addDefReg(<span class="keyword">new</span> <span class="title class_">MipsRealReg</span>(<span class="string">&quot;a&quot;</span> + i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// éå†…å»ºå‡½æ•°éœ€è¦ä¿å­˜è¿”å›åœ°å€ ra</span></span><br><span class="line">        <span class="keyword">if</span> (!function.isLibFunc()) &#123;</span><br><span class="line">            call.addDefReg(MipsRealReg.RA);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¤„ç†è¿”å›å€¼</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨è€…åº”å½“ä¿å­˜ v0ï¼Œæ— è®ºæœ‰æ²¡æœ‰è¿”å›å€¼</span></span><br><span class="line">        <span class="type">ValueType</span> <span class="variable">returnType</span> <span class="operator">=</span> function.getReturnType();</span><br><span class="line">        call.addDefReg(MipsRealReg.V0);</span><br><span class="line">        <span class="comment">// å¸¦æœ‰è¿”å›å€¼ï¼Œåˆ™éœ€è¦è®°å½•è¯¥è¿”å›å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (!(returnType <span class="keyword">instanceof</span> VoidType)) &#123;</span><br><span class="line">            <span class="type">MipsOperand</span> <span class="variable">dst</span> <span class="operator">=</span> MipsBuilder.buildOperand(<span class="built_in">this</span>, <span class="literal">false</span>, MipsFactory.curIrFunction, getParent());</span><br><span class="line">            MipsBuilder.buildMove(dst, MipsRealReg.V0, getParent());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="MipsFunctionï¼šä¿å­˜ç°åœº"><a href="#MipsFunctionï¼šä¿å­˜ç°åœº" class="headerlink" title="MipsFunctionï¼šä¿å­˜ç°åœº"></a>MipsFunctionï¼šä¿å­˜ç°åœº</h4><p>MipsFunctionæ˜¯Mipså‡½æ•°å¯¹è±¡ã€‚</p>
<p>åœ¨ä¸Callçš„å…³ç³»ä¸­ï¼ŒMipsFunctionæ˜¯è¢«è°ƒç”¨çš„ä¸€æ–¹ï¼Œç”±MipsFunctionè´Ÿè´£ä¿å­˜ç°åœºã€‚</p>
<p>å¦‚ä¸‹æ–¹æ³•èƒ½å¤Ÿè®°å½•åœ¨æœ¬å‡½æ•°å†…æœ‰æ”¹åŠ¨ï¼ˆdefï¼‰çš„å¯„å­˜å™¨ï¼ŒåŒæ—¶è®¡ç®—æ ˆå¸§å¤§å°ã€‚è¿™äº›å¯„å­˜å™¨åœ¨è¿”å›è°ƒç”¨è€…åå¯èƒ½æœ‰æ”¹å˜ï¼Œéœ€è¦ä¿å­˜åœ¨æ ˆå¸§å†…ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ˆä¸Šçš„ç©ºé—´ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡ä¸ºï¼š</span></span><br><span class="line"><span class="comment">     * 1.è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨</span></span><br><span class="line"><span class="comment">     * 2.å…¶ä»–alloca</span></span><br><span class="line"><span class="comment">     * 3.å‚æ•°alloca</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rebuildStack</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// éå†ä¸‹å±æ‰€æœ‰è¯­å¥ï¼Œè®°å½•æ‰€æœ‰ç”¨è¿‡çš„å¯„å­˜å™¨ï¼Œä½œä¸ºå‡½æ•°è°ƒç”¨å‰è¦ä¿å­˜çš„ç°åœº</span></span><br><span class="line">        <span class="keyword">for</span> (MipsBlock block : blocks) &#123;</span><br><span class="line">            <span class="keyword">for</span> (MipsInstruction instruction : block.getInstructions()) &#123;</span><br><span class="line">                <span class="comment">// ä¿å­˜å†™è¿‡çš„å¯„å­˜å™¨(çš„ç±»å‹)</span></span><br><span class="line">                <span class="keyword">for</span> (MipsOperand defReg : instruction.getDefRegs()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (defReg <span class="keyword">instanceof</span> MipsRealReg) &#123;</span><br><span class="line">                        <span class="type">RegType</span> <span class="variable">regType</span> <span class="operator">=</span> ((MipsRealReg) defReg).getType();</span><br><span class="line">                        <span class="keyword">if</span> (RegType.regsNeedProtection.contains(regType)) &#123;</span><br><span class="line">                            regsNeedSaving.add(regType);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;[MipsFunction] defRegä¸­æ··å…¥äº†éç‰©ç†å¯„å­˜å™¨ï¼&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// éœ€è¦åˆ†é…çš„ç”¨äºä¿å­˜ç°åœºçš„ç©ºé—´</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">stackRegSize</span> <span class="operator">=</span> <span class="number">4</span> * regsNeedSaving.size();</span><br><span class="line">        System.out.println(stackRegSize);</span><br><span class="line">        <span class="keyword">for</span> (RegType regType : regsNeedSaving) &#123;</span><br><span class="line">            System.out.println(regType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ€»çš„ç©ºé—´å¤§å°ï¼šallocaç©ºé—´ + ä¿å­˜ç°åœºçš„ç©ºé—´</span></span><br><span class="line">        totalStackSize = stackRegSize + allocaSize;</span><br><span class="line">        <span class="comment">// æ›´æ–°å…ˆå‰è®°å½•çš„ ä¿å­˜åœ¨æ ˆä¸Šçš„å‚æ•° çš„ä½ç§»</span></span><br><span class="line">        <span class="keyword">for</span> (MipsImm argOffset : argOffsets) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">newOffset</span> <span class="operator">=</span> argOffset.getValue() + totalStackSize;</span><br><span class="line">            argOffset.setValue(newOffset);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        System.out.println(&quot;é‡å»ºå‡½æ•°æ ˆ&quot; + getName() + &quot;, stackRegSize:&quot; + stackRegSize + &quot;, allocaSize:&quot; + allocaSize);</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ä¿å­˜ç°åœºçš„å…·ä½“ä»£ç åˆ™ç›´æ¥æ”¾åœ¨äº† <code>MipsFunction</code>çš„æ‰“å°å¤„ï¼Œå®é™…ä¸Šæ²¡æœ‰åŠ å…¥æŒ‡ä»¤åºåˆ—ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éœ€è¦è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment">     * å‡½æ•° label</span></span><br><span class="line"><span class="comment">     * ä¿å­˜è¢«è°ƒç”¨è€…å¯„å­˜å™¨</span></span><br><span class="line"><span class="comment">     * ç§»åŠ¨æ ˆæŒ‡é’ˆ sp</span></span><br><span class="line"><span class="comment">     * åŸºæœ¬å—çš„mipsä»£ç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isLibFunc) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        sb.append(name).append(<span class="string">&quot;:\n&quot;</span>);</span><br><span class="line">        <span class="comment">// éä¸»å‡½æ•°éœ€è¦ä¿å­˜å¯„å­˜å™¨</span></span><br><span class="line">        <span class="keyword">if</span> (!name.equals(<span class="string">&quot;main&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// ä¿å­˜ç°åœº</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">stackOffset</span> <span class="operator">=</span> -<span class="number">4</span>;</span><br><span class="line">            <span class="keyword">for</span> (RegType regType : regsNeedSaving) &#123;</span><br><span class="line">                <span class="comment">// ä¿å­˜ä½ç½®ï¼š-stackOffset($SP)</span></span><br><span class="line">                sb.append(<span class="string">&quot;\t&quot;</span>).append(<span class="string">&quot;sw\t&quot;</span>).append(regType).append(<span class="string">&quot;,\t&quot;</span>)</span><br><span class="line">                        .append(stackOffset).append(<span class="string">&quot;($sp)\n&quot;</span>);</span><br><span class="line">                <span class="comment">// ç»§ç»­å‘ä¸‹ç”Ÿé•¿</span></span><br><span class="line">                stackOffset -= <span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// $SP = $SP - totalStackSize</span></span><br><span class="line">        <span class="keyword">if</span> (totalStackSize != <span class="number">0</span>) &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;\taddiu\t$sp,\t$sp,\t&quot;</span>).append(-totalStackSize).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        System.out.println(blocks);</span></span><br><span class="line">        <span class="comment">// ç”ŸæˆåŸºæœ¬å—çš„mips</span></span><br><span class="line">        <span class="keyword">for</span> (MipsBlock block : blocks) &#123;</span><br><span class="line">            sb.append(block);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="MipsRetï¼šæ¢å¤ç°åœº"><a href="#MipsRetï¼šæ¢å¤ç°åœº" class="headerlink" title="MipsRetï¼šæ¢å¤ç°åœº"></a>MipsRetï¼šæ¢å¤ç°åœº</h4><p>MipsRetæ˜¯Mipsçš„è¿”å›æŒ‡ä»¤å¯¹è±¡ï¼Œç”±llvmçš„RetæŒ‡ä»¤ç›´æ¥ç¿»è¯‘è€Œæ¥ã€‚</p>
<p>Retå¯¹è±¡ä¼šè®°å½•å…¶æ‰€å±çš„MipsFunctionï¼Œä»¥æ–¹ä¾¿åœ°å–ç”¨å¯„å­˜å™¨çš„ä¿å­˜ä¿¡æ¯ã€‚</p>
<p>åŒæ ·åœ°ï¼Œæ¢å¤ç°åœºçš„å…·ä½“ä»£ç åˆ™ç›´æ¥æ”¾åœ¨äº† <code>MipsRet</code>çš„æ‰“å°å¤„ï¼Œå®é™…ä¸Šæ²¡æœ‰åŠ å…¥æŒ‡ä»¤åºåˆ—ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">stackSize</span> <span class="operator">=</span> function.getTotalStackSize();</span><br><span class="line">        <span class="comment">// è¿”å›å‰å°†SPå¤ä½</span></span><br><span class="line">        <span class="keyword">if</span> (stackSize != <span class="number">0</span>) &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;addiu\t$sp, \t$sp,\t&quot;</span>).append(stackSize).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸»å‡½æ•°ç›´æ¥ç»“æŸè¿è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (function.getName().equals(<span class="string">&quot;main&quot;</span>)) &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;\tli\t$v0,\t10\n&quot;</span>);</span><br><span class="line">            sb.append(<span class="string">&quot;\tsyscall\n\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// éä¸»å‡½æ•°ï¼Œéœ€è¦æ¢å¤ç°åœº</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// åœ¨è¿”å›ä¹‹å‰å›å¤å¯„å­˜å™¨å¯„å­˜å™¨</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">stackOffset</span> <span class="operator">=</span> -<span class="number">4</span>;</span><br><span class="line">            <span class="keyword">for</span> (RegType regType : function.getRegsNeedSaving()) &#123;</span><br><span class="line">                sb.append(<span class="string">&quot;\t&quot;</span>).append(<span class="string">&quot;lw\t&quot;</span>).append(regType).append(<span class="string">&quot;,\t&quot;</span>).append(stackOffset).append(<span class="string">&quot;($sp)\n&quot;</span>);</span><br><span class="line">                stackOffset -= <span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è·³è½¬è¿”å›</span></span><br><span class="line">            sb.append(<span class="string">&quot;\tjr\t$ra\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä»£ç ä¼˜åŒ–"><a href="#ä»£ç ä¼˜åŒ–" class="headerlink" title="ä»£ç ä¼˜åŒ–"></a>ä»£ç ä¼˜åŒ–</h2><h3 id="æ€»è®º"><a href="#æ€»è®º" class="headerlink" title="æ€»è®º"></a>æ€»è®º</h3><p>ä¼˜åŒ–åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯åˆ†æå‹ä¼˜åŒ–ï¼Œè¿™ç§ç±»å‹çš„ä¼˜åŒ–å¹¶ä¸ä¼šæ”¹å˜ llvm ir çš„ç»“æ„ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šæœ‰å®é™…çš„ä¼˜åŒ–æ•ˆæœï¼Œä½†æ˜¯å®ƒä»¬åˆ†æå‡ºæ¥çš„ä¿¡æ¯ï¼Œä¼šå»æŒ‡å¯¼åŠ å·¥å‹ä¼˜åŒ–çš„è¿›è¡Œã€‚å¦ä¸€ç§æ˜¯åŠ å·¥å‹ä¼˜åŒ–ï¼Œè¿™ç§ä¼˜åŒ–ä¼šçœŸæ­£æ”¹å˜ llvm ir &amp; mips çš„ç»“æ„ï¼Œè¾¾åˆ°ä¼˜åŒ–çš„ç›®çš„ã€‚</p>
<h3 id="æ§åˆ¶æµå›¾æ„å»º"><a href="#æ§åˆ¶æµå›¾æ„å»º" class="headerlink" title="æ§åˆ¶æµå›¾æ„å»º"></a>æ§åˆ¶æµå›¾æ„å»º</h3><p>åœ¨æ„å»ºæ§åˆ¶æµå›¾ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¿›è¡Œç®€å•çš„æ­»ä»£ç åˆ é™¤ï¼š</p>
<p>è¯¥éƒ¨åˆ†ä¼šåˆ é™¤æ‰€æœ‰ <code>ret</code>æŒ‡ä»¤åçš„ä»£ç ã€‚</p>
<p><strong>è¿™å…¶å®æ˜¯ä¸ºäº†è§£å†³åœ¨debugæ—¶å‘ç°çš„ä¸€ä¸ªä¸¥é‡é”™è¯¯ï¼šä¸ºäº†ç¡®ä¿åœ¨æ„å»ºæ§åˆ¶æµå›¾æ—¶ï¼Œä¸ä¼šäº§ç”Ÿå¥‡æ€ªçš„åç»§ï¼Œä»è€Œå¯¼è‡´æ§åˆ¶æµå›¾æ„å»ºé”™è¯¯ã€<code>phi</code>æŒ‡ä»¤æŠ¥é”™</strong>ã€‚</p>
<p>åœ¨é‡åˆ° <code>ret</code>æŒ‡ä»¤åï¼Œåˆ é™¤æ‰€æœ‰æŒ‡ä»¤å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deadCodeEmit</span><span class="params">(BasicBlock block)</span> &#123;</span><br><span class="line">        LinkedList&lt;Instruction&gt; instructions = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;(block.getInstructions());</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (Instruction instruction : instructions) &#123;</span><br><span class="line">            <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                instruction.dropAllOperands();</span><br><span class="line">                instruction.eraseFromParent();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (instruction <span class="keyword">instanceof</span> Ret || instruction <span class="keyword">instanceof</span> Br) &#123;</span><br><span class="line">                flag = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ”¯é…åˆ†æ"><a href="#æ”¯é…åˆ†æ" class="headerlink" title="æ”¯é…åˆ†æ"></a>æ”¯é…åˆ†æ</h3><blockquote>
<p>[!IMPORTANT]</p>
<p>åœ¨è¿›è¡Œå¾ˆå¤šåˆ†æä¹‹å‰ï¼Œéƒ½éœ€è¦è¿›è¡Œæ”¯é…åˆ†æï¼Œè¿™æ˜¯å› ä¸ºæ”¯é…æ ‘ä¼šæä¾›å¾ˆå¤šçš„æ”¯é…æµä¿¡æ¯ï¼Œå°¤å…¶æ˜¯æ•°æ®æ˜¯æ€æ ·åœ¨æ•°æ®å—ä¸­æµåŠ¨ï¼Œå“ªäº›æ•°æ®å¿…ç„¶ä»è¿™ä¸ªå—æµå…¥å¦ä¸€ä¸ªå—ï¼Œå¯ä»¥è¯´ï¼Œæ”¯é…ä¿¡æ¯æ˜¯å¯¹äº CFG å›¾çš„ä¸€ç§é«˜åº¦å‡ç»ƒçš„è¡¨è¾¾ã€‚</p>
<p>åœ¨æ±‚è§£æ”¯é…æ ‘çš„æ—¶å€™ï¼Œåˆ†ä¸ºä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥é¦–å…ˆæ”¯é…è€…å’Œè¢«æ”¯é…è€…ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸åŠ¨ç‚¹é—®é¢˜ï¼Œåˆ©ç”¨çš„å…¬å¼æ˜¯</p>
</blockquote>
<p>$$<br>temp &#x3D; {index} \cup (\bigcap_{j \in preds(index)} domer(j) )<br>$$</p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>éœ€è¦ä¸€ç›´æ±‚è§£åˆ°ä¸å‘ç”Ÿå˜åŒ–ä¸ºæ­¢ã€‚</p>
<p>ç¬¬äºŒæ­¥æ˜¯è®¡ç®—æ”¯é…è¾¹ç•Œï¼Œæ„é€ æ”¯é…æ ‘ï¼Œæ”¯é…æ ‘æ˜¯æ¯”åŸæ¥çš„æ”¯é…å›¾æ›´åŠ ç›´è§‚è€Œä¸”â€œå¼ºâ€çš„æ¡ä»¶ï¼Œæˆ‘ä»¬åœ¨ä¼˜åŒ–ä¸­ä¸€èˆ¬ä¹Ÿæ˜¯ä½¿ç”¨æ”¯é…æ ‘çš„ä¿¡æ¯æ¡ä»¶ã€‚æ‰€è°“æ”¯é…è¾¹ç•Œï¼Œå°±æ˜¯æ°å¥½ä¸è¢«æ”¯é…çš„ä¸€ä¸ªå—ã€‚</p>
<p>éœ€è¦å¼ºè°ƒï¼Œæ”¯é…æ ‘ä¸ä»…åº”ç”¨åœ¨ç¼–è¯‘é¢†åŸŸï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„å›¾è®ºç®—æ³•ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç½‘ä¸Šæ‰¾åˆ°è¯¦å®çš„èµ„æ–™ï¼Œæ‰€ä»¥å¯¹äºç®—æ³•é—®é¢˜å°±ä¸èµ˜è¿°ã€‚</p>
<p>æ”¯é…åˆ†æåŸºäº CFGå›¾ä¼šè¢«ç”¨åœ¨ LoopInfoAnalyzeï¼Œ mem2regï¼Œæ‰€ä»¥åªè¦ CFG å‘ç”Ÿæ”¹å˜ï¼Œå°±ä¼šéœ€è¦é‡æ–°åˆ†æã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¡ç®—æ”¯é…ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> function å¾…åˆ†æçš„å‡½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">passDominanceInfo</span><span class="params">(Function function)</span> &#123;</span><br><span class="line">        <span class="comment">// å…¥å£å—</span></span><br><span class="line">        <span class="type">BasicBlock</span> <span class="variable">entryBlock</span> <span class="operator">=</span> function.getHeadBlock();</span><br><span class="line">        <span class="comment">// åŸºæœ¬å—çš„æ•°ç›®</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">blockNum</span> <span class="operator">=</span> function.getBasicBlocks().size();</span><br><span class="line">        <span class="comment">// æ¯ä¸ªåŸºæœ¬å—éƒ½æœ‰ä¸€ä¸ª bitSetï¼Œç”¨äºè¡¨ç¤ºè¿™ä¸ªå—çš„ domer</span></span><br><span class="line">        ArrayList&lt;BitSet&gt; domers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(blockNum);</span><br><span class="line">        ArrayList&lt;BasicBlock&gt; blocks = function.getBasicBlocks();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½œä¸º block çš„ç´¢å¼•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (BasicBlock block : blocks) &#123;</span><br><span class="line">            domers.add(<span class="keyword">new</span> <span class="title class_">BitSet</span>());</span><br><span class="line">            <span class="comment">// å…¥å£å—çš„æ”¯é…è€…æ˜¯è‡ªå·±</span></span><br><span class="line">            <span class="keyword">if</span> (block == entryBlock) &#123;</span><br><span class="line">                domers.get(index).set(index);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                domers.get(index).set(<span class="number">0</span>, blockNum);</span><br><span class="line">            &#125;</span><br><span class="line">            index++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸åŠ¨ç‚¹ç®—æ³• è®¡ç®—domer</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">changed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (changed) &#123;</span><br><span class="line">            changed = <span class="literal">false</span>;</span><br><span class="line">            index = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// éå†åŸºæœ¬å—</span></span><br><span class="line">            <span class="keyword">for</span> (BasicBlock curBlock : blocks) &#123;</span><br><span class="line">                <span class="comment">// å¯¹äºéå…¥å£å—</span></span><br><span class="line">                <span class="keyword">if</span> (curBlock != entryBlock) &#123;</span><br><span class="line">                    <span class="comment">// temp åˆå§‹å…¨ç½®1</span></span><br><span class="line">                    <span class="type">BitSet</span> <span class="variable">temp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BitSet</span>();</span><br><span class="line">                    temp.set(<span class="number">0</span>, blockNum);</span><br><span class="line">                    <span class="comment">// å°±æ˜¯ä¸‹é¢çš„å…¬å¼</span></span><br><span class="line">                    <span class="comment">// temp &lt;- &#123;index&#125; \cup (\BigCap_&#123;j \in preds(index)&#125; domer(j) )</span></span><br><span class="line">                    <span class="keyword">for</span> (BasicBlock preBlock : curBlock.getPreBlocks()) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">preIndex</span> <span class="operator">=</span> blocks.indexOf(preBlock);</span><br><span class="line">                        temp.and(domers.get(preIndex));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// è‡ªå·±ä¹Ÿæ˜¯è‡ªå·±çš„domer</span></span><br><span class="line">                    temp.set(index);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è‹¥tempæ›´æ–°ï¼Œåˆ™temp èµ‹ç»™domer</span></span><br><span class="line">                    <span class="keyword">if</span> (!temp.equals(domers.get(index))) &#123;</span><br><span class="line">                        domers.get(index).clear();</span><br><span class="line">                        domers.get(index).or(temp);</span><br><span class="line">                        changed = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                index++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°†domerä¿¡æ¯å­˜å…¥æ‰€æœ‰åŸºæœ¬å—</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; blockNum; i++) &#123;</span><br><span class="line">            <span class="type">BasicBlock</span> <span class="variable">curBlock</span> <span class="operator">=</span> blocks.get(i);</span><br><span class="line">            <span class="type">BitSet</span> <span class="variable">domerInfo</span> <span class="operator">=</span> domers.get(i);</span><br><span class="line">            <span class="comment">// éå†bitsetï¼Œæ‰¾åˆ°å¹¶è®°å½•æ¯ä¸€ä¸ªæ”¯é…è€…</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">domerIndex</span> <span class="operator">=</span> domerInfo.nextSetBit(<span class="number">0</span>); domerIndex &gt;= <span class="number">0</span>; domerIndex = domerInfo.nextSetBit(domerIndex + <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="type">BasicBlock</span> <span class="variable">domerBlock</span> <span class="operator">=</span> blocks.get(domerIndex);</span><br><span class="line">                curBlock.getDomers().add(domerBlock);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¡ç®—æ‰€æœ‰åŸºæœ¬å—çš„ï¼šç›´æ¥æ”¯é…è€… ç›´æ¥è¢«æ”¯é…è€…</span></span><br><span class="line">        <span class="keyword">for</span> (BasicBlock curBlock : blocks) &#123;</span><br><span class="line">            <span class="comment">// éå†å½“å‰å—çš„æ”¯é…è€…</span></span><br><span class="line">            <span class="keyword">for</span> (BasicBlock maybeIdomerBlock : curBlock.getDomers()) &#123;</span><br><span class="line">                <span class="comment">// æ’é™¤è‡ªèº«</span></span><br><span class="line">                <span class="keyword">if</span> (maybeIdomerBlock != curBlock) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isIdom</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">for</span> (BasicBlock domerBlock : curBlock.getDomers()) &#123;</span><br><span class="line">                        <span class="comment">// maybeIdomerBlockæ”¯é…äº†domerBlockï¼ŒdomerBlockæ”¯é…curBlockï¼Œè¡¨æ˜å¹¶ä¸æ˜¯ç›´æ¥çš„æ”¯é…è€…</span></span><br><span class="line">                        <span class="keyword">if</span> (domerBlock != curBlock &amp;&amp; domerBlock != maybeIdomerBlock &amp;&amp; domerBlock.getDomers().contains(maybeIdomerBlock)) &#123;</span><br><span class="line">                            isIdom = <span class="literal">false</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// æ˜¯ç›´æ¥æ”¯é…å—ï¼Œåˆ™åŒæ–¹éƒ½è¦äº’ç›¸ç™»è®°</span></span><br><span class="line">                    <span class="keyword">if</span> (isIdom) &#123;</span><br><span class="line">                        curBlock.setIdomer(maybeIdomerBlock);</span><br><span class="line">                        maybeIdomerBlock.getIdomees().add(curBlock);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// calculate dom level</span></span><br><span class="line">        passDominanceLevel(entryBlock, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="å‡½æ•°è°ƒç”¨åˆ†æ"><a href="#å‡½æ•°è°ƒç”¨åˆ†æ" class="headerlink" title="å‡½æ•°è°ƒç”¨åˆ†æ"></a>å‡½æ•°è°ƒç”¨åˆ†æ</h3><blockquote>
<p>[!IMPORTANT]</p>
<p>å¦‚æœåœ¨è°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…ä¹‹é—´æ„å»ºä¸€æ¡æœ‰å‘è¾¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ„å»ºä¸€ä¸ªå‡½æ•°è°ƒç”¨å›¾ï¼Œå‡½æ•°è°ƒç”¨å…³ç³»ä¸»è¦æ˜¯ä¸ºäº†åé¢çš„å‰¯ä½œç”¨åˆ†æï¼Œæ— ç”¨å‡½æ•°åˆ é™¤åšå‡†å¤‡ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¸€èˆ¬ä¸ä¼šå•ç‹¬ä½œä¸ºä¸€ä¸ª pass ï¼Œè¿™æ˜¯å› ä¸ºè¿™ä¸ªç”¨çš„å¾ˆå¤šï¼ŒåŸºæœ¬ä¸Šæ˜¯éšç”¨éšåšã€‚</p>
<p>å› ä¸º <code>SysY</code>å¹¶ä¸æ”¯æŒå‡½æ•°å£°æ˜ï¼Œæ‰€ä»¥å…¶å®ä¸ä¼šå‡ºç°å¾ªç¯é€’å½’æˆ–è€…å…¶ä»–çš„é˜´é—´æƒ…å†µï¼Œè¿™æ— ç–‘å¯¹åé¢æ˜¯ä¸€ä¸ªå¥½æ¶ˆæ¯ã€‚</p>
</blockquote>
<h3 id="å‰¯ä½œç”¨åˆ†æ"><a href="#å‰¯ä½œç”¨åˆ†æ" class="headerlink" title="å‰¯ä½œç”¨åˆ†æ"></a>å‰¯ä½œç”¨åˆ†æ</h3><blockquote>
<p>[!IMPORTANT]</p>
<p>æ‰€è°“çš„å‰¯ä½œç”¨ï¼ˆSideEffectï¼‰ï¼Œå…¶å®æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ¦‚å¿µï¼Œå¤§æ¦‚å°±æ˜¯æˆ‘ä»¬ä¸å–œæ¬¢çš„ä½œç”¨ï¼Œå°±ä¼šè¢«å«åšå‰¯ä½œç”¨ã€‚åœ¨ä¸­ç«¯çš„å‰¯ä½œç”¨ï¼ŒæŒ‡çš„æ˜¯æŸä¸ªæŒ‡ä»¤æˆ–è€…å‡½æ•°ï¼Œä¼šä¸ä¼šå¯¹å†…å­˜æˆ–è€… IO é€ æˆå½±å“ï¼Œå¦‚æœä¸ä¼šï¼Œé‚£ä¹ˆå°±æ˜¯æ²¡æœ‰å‰¯ä½œç”¨çš„ã€‚</p>
<p>æ²¡æœ‰å‰¯ä½œç”¨çš„ä¸œè¥¿å¾ˆè‰¯å¥½ï¼Œå› ä¸ºä»–ä»¬é€ æˆçš„å”¯ä¸€å½±å“åªèƒ½é€šè¿‡è¿”å›å€¼ï¼Œæ‰€ä»¥å¦‚æœè¿”å›å€¼æ²¡æœ‰ç”¨åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªä¸œè¥¿å°±å¯ä»¥å»æ‰äº†ã€‚ä¸ä»…ä»…æ˜¯å»æ‰è¿™ä¹ˆæš´åŠ›ï¼Œå¦‚æœæ²¡æœ‰å‰¯ä½œç”¨ï¼Œç›¸å½“äºæœ‰äº†ä¸€ä¸ªå¾ˆâ€œå¼ºâ€çš„æ¡ä»¶ä¿è¯ï¼Œæˆ‘ä»¬å¯¹äºæŸäº›ä¼˜åŒ–çš„è¿›è¡Œä¼šå˜å¾—æ›´åŠ è‡ªä¿¡ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªå‡½æ•°å¦‚æœæ²¡æœ‰å‰¯ä½œç”¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æŠŠä»–å½“æˆä¸€æ¡æŒ‡ä»¤å¤„ç†ï¼Œå¯¹äº</p>
</blockquote>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">%i1</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> f(<span class="variable">%a1</span>)<span class="comment">;</span></span><br><span class="line"><span class="variable">%i2</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> f(<span class="variable">%a1</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>[!IMPORTANT]</p>
<p>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ¤æ–­ <code>i1 == i2</code> æ˜¯å¾ˆå¥½çš„ä¸œè¥¿ã€‚</p>
<p>è¿›è¡Œå‰¯ä½œç”¨åˆ†æçš„æ—¶å€™ï¼Œéœ€è¦å…ˆæ„å»ºä¸€ä¸ªå‡½æ•°è°ƒç”¨å…³ç³»å›¾ï¼Œè¿™æ˜¯å› ä¸ºæœ‰çš„å‡½æ•°æœ¬èº«å¹¶ä¸ä¼šé€ æˆå‰¯ä½œç”¨ï¼Œä½†æ˜¯ä»–è°ƒç”¨çš„å‡½æ•°å°±ä¼šæœ‰å‰¯ä½œç”¨ï¼Œå¯¼è‡´è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¹Ÿä¼šæœ‰å‰¯ä½œç”¨ã€‚</p>
<p>æˆ‘ä»¬ä¸€èˆ¬è®¤ä¸ºè¿™å‡ ä¸ªä¸œè¥¿æœ‰å‰¯ä½œç”¨</p>
<ul>
<li><p>store æŒ‡ä»¤</p>
</li>
<li><p>call å†…è”å‡½æ•°</p>
</li>
<li><p>call æœ‰å‰¯ä½œç”¨çš„å‡½æ•°</p>
<p>å‰¯ä½œç”¨åˆ†æä¼šè¢«ç”¨åœ¨ <code>AggressiveDeadCodeEmit</code> ä¸­ã€‚</p>
</li>
</ul>
</blockquote>
<h3 id="Mem2Reg"><a href="#Mem2Reg" class="headerlink" title="Mem2Reg"></a>Mem2Reg</h3><p>åœ¨ <code>LLVMç”Ÿæˆ</code>éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†SSAçš„ä¸¤ç§å½¢å¼ï¼šèµ°è®¿å­˜åé—¨çš„SSAï¼Œå’ŒçœŸæ­£èƒ½æé«˜æ•ˆç‡çš„é‡‡å– <code>phi</code>çš„çœŸSSA ã€‚</p>
<p>åœ¨è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†è¿›è¡Œå¦‚ä¸‹ä¸¤é¡¹å·¥ä½œä»¥é‡æ„llvmä»£ç ï¼š</p>
<ul>
<li>åé—¨SSAä¸­ï¼Œç¹å¤ <code>alloca</code>,<code>store</code>,<code>load</code>ä¸‰ä»¶å¥—çš„å½»åº•é“²é™¤ä¼˜åŒ–ã€‚</li>
<li><code>phi</code>æŒ‡ä»¤çš„æ’å…¥ä¸å˜é‡çš„é‡å‘½åã€‚</li>
</ul>
<blockquote>
<p>[!IMPORTANT]</p>
<p>ä¸€ä¸ªåŸºæœ¬å—çš„å¼€å§‹éœ€è¦æ’å…¥ä¸€ä¸ªå˜é‡çš„ phi èŠ‚ç‚¹çš„æ¡ä»¶ï¼Œæ˜¯è¿™ä¸ªåŸºæœ¬å—æ˜¯è¿™ä¸ªå˜é‡æŸä¸ªå®šä¹‰çš„æ”¯é…è¾¹ç•Œã€‚è¿™ä¸ªæ“ä½œéœ€è¦è¿­ä»£ï¼Œäº‹å®ä¸Šå°±åªéœ€è¦å»ºç«‹ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ¯æ¬¡å–å‡ºé˜Ÿé¦–ï¼Œè®¡ç®—å…¶æ”¯é…è¾¹ç•Œï¼Œå¹¶æŠŠæ–°ç®—å‡ºçš„æ”¯é…è¾¹ç•Œæ’å…¥åˆ°é˜Ÿåˆ—çš„æœ«å°¾ã€‚</p>
<p>æ³¨æ„ï¼Œè¿™æ—¶çš„ phi èŠ‚ç‚¹è¿˜æ˜¯ç©ºçš„ï¼Œå³åªæœ‰å·¦å€¼æ²¡æœ‰å³å€¼ã€‚</p>
</blockquote>
<h3 id="ç®€å•çš„è¿ç®—å¼ºåº¦å‰Šå¼±"><a href="#ç®€å•çš„è¿ç®—å¼ºåº¦å‰Šå¼±" class="headerlink" title="ç®€å•çš„è¿ç®—å¼ºåº¦å‰Šå¼±"></a>ç®€å•çš„è¿ç®—å¼ºåº¦å‰Šå¼±</h3><p>å³å¯¹äº <code>a * 0, 0 / a, a % 1, a / a</code>è¿™ä¸€ç±»æŒ‡ä»¤æå‰å®Œæˆä¼˜åŒ–ï¼Œé¿å…ç¹å¤è®¡ç®—</p>
<h3 id="Aggressive-Dead-Code-Emit"><a href="#Aggressive-Dead-Code-Emit" class="headerlink" title="Aggressive Dead Code Emit"></a>Aggressive Dead Code Emit</h3><blockquote>
<p>[!IMPORTANT]</p>
<p>åœ¨è¿™ä¸€æ­¥ä¸­æˆ‘ä»¬è®¤ä¸ºçš„æ­»ä»£ç ï¼Œå°±æ˜¯ä¸ä¼šå¯¹ç¨‹åºé€ æˆå½±å“çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸â€œå‰¯ä½œç”¨åˆ†æâ€ç±»ä¼¼çš„çœ¼å…‰å»çœ‹ï¼Œæ‰€æœ‰çš„è®¿å­˜æŒ‡ä»¤ï¼Œreturn æŒ‡ä»¤ï¼Œcall ä¸€ä¸ªæœ‰å‰¯ä½œç”¨çš„å‡½æ•°ï¼Œåˆ†æ”¯æŒ‡ä»¤ï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯<strong>æœ‰ç”¨çš„</strong>ï¼Œæˆ‘ä»¬ä¸èƒ½åˆ é™¤ï¼Œé‚£ä¹ˆè¿™äº›æŒ‡ä»¤ä½¿ç”¨åˆ°çš„æŒ‡ä»¤ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä¸èƒ½åˆ é™¤çš„ï¼Œä»¥æ­¤ç±»æ¨ï¼Œè¿™æ ·æ±‚å‡ºä¸€ä¸ª<strong>æœ‰ç”¨æŒ‡ä»¤çš„é—­åŒ…</strong>ï¼Œæ‰€æœ‰ä¸åœ¨è¿™ä¸ªæŒ‡ä»¤é—­åŒ…å†…çš„æŒ‡ä»¤ï¼Œéƒ½æ˜¯æ­»ä»£ç ï¼Œæ˜¯å¯ä»¥åˆ é™¤çš„ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DFSæ±‚è§£é—­åŒ…</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">findUsefulClosure</span><span class="params">(Instruction instruction)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!usefulInstrClosure.contains(instruction)) &#123;</span><br><span class="line">            <span class="comment">// è®°å½•æ‰€æœ‰ç”¨åˆ°çš„æŒ‡ä»¤</span></span><br><span class="line">            usefulInstrClosure.add(instruction);</span><br><span class="line">            <span class="keyword">for</span> (Value operand : instruction.getOperands()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (operand <span class="keyword">instanceof</span> Instruction) &#123;</span><br><span class="line">                    findUsefulClosure((Instruction) operand);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deleteDeadInstructions</span><span class="params">(Function curFunction)</span> &#123;</span><br><span class="line">        usefulInstrClosure.clear();</span><br><span class="line">        <span class="keyword">for</span> (BasicBlock basicBlock : curFunction.getBasicBlocks()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Instruction instruction : basicBlock.getInstructions()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isUseful(instruction)) &#123;</span><br><span class="line">                    findUsefulClosure(instruction);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ é™¤ä¸åœ¨é—­åŒ…å†…çš„æŒ‡ä»¤</span></span><br><span class="line">        <span class="keyword">for</span> (BasicBlock basicBlock : curFunction.getBasicBlocks()) &#123;</span><br><span class="line">            LinkedList&lt;Instruction&gt; newInstructions = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Instruction instruction : basicBlock.getInstructions()) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">delete</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (!usefulInstrClosure.contains(instruction)) &#123;</span><br><span class="line">                    instruction.dropAllOperands();</span><br><span class="line">                    delete = <span class="literal">true</span>;</span><br><span class="line">                    <span class="comment">//instruction.eraseFromParent();</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!delete) &#123;</span><br><span class="line">                    newInstructions.add(instruction);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            basicBlock.setInstructions(newInstructions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="å…¨å±€å˜é‡å±€éƒ¨åŒ–"><a href="#å…¨å±€å˜é‡å±€éƒ¨åŒ–" class="headerlink" title="å…¨å±€å˜é‡å±€éƒ¨åŒ–"></a>å…¨å±€å˜é‡å±€éƒ¨åŒ–</h3><blockquote>
<p>[!IMPORTANT]</p>
<p>å› ä¸ºå…¨å±€å˜é‡çš„è®¿é—®éœ€è¦åœ¨ llvm ä¸­è®¿å­˜ï¼Œæ¯”è¾ƒä½æ•ˆï¼Œæ‰€ä»¥è€ƒè™‘å¯¹äºåªè¢«ä¸€ä¸ªå‡½æ•°ä½¿ç”¨äº†çš„å…¨å±€å˜é‡ï¼ˆè¿™å°±æ²¡æœ‰æ„ä¹‰æ˜¯å…¨å±€çš„äº†ï¼‰ï¼Œå°†å…¶ç§»å…¥æˆå±€éƒ¨å˜é‡ã€‚</p>
</blockquote>
<h3 id="ä¹˜é™¤æ³•ä¼˜åŒ–"><a href="#ä¹˜é™¤æ³•ä¼˜åŒ–" class="headerlink" title="ä¹˜é™¤æ³•ä¼˜åŒ–"></a>ä¹˜é™¤æ³•ä¼˜åŒ–</h3><p>å¯¹äºå¤„ç†å™¨æ¥è¯´ï¼Œæ‰§è¡Œä¹˜é™¤æ³•çš„ä»£ä»·è¦è¿œå¤§äºæ‰§è¡Œå…¶ä»–æŒ‡ä»¤ï¼Œè€Œæ‰§è¡Œé™¤æ³•çš„ä»£ä»·åˆè¿œå¤§äºä¹˜æ³•çš„ä»£ä»·ï¼Œæ‰€ä»¥æˆ‘ä»¬ç†æƒ³çš„æƒ…å†µæ˜¯é€šè¿‡ç®—æœ¯è¿ç®—å°†é™¤å¸¸æ•°è½¬åŒ–ä¸ºä¹˜æ³•å’Œç§»ä½æŒ‡ä»¤ï¼Œå°†ä¹˜å¸¸æ•°è½¬åŒ–ä¸ºç§»ä½å’Œå…¶ä»–æŒ‡ä»¤ã€‚</p>
<h4 id="ä¹˜æ³•ä¼˜åŒ–"><a href="#ä¹˜æ³•ä¼˜åŒ–" class="headerlink" title="ä¹˜æ³•ä¼˜åŒ–"></a>ä¹˜æ³•ä¼˜åŒ–</h4><p>ä¹˜æ³•å¯ä»¥è¢«ä¼˜åŒ–æˆåŠ æ³•å’Œç§»ä½æ“ä½œï¼Œå› ä¸ºä¹˜æ³•çš„ä»£ä»·æ˜¯ 4ï¼Œæ‰€ä»¥åŠ æ³•å’Œç§»ä½æ“ä½œæœ€å¤šæœ‰ 3 æ¡ï¼Œé‚£ä¹ˆè€ƒè™‘â€œç§»ä½-åŠ æ³•-ç§»ä½â€çš„ç»„åˆï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯å¯ä»¥æ‹†å‡ºä¸¤æ¡ç§»ä½æŒ‡ä»¤ï¼Œé‚£ä¹ˆå¯ä»¥æšä¸¾ 32 ä½å†…ç”±ä¸Šè¿°ç»„åˆå¯ä»¥è¾¾åˆ°çš„ç»„åˆï¼Œç„¶åè®°å½•ä¸‹æ¥ã€‚åœ¨ä¹˜æ³•è¿ç®—çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‰ç…§äº‹å…ˆå‡†å¤‡çš„è¿›è¡Œæ“ä½œã€‚</p>
<h4 id="é™¤æ³•ä¼˜åŒ–"><a href="#é™¤æ³•ä¼˜åŒ–" class="headerlink" title="é™¤æ³•ä¼˜åŒ–"></a>é™¤æ³•ä¼˜åŒ–</h4><p>å¯¹äºä»»ä½•å¤„ç†å™¨ï¼Œè¿›è¡Œé™¤æ³•è®¡ç®—æ‰€éœ€è¦çš„æ—¶é—´éƒ½è¿œè¿œé«˜äºä¹˜æ³•å’Œç§»ä½è¿ç®—ï¼ˆå½“ç„¶è¿™ä¸¤è€…ä¹Ÿä¸åœ¨ä¸€ä¸ªé‡çº§ä¸Šï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ä¸€ç§æƒ³æ³•ï¼Œå°±æ˜¯æŠŠé™¤æ³•è½¬æ¢æˆä¹˜æ³•å’Œç§»ä½æ“ä½œï¼Œä¹Ÿå°±æ˜¯</p>
<p>$$<br>\tt{quotient &#x3D; \frac{dividend}{divisor} &#x3D; (dividend \times multiplier) &gt;&gt; shift}<br>$$</p>
<p>å…·ä½“å®ç°åˆ™å‚è€ƒäº†æ•™ç¨‹æ‰€ç»™è®ºæ–‡ï¼š<strong>Division by Invariant Integers using Multiplication</strong>ã€‚</p>
<h3 id="å›¾ç€è‰²å¯„å­˜å™¨åˆ†é…"><a href="#å›¾ç€è‰²å¯„å­˜å™¨åˆ†é…" class="headerlink" title="å›¾ç€è‰²å¯„å­˜å™¨åˆ†é…"></a>å›¾ç€è‰²å¯„å­˜å™¨åˆ†é…</h3><p>é¦–å…ˆä»¥å‡½æ•°ä¸ºå•ä½ï¼Œå¯¹å…¶æ‰€æœ‰åŸºæœ¬å—è¿›è¡Œæ´»è·ƒå˜é‡åˆ†æã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯¹ä¸€ä¸ªå‡½æ•°ä»¥å—ä¸ºå•ä½è¿›è¡Œæ´»è·ƒå˜é‡åˆ†æ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ä¸€ä¸ªæ¯ä¸ª block éƒ½å¯¹åº”çš„ä¸€ä¸ª info çš„ map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;MipsBlock, BlockLiveVarInfo&gt; <span class="title function_">liveAnalysis</span><span class="params">(MipsFunction func)</span> &#123;</span><br><span class="line">        HashMap&lt;MipsBlock, BlockLiveVarInfo&gt; liveInfoMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// å¼€å§‹éå†æ¯ä¸€ä¸ª block</span></span><br><span class="line">        <span class="keyword">for</span> (MipsBlock block : func.getMipsBlocks()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">BlockLiveVarInfo</span> <span class="variable">blockLiveInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BlockLiveVarInfo</span>();</span><br><span class="line">            liveInfoMap.put(block, blockLiveInfo);</span><br><span class="line">            <span class="comment">// å¼€å§‹éå† block ä¸­çš„æŒ‡ä»¤, è·Ÿå®šä¹‰ä¸­çš„ä¸€æ¨¡ä¸€æ ·</span></span><br><span class="line">            <span class="keyword">for</span> (MipsInstruction instruction : block.getInstructions()) &#123;</span><br><span class="line">                <span class="comment">// è¿˜æ²¡å®šä¹‰å°±è¢«ä½¿ç”¨ï¼Œè¿™é‡Œæ˜¯æ­£ç¡®çš„</span></span><br><span class="line">                instruction.getUseRegs().stream()</span><br><span class="line">                        .filter(MipsOperand::needsColor)</span><br><span class="line">                        .filter(use -&gt; !blockLiveInfo.liveDef.contains(use))</span><br><span class="line">                        .forEach(blockLiveInfo.liveUse::add);</span><br><span class="line">                <span class="comment">// è¿˜æ²¡ä½¿ç”¨å°±è¢«å®šä¹‰ï¼Œè¿™é‡Œåº”è¯¥æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºå®šä¹‰å°±æ˜¯å®šä¹‰ï¼Œå°±æ˜¯æ€æ­»ï¼Œä¸ä¼šå› ä¸ºä½¿ç”¨è€Œä¸æ€æ­»</span></span><br><span class="line">                instruction.getDefRegs().stream()</span><br><span class="line">                        .filter(MipsOperand::needsColor)</span><br><span class="line">                        .forEach(blockLiveInfo.liveDef::add);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è¿™é‡Œåº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜çš„</span></span><br><span class="line">            blockLiveInfo.liveIn.addAll(blockLiveInfo.liveUse);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸åŠ¨ç‚¹</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">changed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (changed) &#123;</span><br><span class="line">            changed = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// å¼€å§‹éå† func ä¸­çš„ block</span></span><br><span class="line">            <span class="keyword">for</span> (MipsBlock block : func.getMipsBlocks()) &#123;</span><br><span class="line">                <span class="type">BlockLiveVarInfo</span> <span class="variable">blockLiveInfo</span> <span class="operator">=</span> liveInfoMap.get(block);</span><br><span class="line">                HashSet&lt;MipsOperand&gt; newLiveOut = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä¸‹é¢æ˜¯åŠ å…¥ä¸¤ä¸ªåç»§,è¿™é‡Œæ˜¯æ­£ç¡®çš„ï¼ŒLiveOut å°±æ˜¯ LiveIn çš„å¹¶é›†</span></span><br><span class="line">                <span class="keyword">if</span> (block.getTrueSucBlock() != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">BlockLiveVarInfo</span> <span class="variable">sucBlockInfo</span> <span class="operator">=</span> liveInfoMap.get(block.getTrueSucBlock());</span><br><span class="line">                    newLiveOut.addAll(sucBlockInfo.liveIn);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (block.getFalseSucBlock() != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">BlockLiveVarInfo</span> <span class="variable">sucBlockInfo</span> <span class="operator">=</span> liveInfoMap.get(block.getFalseSucBlock());</span><br><span class="line">                    newLiveOut.addAll(sucBlockInfo.liveIn);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ç¬¬ä¸€æ¬¡çš„æ—¶å€™åº”è¯¥æ˜¯æ²¡æœ‰åŠæ³• equal çš„ï¼Œè¿™æ˜¯å› ä¸ºä¹‹å‰ liveOut å¹¶æ²¡æœ‰è¢«èµ‹å€¼</span></span><br><span class="line">                <span class="keyword">if</span> (!newLiveOut.equals(blockLiveInfo.liveOut)) &#123;</span><br><span class="line">                    changed = <span class="literal">true</span>;</span><br><span class="line">                    blockLiveInfo.liveOut = newLiveOut;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è¿™é‡Œæ¨¡æ‹Ÿçš„æ˜¯ LiveUse</span></span><br><span class="line">                    blockLiveInfo.liveIn = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(blockLiveInfo.liveUse);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// liveIn = liveUse + liveOut - liveDef</span></span><br><span class="line">                    blockLiveInfo.liveOut.stream()</span><br><span class="line">                            .filter(objOperand -&gt; !blockLiveInfo.liveDef.contains(objOperand))</span><br><span class="line">                            .forEach(blockLiveInfo.liveIn::add);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> liveInfoMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åŸºäºæ´»è·ƒå˜é‡åˆ†æçš„ç»“æœï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å›¾ç€è‰²ç®—æ³•äº†ï¼š</p>
<p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼Œéå†æ‰€æœ‰å‡½æ•°ï¼Œå¯¹äºæ¯ä¸ªå‡½æ•°ï¼Œè¿›è¡Œæ´»è·ƒå˜é‡åˆ†æç›´è‡³ä¸å†å˜åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿›è¡Œå¯„å­˜å™¨åˆ†é…</span></span><br><span class="line"><span class="comment">     * å…¥å£æ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buildRegs</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰å‡½æ•°</span></span><br><span class="line">        <span class="keyword">for</span> (MipsFunction function : mipsModule.getFunctions()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (function.isLibFunc()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            curFunction = function;</span><br><span class="line">            <span class="comment">// å¯¹äºæ¯ä¸ªå‡½æ•°ï¼Œè¿›è¡Œæ´»è·ƒå˜é‡åˆ†æç›´è‡³ä¸å†å˜åŒ–</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">finished</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">while</span> (!finished) &#123;</span><br><span class="line">                initStatus();</span><br><span class="line">                buildConflictGraph();</span><br><span class="line">                buildWorklist();</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!simplifyList.isEmpty()) &#123;</span><br><span class="line">                        doSimplify();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!mergableMoves.isEmpty()) &#123;</span><br><span class="line">                        coalesce();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!freezeList.isEmpty()) &#123;</span><br><span class="line">                        doFreeze();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!spillList.isEmpty()) &#123;</span><br><span class="line">                        doSelectSpill();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">while</span> (!(simplifyList.isEmpty() &amp;&amp; mergableMoves.isEmpty() &amp;&amp;</span><br><span class="line">                        freezeList.isEmpty() &amp;&amp; spillList.isEmpty()));</span><br><span class="line">                assignColors(function);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å®é™…æº¢å‡ºçš„èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (spilledNodes.isEmpty()) &#123;</span><br><span class="line">                    finished = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å­˜åœ¨å®é™…æº¢å‡ºçš„ç‚¹</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        rewriteProgram(function);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;[RewriteProgramException] &quot;</span> + e + <span class="string">&quot;, function: &quot;</span> + function.getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å› ä¸ºåœ¨ color çš„æ—¶å€™ï¼Œä¼šæŠŠ isAllocated è®¾ç½®æˆ trueï¼Œè¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½å°±æ˜¯è®¾ç½®æˆ false</span></span><br><span class="line">        <span class="comment">// åº”è¯¥æ˜¯ä¸ºäº†é¿å…ç‰©ç†å¯„å­˜å™¨åœ¨åˆ¤å®š equals æ—¶çš„é”™è¯¯</span></span><br><span class="line">        resetRealRegState();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (MipsFunction function1 : mipsModule.getFunctions()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (function1.isLibFunc()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            function1.rebuildStack();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ„é€ å†²çªå›¾-build"><a href="#æ„é€ å†²çªå›¾-build" class="headerlink" title="æ„é€ å†²çªå›¾(build)"></a><strong>æ„é€ å†²çªå›¾(build)</strong></h4><p>æœ¬é˜¶æ®µçš„ä¸»è¦ä»»åŠ¡æ˜¯é€šè¿‡æ•°æ®æµåˆ†ææ–¹æ³•ï¼Œè®¡ç®—åœ¨æ¯æ¡æŒ‡ä»¤æ‰§è¡Œæ—¶åŒæ—¶æ´»è·ƒçš„ä¸´æ—¶å˜é‡ï¼Œè¯¥é›†åˆçš„æ¯ä¸€å¯¹ä¸´æ—¶å˜é‡ä¸¤ä¸¤å½¢æˆä¸€æ¡è¾¹åŠ å…¥å†²çªå›¾ä¸­ï¼Œ</p>
<p>æ„é€ é˜¶æ®µçš„ä¸»è¦å·¥ä½œæ˜¯è¿›è¡Œæ•°æ®æµåˆ†æï¼Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šåŸºæœ¬å—çš„æ•°æ®æµåˆ†æï¼ŒæŒ‡ä»¤é—´çš„æ•°æ®æµåˆ†æï¼Œå¾—åˆ°å†²çªå›¾ï¼ŒæŒ‡ä»¤å†²çªçš„æ¡ä»¶æ˜¯åœ¨å˜é‡å®šä¹‰å¤„æ‰€æœ‰å‡ºå£æ´»è·ƒçš„å˜é‡å’Œå®šä¹‰çš„å˜é‡æ˜¯äº’ç›¸å†²çªçš„ï¼Œä»¥åŠåŒä¸€æ¡æŒ‡ä»¤çš„å‡ºå£å˜é‡äº’ç›¸ä¹‹é—´æ˜¯å†²çªçš„ã€‚</p>
<h4 id="ç®€åŒ–ï¼ˆsimplifyï¼‰"><a href="#ç®€åŒ–ï¼ˆsimplifyï¼‰" class="headerlink" title="ç®€åŒ–ï¼ˆsimplifyï¼‰"></a><strong>ç®€åŒ–ï¼ˆsimplifyï¼‰</strong></h4><p>è¿›è¡Œå¯å‘å¼å›¾ç€è‰²ï¼Œåˆ é™¤åº¦æ•°å°äºKï¼ˆé€šç”¨å¯„å­˜å™¨ä¸ªæ•°ï¼‰çš„èŠ‚ç‚¹ï¼Œç®€åŒ–å†²çªå›¾ï¼Œäº§ç”Ÿæ›´å¤šå›¾ç€è‰²æœºä¼šã€‚</p>
<p>å…·ä½“çš„åšæ³•æ˜¯å¯¹äºä¸€ä¸ªèŠ‚ç‚¹mï¼Œå¦‚æœå®ƒçš„åº¦æ•°å°äºKï¼Œé‚£ä¹ˆå°†å®ƒä»å†²çªå›¾å½“ä¸­åˆ é™¤ï¼Œå¹¶ä¸”å°†å…¶å‹å…¥æ ˆä¸­ï¼Œä»¥ä¾¿è¿›è¡Œåç»­çš„ç€è‰²ã€‚</p>
<p>è¿™æ ·è¿›è¡Œå¯å‘å¼åˆ é™¤ä¹‹åï¼Œéƒ½ä¼šå‡å°‘å…¶ä»–ç»“ç‚¹çš„åº¦æ•°ï¼Œä»è€Œäº§ç”Ÿæ›´å¤šçš„ç®€åŒ–çš„æœºä¼šï¼Œå¹¶ä¸”ä¹Ÿä¸ºä¹‹åçš„åˆå¹¶æä¾›æ›´å¤šæœºä¼šï¼Œè¿™è¦æ±‚åœ¨è¿™ä¸ªé˜¶æ®µä¸ä¼šç®€åŒ–éå†»ç»“æŒ‡ä»¤ã€‚</p>
<h4 id="åˆå¹¶ï¼ˆcoalesceï¼‰"><a href="#åˆå¹¶ï¼ˆcoalesceï¼‰" class="headerlink" title="åˆå¹¶ï¼ˆcoalesceï¼‰"></a><strong>åˆå¹¶ï¼ˆcoalesceï¼‰</strong></h4><p>è¿›è¡Œä¿å®ˆçš„åˆå¹¶ï¼Œå‡å°‘æœ€ç»ˆä»£ç çš„moveæŒ‡ä»¤ã€‚</p>
<p>å¯¹äºmoveæŒ‡ä»¤ï¼ˆä¾‹å¦‚ <code>move $2, $3</code>ï¼‰ï¼Œæºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°å®é™…ä¸Šç›¸åŒï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥å°†ä¸¤ä¸ªèŠ‚ç‚¹åˆå¹¶ï¼Œå‡å°‘ä¸€æ¡moveæŒ‡ä»¤çš„ä»£ä»·ï¼Œä½†æ˜¯ï¼Œåˆå¹¶ä¸¤ä¸ªç»“ç‚¹ä¹‹åï¼Œä¸¤ä¸ªèŠ‚ç‚¹çš„æ´»è·ƒèŒƒå›´ä¼šå¢åŠ ï¼Œå…¶é‚»æ¥ç»“ç‚¹çš„é›†åˆå®é™…ä¸Šæ˜¯åŸæ¥ä¸¤ä¸ªé›†åˆçš„å¹¶é›†ï¼Œè¿™ç§æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›èƒ½å¤Ÿç€è‰²çš„èŠ‚ç‚¹å˜ä¸ºè¢«æº¢å‡ºçš„ç»“ç‚¹ï¼Œè¿™æ ·å°±å¾—ä¸å¿å¤±äº†ï¼Œå› æ­¤æˆ‘ä»¬ç»™å‡ºçš„ä¸€ç§ç­–ç•¥æ˜¯åœ¨åˆå¹¶çš„æ—¶å€™è¿›è¡Œåˆ¤æ–­ï¼Œä¿è¯åˆå¹¶ä¹‹åé«˜åº¦æ•°ï¼ˆåº¦æ•°&gt;&#x3D;Kï¼‰çš„ç»“ç‚¹ä¸ä¼šå¢åŠ ã€‚é€šè¿‡ç®€åŒ–ä¹‹åï¼Œå†²çªå›¾å¾ˆå¤šèŠ‚ç‚¹çš„åº¦æ•°å·²ç»é™ä½ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™åˆå¹¶çš„æœºä¼šå¯èƒ½å¤šäºåŸæœ‰çš„å†²çªå›¾ã€‚</p>
<p>åˆå¹¶çš„æ•ˆæœé€šå¸¸å†³å®šäº†æ•´ä¸ªå›¾ç€è‰²ç®—æ³•çš„è´¨é‡ï¼Œå¦å¤–ç”±äºåœ¨è¿›è¡ŒæŒ‡ä»¤é€‰æ‹©ä¹‹å‰éœ€è¦æ¶ˆPHIï¼Œä¼šåœ¨è¿™ä¸ªæ—¶å€™äº§ç”Ÿå¾ˆå¤šå†—ä½™çš„moveæŒ‡ä»¤ï¼Œé€šè¿‡å›¾ç€è‰²çš„æ—¶å€™è¿›è¡Œåˆå¹¶èƒ½å¤Ÿæå¤§çš„å‡å°‘å†—ä½™çš„moveæŒ‡ä»¤ï¼Œè¿™å¯¹ç¨‹åºæ€§èƒ½çš„æå‡éå¸¸å¤§ã€‚</p>
<h4 id="å†»ç»“ï¼ˆfreezeï¼‰"><a href="#å†»ç»“ï¼ˆfreezeï¼‰" class="headerlink" title="å†»ç»“ï¼ˆfreezeï¼‰"></a><strong>å†»ç»“ï¼ˆfreezeï¼‰</strong></h4><p>åœ¨è¿›è¡Œç®€åŒ–å’Œåˆå¹¶ä¹‹åï¼Œæœ‰ä¸€äº›å˜é‡æ— æ³•è¿›è¡Œåˆå¹¶ï¼Œå¹¶ä¸”å¯ä»¥è¿›è¡Œç®€åŒ–ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å°†å…¶æ ‡è®°ä¸ºä¼ é€å†»ç»“çš„ç»“ç‚¹ï¼Œé‡æ–°å¼€å§‹ç®€åŒ–é˜¶æ®µã€‚</p>
<h4 id="æº¢å‡ºï¼ˆspillï¼‰"><a href="#æº¢å‡ºï¼ˆspillï¼‰" class="headerlink" title="æº¢å‡ºï¼ˆspillï¼‰"></a><strong>æº¢å‡ºï¼ˆspillï¼‰</strong></h4><p>ç®€åŒ–å’Œåˆå¹¶å®Œæˆä¹‹åï¼Œå†²çªå›¾ä¸­åªå‰©ä¸‹é«˜åº¦æ•°ï¼ˆåº¦æ•°&gt;&#x3D;Kï¼‰çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨å›¾ä¸­é€‰æ‹©ä¸€ä¸ªé«˜åº¦æ•°çš„ç»“ç‚¹ï¼Œå°†å®ƒå­˜å…¥å†…å­˜å½“ä¸­ï¼Œç„¶åå°†å®ƒå‹å…¥æ ˆä¸­ã€‚è¿™ä¸ªæ—¶å€™å…¶ä»–ç»“ç‚¹çš„åº¦æ•°é™ä½ï¼Œå¯ä»¥ç»§ç»­è¿›è¡Œç®€åŒ–ã€‚</p>
<h4 id="é€‰æ‹©ï¼ˆselectï¼‰"><a href="#é€‰æ‹©ï¼ˆselectï¼‰" class="headerlink" title="é€‰æ‹©ï¼ˆselectï¼‰"></a><strong>é€‰æ‹©ï¼ˆselectï¼‰</strong></h4><p>å¯¹è™šæ‹Ÿå¯„å­˜å™¨æŒ‡æ´¾é¢œè‰²ï¼Œå³åˆ†é…çœŸå®çš„å¯„å­˜å™¨ã€‚å…·ä½“åšæ³•æ˜¯ä»¥ä¸€ä¸ªç©ºå›¾å¼€å§‹ï¼Œä»æ ˆä¸­å¼¹å‡ºä¸€ä¸ªèŠ‚ç‚¹ï¼ŒåŠ å…¥åˆ°å†²çªå›¾ä¸­ï¼Œå¹¶ä¸”ä¸ºä»–æŒ‡æ´¾ä¸€ç§é¢œè‰²ï¼Œè¯¥èŠ‚ç‚¹å¿…é¡»æ˜¯å¯ç€è‰²çš„ï¼Œå¯ç€è‰²çš„æ¡ä»¶æ˜¯å…¶é‚»æ¥ç»“ç‚¹ä½¿ç”¨çš„é¢œè‰²å°äºçœŸå®çš„å¯„å­˜å™¨æ•°Kï¼Œå¯¹äºç®€åŒ–é˜¶æ®µå…¥æ ˆçš„å˜é‡æ˜¾ç„¶ä¸€å®šèƒ½å¤Ÿç€è‰²ï¼Œå¯¹äºæº¢å‡ºé˜¶æ®µå…¥æ ˆçš„å˜é‡ï¼Œé€šè¿‡åˆå¹¶ä¹‹åï¼Œé‚»æ¥ç‚¹ä¸­æœ‰ä¸€äº›å˜é‡çš„é¢œè‰²ç›¸åŒï¼Œæœ€åé‚»æ¥ç‚¹çš„é¢œè‰²å°äºKç§ï¼Œèƒ½å¤Ÿè¿›è¡Œç€è‰²ï¼Œå¯ä»¥å°†å…¶åŠ å…¥å†²çªå›¾ä¸­ï¼Œå¦åˆ™å°†å…¶åŠ å…¥æ— æ³•è¿›è¡Œç€è‰²çš„é›†åˆä¸­ã€‚</p>
<h4 id="é‡æ–°å¼€å§‹-restart"><a href="#é‡æ–°å¼€å§‹-restart" class="headerlink" title="é‡æ–°å¼€å§‹(restart)"></a><strong>é‡æ–°å¼€å§‹(restart)</strong></h4><p>å¦‚æœæ— æ³•è¿›è¡Œç€è‰²çš„é›†åˆä¸ä¸ºç©ºï¼Œé‚£ä¹ˆåˆ™éœ€è¦æ”¹å†™ç¨‹åºï¼Œä¸ºè¿™äº›å˜é‡åœ¨å†…å­˜å½“ä¸­åˆ†é…ç©ºé—´ï¼Œå¹¶ä¸”åœ¨æ¯æ¬¡ä½¿ç”¨éœ€è¦å°†å…¶ä»å†…å­˜å½“ä¸­å–å‡ºï¼Œæ¯æ¬¡ä¿®æ”¹éœ€è¦å­˜è¿›å†…å­˜å½“ä¸­ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæº¢å‡ºçš„ä¸´æ—¶å˜é‡ä¼šè½¬å˜ä¸ºå‡ ä¸ªæ´»è·ƒèŒƒå›´å¾ˆå°çš„æ–°çš„ä¸´æ—¶å˜é‡ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦é‡æ–°è¿›è¡Œæ´»è·ƒåˆ†æã€å¯„å­˜å™¨åˆ†é…ï¼Œç›´åˆ°æ²¡æœ‰æº¢å‡ºå’Œç®€åŒ–ä¸ºæ­¢ï¼ˆé€šå¸¸åªéœ€è¦è¿­ä»£ä¸€ä¸¤æ¬¡ï¼‰ã€‚</p>
<h3 id="çª¥å­”ä¼˜åŒ–"><a href="#çª¥å­”ä¼˜åŒ–" class="headerlink" title="çª¥å­”ä¼˜åŒ–"></a>çª¥å­”ä¼˜åŒ–</h3><p>å¯¹äºç›¸é‚»çš„éƒ¨åˆ†å°‘é‡æŒ‡ä»¤è¿›è¡Œä¼˜åŒ–ã€‚</p>
<h4 id="å¤„ç†æ— æ„ä¹‰çš„åŠ å‡æ³•"><a href="#å¤„ç†æ— æ„ä¹‰çš„åŠ å‡æ³•" class="headerlink" title="å¤„ç†æ— æ„ä¹‰çš„åŠ å‡æ³•"></a>å¤„ç†æ— æ„ä¹‰çš„åŠ å‡æ³•</h4><table>
<thead>
<tr>
<th align="center">æ—§æŒ‡ä»¤</th>
<th align="center">æ–°æŒ‡ä»¤</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>add/sub r0, r0, 0</code></td>
<td align="center">åˆ é™¤</td>
</tr>
<tr>
<td align="center"><code>add/sub r0, r1, 0</code></td>
<td align="center"><code>move r0, r1</code></td>
</tr>
</tbody></table>
<h4 id="å¤„ç†æ— æ„ä¹‰çš„mov"><a href="#å¤„ç†æ— æ„ä¹‰çš„mov" class="headerlink" title="å¤„ç†æ— æ„ä¹‰çš„mov"></a>å¤„ç†æ— æ„ä¹‰çš„mov</h4><table>
<thead>
<tr>
<th align="center">æ—§æŒ‡ä»¤</th>
<th align="center">æ–°æŒ‡ä»¤</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>move r0, r0</code></td>
<td align="center">åˆ é™¤</td>
</tr>
</tbody></table>
<h4 id="å¤„ç†å¯¹åŒä¸€ä¸ªdstçš„è¿ç»­mov"><a href="#å¤„ç†å¯¹åŒä¸€ä¸ªdstçš„è¿ç»­mov" class="headerlink" title="å¤„ç†å¯¹åŒä¸€ä¸ªdstçš„è¿ç»­mov"></a>å¤„ç†å¯¹åŒä¸€ä¸ªdstçš„è¿ç»­mov</h4><table>
<thead>
<tr>
<th align="center">æ—§æŒ‡ä»¤</th>
<th align="center">æ–°æŒ‡ä»¤</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>move r0, r1 move r0, r2 â€¦ move r0, rk</code></td>
<td align="center"><code>move r0, rk</code></td>
</tr>
</tbody></table>
<h4 id="å¤„ç†å‘ç›¸é‚»å—æˆ–è€…æ— æ„ä¹‰å—çš„è·³è½¬"><a href="#å¤„ç†å‘ç›¸é‚»å—æˆ–è€…æ— æ„ä¹‰å—çš„è·³è½¬" class="headerlink" title="å¤„ç†å‘ç›¸é‚»å—æˆ–è€…æ— æ„ä¹‰å—çš„è·³è½¬"></a>å¤„ç†å‘ç›¸é‚»å—æˆ–è€…æ— æ„ä¹‰å—çš„è·³è½¬</h4><table>
<thead>
<tr>
<th align="center">æ—§æŒ‡ä»¤</th>
<th align="center">æ–°æŒ‡ä»¤</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>j next_block</code></td>
<td align="center">Move r0, rk</td>
</tr>
</tbody></table>
<h4 id="å¤„ç†å‘åŒä¸€ä¸ªåœ°å€çš„å­˜å‚¨-åŠ è½½çš„store-loadå¯¹"><a href="#å¤„ç†å‘åŒä¸€ä¸ªåœ°å€çš„å­˜å‚¨-åŠ è½½çš„store-loadå¯¹" class="headerlink" title="å¤„ç†å‘åŒä¸€ä¸ªåœ°å€çš„å­˜å‚¨+åŠ è½½çš„store+loadå¯¹"></a>å¤„ç†å‘åŒä¸€ä¸ªåœ°å€çš„å­˜å‚¨+åŠ è½½çš„store+loadå¯¹</h4><table>
<thead>
<tr>
<th align="center">æ—§æŒ‡ä»¤</th>
<th align="center">æ–°æŒ‡ä»¤</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>store a, memory load b, sameMemory</code></td>
<td align="center"><code>move b, a</code></td>
</tr>
</tbody></table>
</div><div class="article-licensing box"><div class="licensing-title"><p>RooKie_Z Compilerç¼–è¯‘å™¨è®¾è®¡æ–‡æ¡£</p><p><a href="https://rookie-zgy1513.github.io/2025/08/14/compiler/">https://rookie-zgy1513.github.io/2025/08/14/compiler/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>ä½œè€…</h6><p>RooKie_Z</p></div></div><div class="level-item is-narrow"><div><h6>å‘å¸ƒäº</h6><p>2025-08-14</p></div></div><div class="level-item is-narrow"><div><h6>æ›´æ–°äº</h6><p>2025-08-15</p></div></div><div class="level-item is-narrow"><div><h6>è®¸å¯åè®®</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/compiler/">compiler</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=689f30d60faa3a7358f6b458&amp;product=inline-share-buttons" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2025/08/14/database/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">å­¦æµ·ä¼´èˆªâ€”â€”æ•™è¾…å¹³å°ç³»ç»Ÿè®¾è®¡æ–‡æ¡£</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2025/08/14/challenge-shell/"><span class="level-item">RooKie_Z challenge-shellå®ç°æŠ¥å‘Š</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card" id="comments"><div class="card-content"><h3 class="title is-5">è¯„è®º</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "0ac4eb1c2a293bfe97e2d15581ca092e",
            repo: "rookie-zgy1513.github.io",
            owner: "rookie-zgy1513",
            clientID: "Ov23li6vyFeMUxsyVjCc",
            clientSecret: "28debacc0df80666a6064a7f00cdad1cb7ad9248",
            admin: ["rookie-zgy1513"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="RooKie_Z"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">RooKie_Z</p><p class="is-size-6 is-block">RooKie_Zçš„å°çª</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>BeiJing ğŸ‡¨ğŸ‡³</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">æ–‡ç« </p><a href="/archives/"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">åˆ†ç±»</p><a href="/categories/"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">æ ‡ç­¾</p><a href="/tags/"><p class="title">5</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/rookie-zgy1513" target="_blank" rel="me noopener">å…³æ³¨æˆ‘</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/rookie-zgy1513"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Twitter" href="https://x.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Instagram" href="https://instagram.com"><i class="fab fa-instagram"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Bilibili" href="https://bilibili.com"><i class="fab fa-bilibili"></i></a></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">å½’æ¡£</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2025/08/"><span class="level-start"><span class="level-item">å…«æœˆ 2025</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">æ ‡ç­¾</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OO/"><span class="tag">OO</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OS/"><span class="tag">OS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/compiler/"><span class="tag">compiler</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/database/"><span class="tag">database</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">é“¾æ¥</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://ppoffice.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Icarus</span></span><span class="level-right"><span class="level-item tag">ppoffice.github.io</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">ç›®å½•</h3><ul class="menu-list"><li><a class="level is-mobile" href="#å†™åœ¨å‰é¢"><span class="level-left"><span class="level-item">1</span><span class="level-item">å†™åœ¨å‰é¢</span></span></a></li><li><a class="level is-mobile" href="#â€œå…è´£å£°æ˜â€"><span class="level-left"><span class="level-item">2</span><span class="level-item">â€œå…è´£å£°æ˜â€</span></span></a></li><li><a class="level is-mobile" href="#å‚è€ƒç¼–è¯‘å™¨ä»‹ç»"><span class="level-left"><span class="level-item">3</span><span class="level-item">å‚è€ƒç¼–è¯‘å™¨ä»‹ç»</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#æ€»ä½“ç»“æ„"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">æ€»ä½“ç»“æ„</span></span></a></li><li><a class="level is-mobile" href="#æ¥å£è®¾è®¡"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">æ¥å£è®¾è®¡</span></span></a></li><li><a class="level is-mobile" href="#æ–‡ä»¶ç»„ç»‡"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">æ–‡ä»¶ç»„ç»‡</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ç¼–è¯‘å™¨æ€»ä½“è®¾è®¡"><span class="level-left"><span class="level-item">4</span><span class="level-item">ç¼–è¯‘å™¨æ€»ä½“è®¾è®¡</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#æ€»ä½“ç»“æ„-1"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">æ€»ä½“ç»“æ„</span></span></a></li><li><a class="level is-mobile" href="#æ¥å£è®¾è®¡-1"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">æ¥å£è®¾è®¡</span></span></a></li><li><a class="level is-mobile" href="#æ–‡ä»¶ç»„ç»‡-1"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">æ–‡ä»¶ç»„ç»‡</span></span></a></li></ul></li><li><a class="level is-mobile" href="#è¯æ³•åˆ†æ"><span class="level-left"><span class="level-item">5</span><span class="level-item">è¯æ³•åˆ†æ</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#å¤§ä½“æ€è·¯"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">å¤§ä½“æ€è·¯</span></span></a></li><li><a class="level is-mobile" href="#DFAçš„è®¾è®¡"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">DFAçš„è®¾è®¡</span></span></a></li><li><a class="level is-mobile" href="#Tokenç±»"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">Tokenç±»</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#æœ‰å…³æ–‡æ³•è®¾å®šéƒ¨åˆ†"><span class="level-left"><span class="level-item">5.3.1</span><span class="level-item">æœ‰å…³æ–‡æ³•è®¾å®šéƒ¨åˆ†</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#è¯­æ³•åˆ†æ"><span class="level-left"><span class="level-item">6</span><span class="level-item">è¯­æ³•åˆ†æ</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#å¤§ä½“æ€è·¯-1"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">å¤§ä½“æ€è·¯</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#nextSym-çš„å®ç°"><span class="level-left"><span class="level-item">6.1.1</span><span class="level-item">nextSym()çš„å®ç°</span></span></a></li><li><a class="level is-mobile" href="#å·¦é€’å½’çš„å¤„ç†"><span class="level-left"><span class="level-item">6.1.2</span><span class="level-item">å·¦é€’å½’çš„å¤„ç†</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#å³é€’å½’æ”¹å†™"><span class="level-left"><span class="level-item">6.1.2.1</span><span class="level-item">å³é€’å½’æ”¹å†™</span></span></a></li><li><a class="level is-mobile" href="#æ‰©å……çš„BNFèŒƒå¼"><span class="level-left"><span class="level-item">6.1.2.2</span><span class="level-item">æ‰©å……çš„BNFèŒƒå¼</span></span></a></li></ul></li><li><a class="level is-mobile" href="#å¤„ç†æ–¹å¼"><span class="level-left"><span class="level-item">6.1.3</span><span class="level-item">å¤„ç†æ–¹å¼</span></span></a></li><li><a class="level is-mobile" href="#å›æº¯æ³•"><span class="level-left"><span class="level-item">6.1.4</span><span class="level-item">å›æº¯æ³•</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Nodeç±»â€”â€”å‰ç«¯ğŸ”—ä¸­ç«¯çš„å…³é”®"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">Nodeç±»â€”â€”å‰ç«¯ğŸ”—ä¸­ç«¯çš„å…³é”®</span></span></a></li></ul></li><li><a class="level is-mobile" href="#è¯­ä¹‰åˆ†æ-é”™è¯¯å¤„ç†"><span class="level-left"><span class="level-item">7</span><span class="level-item">è¯­ä¹‰åˆ†æ&amp;&amp;é”™è¯¯å¤„ç†</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#é”™è¯¯æ€»è®º"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">é”™è¯¯æ€»è®º</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#è¯­æ³•-è¯æ³•é”™è¯¯"><span class="level-left"><span class="level-item">7.1.1</span><span class="level-item">è¯­æ³•&amp;&amp;è¯æ³•é”™è¯¯</span></span></a></li><li><a class="level is-mobile" href="#è¯­ä¹‰é”™è¯¯å¤„ç†-è¯­ä¹‰åˆ†æ"><span class="level-left"><span class="level-item">7.1.2</span><span class="level-item">è¯­ä¹‰é”™è¯¯å¤„ç† &amp;&amp; è¯­ä¹‰åˆ†æ</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ç¬¦å·Symbol"><span class="level-left"><span class="level-item">7.1.2.1</span><span class="level-item">ç¬¦å·Symbol</span></span></a></li><li><a class="level is-mobile" href="#ç¬¦å·è¡¨SymbolTable"><span class="level-left"><span class="level-item">7.1.2.2</span><span class="level-item">ç¬¦å·è¡¨SymbolTable</span></span></a></li><li><a class="level is-mobile" href="#ç¬¦å·è¡¨æ ˆSymbolTableStack"><span class="level-left"><span class="level-item">7.1.2.3</span><span class="level-item">ç¬¦å·è¡¨æ ˆSymbolTableStack</span></span></a></li><li><a class="level is-mobile" href="#å…¥æ ˆæ–°ç¬¦å·è¡¨çš„æ—¶æœº"><span class="level-left"><span class="level-item">7.1.2.4</span><span class="level-item">å…¥æ ˆæ–°ç¬¦å·è¡¨çš„æ—¶æœº</span></span></a></li><li><a class="level is-mobile" href="#æ·»åŠ æ–°ç¬¦å·çš„æ—¶æœº"><span class="level-left"><span class="level-item">7.1.2.5</span><span class="level-item">æ·»åŠ æ–°ç¬¦å·çš„æ—¶æœº</span></span></a></li></ul></li><li><a class="level is-mobile" href="#é”™è¯¯å¤„ç†çš„é€»è¾‘"><span class="level-left"><span class="level-item">7.1.3</span><span class="level-item">é”™è¯¯å¤„ç†çš„é€»è¾‘</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#é”™è¯¯è®°å½•æ–¹æ³•"><span class="level-left"><span class="level-item">7.1.3.1</span><span class="level-item">é”™è¯¯è®°å½•æ–¹æ³•</span></span></a></li><li><a class="level is-mobile" href="#è®°å½•é”™è¯¯çš„æ¥å£"><span class="level-left"><span class="level-item">7.1.3.2</span><span class="level-item">è®°å½•é”™è¯¯çš„æ¥å£</span></span></a></li><li><a class="level is-mobile" href="#å…·ä½“é”™è¯¯çš„å¤„ç†æ–¹æ³•"><span class="level-left"><span class="level-item">7.1.3.3</span><span class="level-item">å…·ä½“é”™è¯¯çš„å¤„ç†æ–¹æ³•</span></span></a></li></ul></li><li><a class="level is-mobile" href="#è¯­ä¹‰åˆ†æç»“æœè¾“å‡º"><span class="level-left"><span class="level-item">7.1.4</span><span class="level-item">è¯­ä¹‰åˆ†æç»“æœè¾“å‡º</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#LLVM-IRç”Ÿæˆ"><span class="level-left"><span class="level-item">8</span><span class="level-item">LLVM IRç”Ÿæˆ</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#LLVMç®€ä»‹"><span class="level-left"><span class="level-item">8.1</span><span class="level-item">LLVMç®€ä»‹</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#å¯¹LLVMçš„ç®€å•ç†è§£"><span class="level-left"><span class="level-item">8.1.1</span><span class="level-item">å¯¹LLVMçš„ç®€å•ç†è§£</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#æ“ä½œæ•°-Valueç±»"><span class="level-left"><span class="level-item">8.1.1.1</span><span class="level-item">æ“ä½œæ•° Valueç±»</span></span></a></li><li><a class="level is-mobile" href="#æ“ä½œæ•°ä½¿ç”¨è€…-Userç±»"><span class="level-left"><span class="level-item">8.1.1.2</span><span class="level-item">æ“ä½œæ•°ä½¿ç”¨è€… Userç±»</span></span></a></li><li><a class="level is-mobile" href="#Userç±»ç»§æ‰¿Valueç±»"><span class="level-left"><span class="level-item">8.1.1.3</span><span class="level-item">Userç±»ç»§æ‰¿Valueç±»</span></span></a></li><li><a class="level is-mobile" href="#æŒ‡ä»¤-Instructionç±»"><span class="level-left"><span class="level-item">8.1.1.4</span><span class="level-item">æŒ‡ä»¤ Instructionç±»</span></span></a></li><li><a class="level is-mobile" href="#ç‰¹æ®Šçš„Valueç±»ï¼šFunctionå’ŒBasicBlockç±»"><span class="level-left"><span class="level-item">8.1.1.5</span><span class="level-item">ç‰¹æ®Šçš„Valueç±»ï¼šFunctionå’ŒBasicBlockç±»</span></span></a></li><li><a class="level is-mobile" href="#æ ¹èŠ‚ç‚¹ï¼šModuleç±»"><span class="level-left"><span class="level-item">8.1.1.6</span><span class="level-item">æ ¹èŠ‚ç‚¹ï¼šModuleç±»</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#å†…å­˜-SSA"><span class="level-left"><span class="level-item">8.2</span><span class="level-item">å†…å­˜ SSA</span></span></a></li><li><a class="level is-mobile" href="#ç¬¦å·è¡¨"><span class="level-left"><span class="level-item">8.3</span><span class="level-item">ç¬¦å·è¡¨</span></span></a></li><li><a class="level is-mobile" href="#ç¬¦å·çš„å®šä¹‰"><span class="level-left"><span class="level-item">8.4</span><span class="level-item">ç¬¦å·çš„å®šä¹‰</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#å…¨å±€å•å¸¸é‡"><span class="level-left"><span class="level-item">8.4.1</span><span class="level-item">å…¨å±€å•å¸¸é‡</span></span></a></li><li><a class="level is-mobile" href="#å±€éƒ¨å•å¸¸é‡"><span class="level-left"><span class="level-item">8.4.2</span><span class="level-item">å±€éƒ¨å•å¸¸é‡</span></span></a></li><li><a class="level is-mobile" href="#å…¨å±€å¸¸é‡æ•°ç»„"><span class="level-left"><span class="level-item">8.4.3</span><span class="level-item">å…¨å±€å¸¸é‡æ•°ç»„</span></span></a></li><li><a class="level is-mobile" href="#å±€éƒ¨å¸¸é‡æ•°ç»„"><span class="level-left"><span class="level-item">8.4.4</span><span class="level-item">å±€éƒ¨å¸¸é‡æ•°ç»„</span></span></a></li><li><a class="level is-mobile" href="#å…¨å±€å•å˜é‡"><span class="level-left"><span class="level-item">8.4.5</span><span class="level-item">å…¨å±€å•å˜é‡</span></span></a></li><li><a class="level is-mobile" href="#å…¨å±€å˜é‡æ•°ç»„"><span class="level-left"><span class="level-item">8.4.6</span><span class="level-item">å…¨å±€å˜é‡æ•°ç»„</span></span></a></li><li><a class="level is-mobile" href="#å±€éƒ¨å•å˜é‡"><span class="level-left"><span class="level-item">8.4.7</span><span class="level-item">å±€éƒ¨å•å˜é‡</span></span></a></li><li><a class="level is-mobile" href="#å±€éƒ¨å˜é‡æ•°ç»„"><span class="level-left"><span class="level-item">8.4.8</span><span class="level-item">å±€éƒ¨å˜é‡æ•°ç»„</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ç¬¦å·çš„ä½¿ç”¨"><span class="level-left"><span class="level-item">8.5</span><span class="level-item">ç¬¦å·çš„ä½¿ç”¨</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#å†™å˜é‡"><span class="level-left"><span class="level-item">8.5.1</span><span class="level-item">å†™å˜é‡</span></span></a></li><li><a class="level is-mobile" href="#è¯»å˜é‡"><span class="level-left"><span class="level-item">8.5.2</span><span class="level-item">è¯»å˜é‡</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#è¯»å˜é‡ç”¨äºè¡¨è¾¾å¼"><span class="level-left"><span class="level-item">8.5.2.1</span><span class="level-item">è¯»å˜é‡ç”¨äºè¡¨è¾¾å¼</span></span></a></li><li><a class="level is-mobile" href="#è¯»å˜é‡ç”¨äºå®å‚"><span class="level-left"><span class="level-item">8.5.2.2</span><span class="level-item">è¯»å˜é‡ç”¨äºå®å‚</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#çŸ­è·¯æ±‚å€¼"><span class="level-left"><span class="level-item">8.6</span><span class="level-item">çŸ­è·¯æ±‚å€¼</span></span></a></li><li><a class="level is-mobile" href="#æ§åˆ¶ç»“æ„"><span class="level-left"><span class="level-item">8.7</span><span class="level-item">æ§åˆ¶ç»“æ„</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#åˆ†æ”¯"><span class="level-left"><span class="level-item">8.7.1</span><span class="level-item">åˆ†æ”¯</span></span></a></li><li><a class="level is-mobile" href="#å¾ªç¯"><span class="level-left"><span class="level-item">8.7.2</span><span class="level-item">å¾ªç¯</span></span></a></li><li><a class="level is-mobile" href="#Break-Continue-Return"><span class="level-left"><span class="level-item">8.7.3</span><span class="level-item">Break &amp; Continue &amp; Return</span></span></a></li></ul></li><li><a class="level is-mobile" href="#å…·ä½“æ¶æ„è®¾è®¡"><span class="level-left"><span class="level-item">8.8</span><span class="level-item">å…·ä½“æ¶æ„è®¾è®¡</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#IrBuilderç±»ï¼šæŒ‡ä»¤çš„å·¥å‚"><span class="level-left"><span class="level-item">8.8.1</span><span class="level-item">IrBuilderç±»ï¼šæŒ‡ä»¤çš„å·¥å‚</span></span></a></li><li><a class="level is-mobile" href="#IrFactoryï¼šé€’å½’ä¸‹é™çš„ä¸Šä¸‹æ–‡ä¿¡æ¯"><span class="level-left"><span class="level-item">8.8.2</span><span class="level-item">IrFactoryï¼šé€’å½’ä¸‹é™çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span></a></li><li><a class="level is-mobile" href="#llvmå…ƒç´ "><span class="level-left"><span class="level-item">8.8.3</span><span class="level-item">llvmå…ƒç´ </span></span></a></li><li><a class="level is-mobile" href="#å†è®®-SSA"><span class="level-left"><span class="level-item">8.8.4</span><span class="level-item">å†è®® SSA</span></span></a></li><li><a class="level is-mobile" href="#ConstExpçš„å¤„ç†ä¸â€œåé—¨â€å¸¸é‡ä¼ æ’­"><span class="level-left"><span class="level-item">8.8.5</span><span class="level-item">ConstExpçš„å¤„ç†ä¸â€œåé—¨â€å¸¸é‡ä¼ æ’­</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#Mips-ç”Ÿæˆ"><span class="level-left"><span class="level-item">9</span><span class="level-item">Mips ç”Ÿæˆ</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#MipsBuilderï¼šæŒ‡ä»¤çš„å·¥å‚ç±»"><span class="level-left"><span class="level-item">9.1</span><span class="level-item">MipsBuilderï¼šæŒ‡ä»¤çš„å·¥å‚ç±»</span></span></a></li><li><a class="level is-mobile" href="#MipsFactoryï¼šè®°å½•-llvmæˆåˆ†åˆ°-mipsæˆåˆ†çš„æ˜ å°„"><span class="level-left"><span class="level-item">9.2</span><span class="level-item">MipsFactoryï¼šè®°å½• llvmæˆåˆ†åˆ° mipsæˆåˆ†çš„æ˜ å°„</span></span></a></li><li><a class="level is-mobile" href="#llvmçš„æˆåˆ†ç±»ï¼šmipsç”Ÿæˆçš„ä¸»è¦åœºæ‰€"><span class="level-left"><span class="level-item">9.3</span><span class="level-item">llvmçš„æˆåˆ†ç±»ï¼šmipsç”Ÿæˆçš„ä¸»è¦åœºæ‰€</span></span></a></li><li><a class="level is-mobile" href="#backend-instructions-MipsæŒ‡ä»¤ç±»"><span class="level-left"><span class="level-item">9.4</span><span class="level-item">backend/instructions: MipsæŒ‡ä»¤ç±»</span></span></a></li><li><a class="level is-mobile" href="#backend-operands-æ“ä½œæ•°ç±»"><span class="level-left"><span class="level-item">9.5</span><span class="level-item">backend/operands: æ“ä½œæ•°ç±»</span></span></a></li><li><a class="level is-mobile" href="#æ„å»ºæµç¨‹"><span class="level-left"><span class="level-item">9.6</span><span class="level-item">æ„å»ºæµç¨‹</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#æ„å»º-dataæ®µ"><span class="level-left"><span class="level-item">9.6.1</span><span class="level-item">æ„å»º.dataæ®µ</span></span></a></li><li><a class="level is-mobile" href="#ä¸ºæ‰€æœ‰Blockå’ŒFunctionåˆ›å»ºMipså¯¹è±¡ï¼Œå¹¶æ˜ å°„åˆ°llvmçš„ç›¸åº”å¯¹è±¡"><span class="level-left"><span class="level-item">9.6.2</span><span class="level-item">ä¸ºæ‰€æœ‰Blockå’ŒFunctionåˆ›å»ºMipså¯¹è±¡ï¼Œå¹¶æ˜ å°„åˆ°llvmçš„ç›¸åº”å¯¹è±¡</span></span></a></li><li><a class="level is-mobile" href="#éå†-llvmçš„æ ‘å½¢ç»“æ„"><span class="level-left"><span class="level-item">9.6.3</span><span class="level-item">éå† llvmçš„æ ‘å½¢ç»“æ„</span></span></a></li></ul></li><li><a class="level is-mobile" href="#å…·ä½“æ„å»ºéš¾ç‚¹"><span class="level-left"><span class="level-item">9.7</span><span class="level-item">å…·ä½“æ„å»ºéš¾ç‚¹</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Callï¼šå‚æ•°ä¼ é€’"><span class="level-left"><span class="level-item">9.7.1</span><span class="level-item">Callï¼šå‚æ•°ä¼ é€’</span></span></a></li><li><a class="level is-mobile" href="#MipsFunctionï¼šä¿å­˜ç°åœº"><span class="level-left"><span class="level-item">9.7.2</span><span class="level-item">MipsFunctionï¼šä¿å­˜ç°åœº</span></span></a></li><li><a class="level is-mobile" href="#MipsRetï¼šæ¢å¤ç°åœº"><span class="level-left"><span class="level-item">9.7.3</span><span class="level-item">MipsRetï¼šæ¢å¤ç°åœº</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#ä»£ç ä¼˜åŒ–"><span class="level-left"><span class="level-item">10</span><span class="level-item">ä»£ç ä¼˜åŒ–</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#æ€»è®º"><span class="level-left"><span class="level-item">10.1</span><span class="level-item">æ€»è®º</span></span></a></li><li><a class="level is-mobile" href="#æ§åˆ¶æµå›¾æ„å»º"><span class="level-left"><span class="level-item">10.2</span><span class="level-item">æ§åˆ¶æµå›¾æ„å»º</span></span></a></li><li><a class="level is-mobile" href="#æ”¯é…åˆ†æ"><span class="level-left"><span class="level-item">10.3</span><span class="level-item">æ”¯é…åˆ†æ</span></span></a></li><li><a class="level is-mobile" href="#å‡½æ•°è°ƒç”¨åˆ†æ"><span class="level-left"><span class="level-item">10.4</span><span class="level-item">å‡½æ•°è°ƒç”¨åˆ†æ</span></span></a></li><li><a class="level is-mobile" href="#å‰¯ä½œç”¨åˆ†æ"><span class="level-left"><span class="level-item">10.5</span><span class="level-item">å‰¯ä½œç”¨åˆ†æ</span></span></a></li><li><a class="level is-mobile" href="#Mem2Reg"><span class="level-left"><span class="level-item">10.6</span><span class="level-item">Mem2Reg</span></span></a></li><li><a class="level is-mobile" href="#ç®€å•çš„è¿ç®—å¼ºåº¦å‰Šå¼±"><span class="level-left"><span class="level-item">10.7</span><span class="level-item">ç®€å•çš„è¿ç®—å¼ºåº¦å‰Šå¼±</span></span></a></li><li><a class="level is-mobile" href="#Aggressive-Dead-Code-Emit"><span class="level-left"><span class="level-item">10.8</span><span class="level-item">Aggressive Dead Code Emit</span></span></a></li><li><a class="level is-mobile" href="#å…¨å±€å˜é‡å±€éƒ¨åŒ–"><span class="level-left"><span class="level-item">10.9</span><span class="level-item">å…¨å±€å˜é‡å±€éƒ¨åŒ–</span></span></a></li><li><a class="level is-mobile" href="#ä¹˜é™¤æ³•ä¼˜åŒ–"><span class="level-left"><span class="level-item">10.10</span><span class="level-item">ä¹˜é™¤æ³•ä¼˜åŒ–</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ä¹˜æ³•ä¼˜åŒ–"><span class="level-left"><span class="level-item">10.10.1</span><span class="level-item">ä¹˜æ³•ä¼˜åŒ–</span></span></a></li><li><a class="level is-mobile" href="#é™¤æ³•ä¼˜åŒ–"><span class="level-left"><span class="level-item">10.10.2</span><span class="level-item">é™¤æ³•ä¼˜åŒ–</span></span></a></li></ul></li><li><a class="level is-mobile" href="#å›¾ç€è‰²å¯„å­˜å™¨åˆ†é…"><span class="level-left"><span class="level-item">10.11</span><span class="level-item">å›¾ç€è‰²å¯„å­˜å™¨åˆ†é…</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#æ„é€ å†²çªå›¾-build"><span class="level-left"><span class="level-item">10.11.1</span><span class="level-item">æ„é€ å†²çªå›¾(build)</span></span></a></li><li><a class="level is-mobile" href="#ç®€åŒ–ï¼ˆsimplifyï¼‰"><span class="level-left"><span class="level-item">10.11.2</span><span class="level-item">ç®€åŒ–ï¼ˆsimplifyï¼‰</span></span></a></li><li><a class="level is-mobile" href="#åˆå¹¶ï¼ˆcoalesceï¼‰"><span class="level-left"><span class="level-item">10.11.3</span><span class="level-item">åˆå¹¶ï¼ˆcoalesceï¼‰</span></span></a></li><li><a class="level is-mobile" href="#å†»ç»“ï¼ˆfreezeï¼‰"><span class="level-left"><span class="level-item">10.11.4</span><span class="level-item">å†»ç»“ï¼ˆfreezeï¼‰</span></span></a></li><li><a class="level is-mobile" href="#æº¢å‡ºï¼ˆspillï¼‰"><span class="level-left"><span class="level-item">10.11.5</span><span class="level-item">æº¢å‡ºï¼ˆspillï¼‰</span></span></a></li><li><a class="level is-mobile" href="#é€‰æ‹©ï¼ˆselectï¼‰"><span class="level-left"><span class="level-item">10.11.6</span><span class="level-item">é€‰æ‹©ï¼ˆselectï¼‰</span></span></a></li><li><a class="level is-mobile" href="#é‡æ–°å¼€å§‹-restart"><span class="level-left"><span class="level-item">10.11.7</span><span class="level-item">é‡æ–°å¼€å§‹(restart)</span></span></a></li></ul></li><li><a class="level is-mobile" href="#çª¥å­”ä¼˜åŒ–"><span class="level-left"><span class="level-item">10.12</span><span class="level-item">çª¥å­”ä¼˜åŒ–</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#å¤„ç†æ— æ„ä¹‰çš„åŠ å‡æ³•"><span class="level-left"><span class="level-item">10.12.1</span><span class="level-item">å¤„ç†æ— æ„ä¹‰çš„åŠ å‡æ³•</span></span></a></li><li><a class="level is-mobile" href="#å¤„ç†æ— æ„ä¹‰çš„mov"><span class="level-left"><span class="level-item">10.12.2</span><span class="level-item">å¤„ç†æ— æ„ä¹‰çš„mov</span></span></a></li><li><a class="level is-mobile" href="#å¤„ç†å¯¹åŒä¸€ä¸ªdstçš„è¿ç»­mov"><span class="level-left"><span class="level-item">10.12.3</span><span class="level-item">å¤„ç†å¯¹åŒä¸€ä¸ªdstçš„è¿ç»­mov</span></span></a></li><li><a class="level is-mobile" href="#å¤„ç†å‘ç›¸é‚»å—æˆ–è€…æ— æ„ä¹‰å—çš„è·³è½¬"><span class="level-left"><span class="level-item">10.12.4</span><span class="level-item">å¤„ç†å‘ç›¸é‚»å—æˆ–è€…æ— æ„ä¹‰å—çš„è·³è½¬</span></span></a></li><li><a class="level is-mobile" href="#å¤„ç†å‘åŒä¸€ä¸ªåœ°å€çš„å­˜å‚¨-åŠ è½½çš„store-loadå¯¹"><span class="level-left"><span class="level-item">10.12.5</span><span class="level-item">å¤„ç†å‘åŒä¸€ä¸ªåœ°å€çš„å­˜å‚¨+åŠ è½½çš„store+loadå¯¹</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">æœ€æ–°æ–‡ç« </h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-08-14T15:46:07.000Z">2025-08-14</time></p><p class="title"><a href="/2025/08/14/database/">å­¦æµ·ä¼´èˆªâ€”â€”æ•™è¾…å¹³å°ç³»ç»Ÿè®¾è®¡æ–‡æ¡£</a></p><p class="categories"><a href="/categories/%E5%A4%A7%E4%B8%89%E4%B8%8A%E8%AF%BE%E4%B8%8A/">å¤§ä¸‰ä¸Šè¯¾ä¸Š</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-08-14T13:06:06.000Z">2025-08-14</time></p><p class="title"><a href="/2025/08/14/compiler/">RooKie_Z Compilerç¼–è¯‘å™¨è®¾è®¡æ–‡æ¡£</a></p><p class="categories"><a href="/categories/%E5%A4%A7%E4%B8%89%E4%B8%8A%E8%AF%BE%E4%B8%8A/">å¤§ä¸‰ä¸Šè¯¾ä¸Š</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-08-14T12:37:15.000Z">2025-08-14</time></p><p class="title"><a href="/2025/08/14/challenge-shell/">RooKie_Z challenge-shellå®ç°æŠ¥å‘Š</a></p><p class="categories"><a href="/categories/%E5%A4%A7%E4%BA%8C%E4%B8%8B%E8%AF%BE%E4%B8%8A/">å¤§äºŒä¸‹è¯¾ä¸Š</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-08-13T09:15:00.000Z">2025-08-13</time></p><p class="title"><a href="/2025/08/13/OO-4/">OOç¬¬å››å•å…ƒæ€»ç»“æš¨è¯¾ç¨‹æ€»ç»“</a></p><p class="categories"><a href="/categories/%E5%A4%A7%E4%BA%8C%E4%B8%8B%E8%AF%BE%E4%B8%8A/">å¤§äºŒä¸‹è¯¾ä¸Š</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-08-13T09:13:00.000Z">2025-08-13</time></p><p class="title"><a href="/2025/08/13/OO-3/">OOç¬¬ä¸‰å•å…ƒæ€»ç»“</a></p><p class="categories"><a href="/categories/%E5%A4%A7%E4%BA%8C%E4%B8%8B%E8%AF%BE%E4%B8%8A/">å¤§äºŒä¸‹è¯¾ä¸Š</a></p></div></article></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">åˆ†ç±»</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Hexo/"><span class="level-start"><span class="level-item">Hexo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%A4%A7%E4%B8%89%E4%B8%8A%E8%AF%BE%E4%B8%8A/"><span class="level-start"><span class="level-item">å¤§ä¸‰ä¸Šè¯¾ä¸Š</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%A4%A7%E4%BA%8C%E4%B8%8B%E8%AF%BE%E4%B8%8A/"><span class="level-start"><span class="level-item">å¤§äºŒä¸‹è¯¾ä¸Š</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="RooKie_Zçš„å°çª" height="28"></a><p class="is-size-7"><span>&copy; 2025 RooKie_Z</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">Â© 2025 RooKie_Z. All rights reserved.</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/rookie-zgy1513"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="å›åˆ°é¡¶ç«¯" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "æ­¤ç½‘ç«™ä½¿ç”¨Cookieæ¥æ”¹å–„æ‚¨çš„ä½“éªŒã€‚",
          dismiss: "çŸ¥é“äº†ï¼",
          allow: "å…è®¸ä½¿ç”¨Cookie",
          deny: "æ‹’ç»",
          link: "äº†è§£æ›´å¤š",
          policy: "Cookieæ”¿ç­–",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><script src="/js/night.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ...","untitled":"(æ— æ ‡é¢˜)","posts":"æ–‡ç« ","pages":"é¡µé¢","categories":"åˆ†ç±»","tags":"æ ‡ç­¾"});
        });</script></body></html>